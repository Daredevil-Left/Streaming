<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo_nuevo.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/es.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .platform-btn img { transition: transform 0.2s ease-in-out; }
        .platform-btn:hover img { transform: scale(1.1); }
        .sidebar-text {
            display: none; /* Oculto por defecto */
            transition: opacity 0.3s ease-in-out;
            white-space: nowrap;
            opacity: 0;
        }
        #sidebar:hover .sidebar-text {
            display: inline-block; /* Mostrar en hover */
            opacity: 1;
        }
        /* Nuevo: Centrar íconos cuando el sidebar está colapsado */
        #sidebar:not(:hover) nav a, #sidebar:not(:hover) #logout-btn {
            justify-content: center;
        }
        .toast {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="flex h-screen bg-gray-100 hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="w-16 hover:w-64 bg-gray-800 text-white flex flex-col transition-all duration-300 ease-in-out overflow-hidden">
            <div class="flex items-center justify-center h-20 border-b border-gray-700">
                <img src="logo_nuevo.png" alt="Logo" class="h-10 w-10 object-contain">
            </div>
            <nav class="flex-1 px-2 py-4 space-y-2">
                <a href="#" id="nav-dashboard" class="flex items-center py-2.5 px-2 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span class="ml-4 sidebar-text">Dashboard</span>
                </a>
                <a href="#" id="nav-cuentas" class="flex items-center py-2.5 px-2 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <span class="ml-4 sidebar-text">Cuentas</span>
                </a>
                <a href="#" id="nav-ventas" class="flex items-center py-2.5 px-2 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span class="ml-4 sidebar-text">Ventas</span>
                </a>
                <a href="#" id="nav-finanzas" class="flex items-center py-2.5 px-2 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
                    <span class="ml-4 sidebar-text">Finanzas</span>
                </a>
            </nav>
            <div class="px-2 py-4">
                <button id="logout-btn" class="w-full flex items-center py-2.5 px-2 rounded-md bg-red-500 hover:bg-red-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span class="ml-4 sidebar-text">Cerrar Sesión</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-8">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-8">Dashboard</h1>
                    <!-- KPI Widgets -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-[linear-gradient(to_right,#00b09b,#1a2a27)] p-6 rounded-2xl flex items-center">
                            <div>
                                <!-- Icono Ventas Hoy (Forma Sol) -->
                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-sm font-medium text-white/75">Ventas de Hoy</h3>
                                <p id="kpi-sales-today" class="text-2xl font-black text-white" style="text-shadow: 0 0 8px rgba(0, 176, 155, 0.7);">S/0.00</p>
                            </div>
                        </div>
                        <div class="bg-[linear-gradient(to_right,#2c3e50,#000428)] p-6 rounded-2xl flex items-center">
                            <div>
                                <!-- Icono Calendario -->
                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-sm font-medium text-white/75">Ventas del Mes</h3>
                                <p id="kpi-sales-month" class="text-2xl font-black text-white" style="text-shadow: 0 0 8px rgba(44, 62, 80, 0.7);">S/312.00</p>
                            </div>
                        </div>
                        <div class="bg-[linear-gradient(to_right,#6a3093,#301934)] p-6 rounded-2xl flex items-center">
                            <div>
                                <!-- Icono Usuario -->
                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-sm font-medium text-white/75">Clientes Activos</h3>
                                <p id="kpi-active-clients" class="text-2xl font-black text-white" style="text-shadow: 0 0 8px rgba(106, 48, 147, 0.7);">47</p>
                            </div>
                        </div>
                    </div>

                    <!-- Alerts and Quick Access -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Alertas de Vencimiento</h3>
                                <div id="alerts-section" class="space-y-3">
                                    <!-- Alertas se cargarán aquí -->
                                    <p class="text-gray-500">No hay vencimientos próximos.</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Alertas de Cuentas</h3>
                                <div id="platform-account-alerts-section" class="space-y-3">
                                    <!-- Alertas de cuentas se cargarán aquí -->
                                    <p class="text-gray-500">No hay cuentas por vencer.</p>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-6 lg:col-span-1">
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Accesos Rápidos</h3>
                                <div class="flex flex-col space-y-3">
                                    <button id="quick-add-sale" class="w-full flex items-center justify-center bg-blue-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-blue-700 transition">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        Añadir Nueva Venta
                                    </button>
                                    <button id="quick-add-expense" class="w-full flex items-center justify-center bg-red-500 text-white font-semibold px-4 py-3 rounded-lg hover:bg-red-600 transition">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"></path></svg>
                                        Añadir Egreso
                                    </button>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Resumen Financiero</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center"><span class="font-medium text-green-700">Ingresos:</span><span id="summary-ingresos" class="font-bold text-lg text-green-800">S/0.00</span></div>
                                    <div class="flex justify-between items-center"><span class="font-medium text-red-700">Egresos:</span><span id="summary-egresos" class="font-bold text-lg text-red-800">S/0.00</span></div>
                                    <div class="border-t pt-3 mt-2 flex justify-between items-center"><span class="font-bold text-blue-800">Balance:</span><span id="summary-balance" class="font-bold text-xl text-blue-900">S/0.00</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cuentas View -->
                <div id="cuentas-view" class="view">
                    <h1 class="text-3xl font-bold text-gray-800 mb-8">Cuentas</h1>
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow mb-8 max-w-5xl mx-auto">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-6">Añadir Cuenta de Plataforma</h2>
                        <div id="collapsible-accounts-content" class="mt-6">
                            <form id="add-account-form" class="space-y-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2">Plataforma</label>
                                    <div id="account-platform-buttons" class="flex flex-wrap gap-2"></div>
                                    <input type="hidden" id="account-platform" name="account-platform" required>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div>
                                        <label for="account-email" class="block text-sm font-medium text-gray-600 mb-2">Correo</label>
                                        <input type="email" id="account-email" name="account-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                    </div>
                                    <div class="relative">
                                        <label for="account-password" class="block text-sm font-medium text-gray-600 mb-2">Contraseña</label>
                                        <input type="password" id="account-password" name="account-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                        <button type="button" class="absolute inset-y-0 right-0 top-6 flex items-center px-3 text-gray-500" onclick="togglePasswordVisibility('account-password', this)">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                        </button>
                                    </div>
                                    <div>
                                        <label for="enlace" class="block text-sm font-medium text-gray-600 mb-2">Enlace (Opcional)</label>
                                        <input type="text" id="enlace" name="enlace" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label for="fechaPago" class="block text-sm font-medium text-gray-600 mb-2">Fecha de pago</label>
                                        <input type="date" id="fechaPago" name="fechaPago" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                </div>
                                <div class="text-right">
                                    <button type="submit" class="bg-blue-600 w-full md:w-auto text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 transition">Añadir Cuenta</button>
                                </div>
                            </form>
                            <div id="contenedor-cuentas-agrupadas"></div>
                        </div>
                    </div>
                </div>

                <!-- Ventas View -->
                <div id="ventas-view" class="view hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-8">Ventas</h1>
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg mb-8 max-w-5xl mx-auto">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-6">Añadir Nueva Venta</h2>
                        <form id="add-sale-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            <div><label for="cliente" class="block text-sm font-medium text-gray-600 mb-2">Nombre del Cliente</label><input type="text" id="cliente" name="cliente" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            <div><label for="plataforma" class="block text-sm font-medium text-gray-600 mb-2">Plataforma</label><select id="plataforma" name="plataforma" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option>Netflix</option> <option>Spotify</option> <option>Disney+</option> <option>HBO Max</option> <option>Amazon Prime Video</option> <option>YouTube Premium</option> <option>Apple Music</option> <option>Apple TV+</option> <option>Crunchyroll</option> <option>Canva</option> <option>IPTV Premium</option> <option>Vix+</option> <option>Paramount+</option> <option>Otro</option></select></div>
                            <div id="otro-plataforma-container" class="hidden"><label for="otro-plataforma" class="block text-sm font-medium text-gray-600 mb-2">Especificar Plataforma</label><input type="text" id="otro-plataforma" name="otro-plataforma" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                            <div><label for="precio" class="block text-sm font-medium text-gray-600 mb-2">Precio Pagado (S/)</label><input type="number" id="precio" name="precio" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            <div><label for="inicioPlan" class="block text-sm font-medium text-gray-600 mb-2">Inicio del Plan</label><input type="date" id="inicioPlan" name="inicioPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            <div><label for="diasPlan" class="block text-sm font-medium text-gray-600 mb-2">Nº Días</label><input type="number" id="diasPlan" name="diasPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                            <div><label for="finPlan" class="block text-sm font-medium text-gray-600 mb-2">Fin del Plan</label><input type="date" id="finPlan" name="finPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly></div>
                            <div>
                                <label for="platform-account" class="block text-sm font-medium text-gray-600 mb-2">Cuenta Madre</label>
                                <select id="platform-account" name="platform-account" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="">Sin cuenta / Ingresar manualmente</option>
                                </select>
                            </div>
                             <div>
                                <label for="profile-select" class="block text-sm font-medium text-gray-600 mb-2">Perfil</label>
                                <select id="profile-select" name="profile-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-200" disabled required>
                                    <option value="">Selecciona una cuenta madre primero</option>
                                </select>
                            </div>
                            <div class="manual-credentials">
                                <label for="correo" class="block text-sm font-medium text-gray-600 mb-2">Correo</label>
                                <input type="email" id="correo" name="correo" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="manual-credentials relative">
                                <label for="contrasena" class="block text-sm font-medium text-gray-600 mb-2">Contraseña</label>
                                <input type="password" id="contrasena" name="contrasena" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <button type="button" class="absolute inset-y-0 right-0 top-6 flex items-center px-3 text-gray-500" onclick="togglePasswordVisibility('contrasena', this)">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                </button>
                            </div>
                            <div><label for="pin" class="block text-sm font-medium text-gray-600 mb-2">PIN</label><input type="text" id="pin" name="pin" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                            <div><label for="notas" class="block text-sm font-medium text-gray-600 mb-2">Notas Adicionales</label><input type="text" id="notas" name="notas" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                            <div>
                                <label for="metodoPago" class="block text-sm font-medium text-gray-600 mb-2">Método de Pago</label>
                                <select id="metodoPago" name="metodoPago" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" required>
                                    <option value="" disabled selected>Seleccione un método</option>
                                    <option value="BCP">BCP</option>
                                    <option value="Falta pagar">Falta pagar</option>
                                    <option value="Gratis">Gratis</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 lg:col-span-3 xl:col-span-4 text-right self-end"><button type="submit" class="bg-indigo-600 w-full md:w-auto text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition-transform transform hover:scale-105">Guardar Venta</button></div>
                        </form>
                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-lg mb-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="relative flex-grow w-full md:col-span-1"><input type="text" id="search-input" placeholder="Buscar por cliente, plataforma o correo..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"><svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div>
                            <div>
                                <select id="account-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="">Filtrar por cuenta...</option>
                                </select>
                            </div>
                            <div>
                                <select id="status-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="">Filtrar por estado...</option>
                                    <option value="Activo">Activo</option>
                                    <option value="Próximo a Vencer">Próximo a Vencer</option>
                                    <option value="Vence hoy">Vence hoy</option>
                                    <option value="Vencido">Vencido</option>
                                </select>
                            </div>
                        </div>
                        <div id="platform-filters" class="flex flex-wrap justify-center gap-3 sm:gap-4"></div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4">
                        <div class="hidden md:grid grid-cols-8 gap-4 font-semibold text-gray-600 border-b pb-3 mb-3 text-sm">
                            <div class="col-span-2">Cliente</div>
                            <div>Plataforma</div>
                            <div>Vencimiento</div>
                            <div>Estado</div>
                            <div>Precio</div>
                            <div>Método de Pago</div>
                            <div class="text-right">Acciones</div>
                        </div>
                        <div id="sales-list" class="space-y-2"></div>
                    </div>
                    <div id="loading-state" class="text-center py-10"><p class="text-gray-500">Cargando ventas...</p></div>
                    <div id="empty-state" class="hidden text-center py-20 bg-white rounded-2xl shadow-lg"><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg><h3 class="mt-2 text-xl font-medium text-gray-900">No hay ventas registradas</h3><p class="mt-1 text-sm text-gray-500">Comienza añadiendo una nueva venta.</p></div>
                </div>

                <!-- Finanzas View -->
                <div id="finanzas-view" class="view hidden max-w-7xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-800 mb-8">Finanzas</h1>
                    <!-- Financial Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Total Ingresos -->
                        <div id="total-ingresos-card" class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 rounded-2xl shadow-lg flex items-center">
                            <div id="total-ingresos-icon-bg" class="p-4 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-white">
                                    <path fill-rule="evenodd" d="M15.22 6.268a.75.75 0 0 1 .968-.432l5.942 2.28a.75.75 0 0 1 .431.97l-2.28 5.94a.75.75 0 1 1-1.4-.537l1.63-4.251-1.086.484a11.2 11.2 0 0 0-5.45 5.173.75.75 0 0 1-1.199.19L9 12.312l-6.22 6.22a.75.75 0 0 1-1.06-1.06l6.75-6.75a.75.75 0 0 1 1.06 0l3.606 3.606a12.7 12.7 0 0 1 5.68-4.974l1.086-.483-4.251-1.632a.75.75 0 0 1-.432-.97Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 id="total-ingresos-text" class="text-sm font-medium text-white">Ingresos Totales</h3>
                                <p id="total-ingresos" class="text-2xl font-bold text-white">S/0.00</p>
                            </div>
                        </div>
                        <!-- Total Egresos -->
                        <div id="total-egresos-card" class="bg-gradient-to-r from-red-500 to-orange-500 p-6 rounded-2xl shadow-lg flex items-center">
                            <div id="total-egresos-icon-bg" class="p-4 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-white">
                                    <path fill-rule="evenodd" d="M1.72 5.47a.75.75 0 0 1 1.06 0L9 11.69l3.756-3.756a.75.75 0 0 1 .984-.067 12.693 12.693 0 0 1 4.575 6.832l.308 1.149 2.277-3.943a.75.75 0 1 1 1.3.75l-3.182 5.51a.75.75 0 0 1-1.025.275l-5.511-3.182a.75.75 0 0 1 .75-1.3l3.943 2.277-.308-1.149a11.194 11.194 0 0 0-3.528-5.617l-3.81 3.81a.75.75 0 0 1-1.06 0L1.72 6.53a.75.75 0 0 1 0-1.061Z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 id="total-egresos-text" class="text-sm font-medium text-white">Egresos Totales</h3>
                                <p id="total-egresos" class="text-2xl font-bold text-white">S/0.00</p>
                            </div>
                        </div>
                        <!-- Balance General -->
                        <div id="balance-total-card" class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6 rounded-2xl shadow-lg flex items-center">
                            <div id="balance-total-icon-bg" class="p-4 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-white">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 id="balance-total-text" class="text-sm font-medium text-white">Balance General</h3>
                                <p id="balance-total" class="text-2xl font-bold text-white">S/0.00</p>
                            </div>
                        </div>
                    </div>

                    <!-- Add Expense and Recent Expenses -->
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                        <!-- Add Expense Form -->
                        <div class="lg:col-span-2">
                            <div class="bg-white p-6 rounded-2xl shadow-lg h-full">
                                <h3 class="text-xl font-semibold text-gray-700 mb-6">Añadir Egreso</h3>
                                <form id="add-expense-form" class="space-y-6">
                                    <div>
                                        <label for="expense-description" class="block text-sm font-medium text-gray-600 mb-2">Descripción</label>
                                        <input type="text" id="expense-description" name="expense-description" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Ej: Pago de internet" required>
                                    </div>
                                    <div>
                                        <label for="expense-amount" class="block text-sm font-medium text-gray-600 mb-2">Monto (S/)</label>
                                        <input type="number" id="expense-amount" name="expense-amount" min="0" step="0.01" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Ej: 50.00" required>
                                    </div>
                                    <div>
                                        <label for="expense-date" class="block text-sm font-medium text-gray-600 mb-2">Fecha</label>
                                        <input type="date" id="expense-date" name="expense-date" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required>
                                    </div>
                                    <button type="submit" class="w-full bg-gradient-to-r from-red-500 to-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:from-red-600 hover:to-orange-600 transition-all duration-300 transform hover:scale-105 shadow-md">Añadir Gasto</button>
                                </form>
                            </div>
                        </div>

                        <!-- Recent Expenses List -->
                        <div id="expenses-list-container" class="lg:col-span-3">
                             <div class="bg-white p-6 rounded-2xl shadow-lg h-full">
                                <h3 class="text-xl font-semibold text-gray-700 mb-6">Últimos Egresos</h3>
                                <div id="expenses-list" class="space-y-4 pr-2 -mr-2 max-h-96 overflow-y-auto">
                                    <p class="text-gray-500">No hay egresos registrados.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 text-center">
            <h2 id="confirmation-title" class="text-2xl font-bold text-gray-800 mb-4">Confirmar Acción</h2>
            <p id="confirmation-message" class="text-gray-600 mb-8">¿Estás seguro de que quieres continuar?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-confirmation-btn" class="bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-300 transition w-full md:w-auto">
                    Cancelar
                </button>
                <button id="confirm-action-btn" class="bg-red-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-red-700 transition w-full md:w-auto">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-4xl rounded-2xl shadow-2xl p-6 transform scale-95">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-semibold text-gray-700">Editar Venta</h2><button id="close-modal" class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div>
            <form id="edit-sale-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <input type="hidden" id="edit-sale-id" name="edit-sale-id">
                <div><label for="edit-cliente" class="block text-sm font-medium text-gray-600 mb-2">Nombre del Cliente</label><input type="text" id="edit-cliente" name="edit-cliente" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                <div><label for="edit-plataforma" class="block text-sm font-medium text-gray-600 mb-2">Plataforma</label><select id="edit-plataforma" name="edit-plataforma" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option>Netflix</option><option>Spotify</option><option>Disney+</option><option>HBO Max</option><option>Amazon Prime Video</option><option>YouTube Premium</option><option>Apple Music</option><option>Apple TV+</option><option>Crunchyroll</option><option>Canva</option><option>IPTV Premium</option><option>Vix+</option><option>Paramount+</option><option>Otro</option></select></div>
                <div id="edit-otro-plataforma-container" class="hidden"><label for="edit-otro-plataforma" class="block text-sm font-medium text-gray-600 mb-2">Especificar Plataforma</label><input type="text" id="edit-otro-plataforma" name="edit-otro-plataforma" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                <div><label for="edit-precio" class="block text-sm font-medium text-gray-600 mb-2">Precio Pagado (S/)</label><input type="number" id="edit-precio" name="edit-precio" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                <div><label for="edit-inicioPlan" class="block text-sm font-medium text-gray-600 mb-2">Inicio del Plan</label><input type="date" id="edit-inicioPlan" name="edit-inicioPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                <div>
                    <label for="edit-finPlan" class="block text-sm font-medium text-gray-600 mb-2">Fin del Plan</label>
                    <input type="date" id="edit-finPlan" name="edit-finPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" required>
                </div>
                <div>
                    <label for="edit-platform-account" class="block text-sm font-medium text-gray-600 mb-2">Cuenta Madre</label>
                    <select id="edit-platform-account" name="edit-platform-account" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                        <option value="">Sin cuenta / Ingresar manualmente</option>
                    </select>
                </div>
                <div>
                    <label for="edit-profile-select" class="block text-sm font-medium text-gray-600 mb-2">Perfil</label>
                    <select id="edit-profile-select" name="edit-profile-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                        <option value="">Selecciona un perfil</option>
                    </select>
                </div>
                <div class="edit-manual-credentials">
                    <label for="edit-correo" class="block text-sm font-medium text-gray-600 mb-2">Correo</label>
                    <input type="email" id="edit-correo" name="edit-correo" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <div class="edit-manual-credentials relative">
                    <label for="edit-contrasena" class="block text-sm font-medium text-gray-600 mb-2">Contraseña</label>
                    <input type="password" id="edit-contrasena" name="edit-contrasena" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <button type="button" class="absolute inset-y-0 right-0 top-6 flex items-center px-3 text-gray-500" onclick="togglePasswordVisibility('edit-contrasena', this)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                </div>
                <div><label for="edit-pin" class="block text-sm font-medium text-gray-600 mb-2">PIN</label><input type="text" id="edit-pin" name="edit-pin" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                <div>
                    <label for="edit-metodoPago" class="block text-sm font-medium text-gray-600 mb-2">Método de Pago</label>
                    <select id="edit-metodoPago" name="edit-metodoPago" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" required>
                        <option value="BCP">BCP</option>
                        <option value="Falta pagar">Falta pagar</option>
                        <option value="Gratis">Gratis</option>
                    </select>
                </div>
                <div class="lg:col-span-1 md:col-span-1"><label for="edit-notas" class="block text-sm font-medium text-gray-600 mb-2">Notas Adicionales</label><input type="text" id="edit-notas" name="edit-notas" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                <div class="lg:col-span-3 md:col-span-2 flex justify-end gap-4 mt-4"><button type="button" id="cancel-edit" class="bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-300 transition">Cancelar</button><button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700">Guardar Cambios</button></div>
            </form>
        </div>
    </div>
    <div id="archive-delete-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-lg rounded-2xl shadow-2xl p-8 transform scale-95 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">¿Qué deseas hacer con esta venta?</h2>
            <p class="text-gray-600 mb-8">Elige una opción según si la venta se concretó o fue un error.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Archivar</h3>
                    <p class="text-sm text-gray-500 mb-6">La venta fue real y el dinero se recibió, pero la suscripción ya terminó. La venta desaparecerá de la lista principal pero se contará en el resumen financiero.</p>
                    <button id="archive-btn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition">
                        Archivar Venta
                    </button>
                </div>

                <div class="border border-red-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                    <h3 class="text-xl font-semibold text-red-700 mb-2">Eliminar Permanentemente</h3>
                    <p class="text-sm text-gray-500 mb-6">Solo si registraste esta venta por error y nunca recibiste el dinero. Se borrará para siempre y no se contará en el resumen financiero.</p>
                    <button id="delete-permanently-btn" class="w-full bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700 transition">
                        Eliminar Permanentemente
                    </button>
                </div>
            </div>

            <div class="mt-8">
                <button id="cancel-action-btn" class="text-gray-500 hover:text-gray-700 font-medium">Cancelar</button>
            </div>
        </div>
    </div>
    <!-- Edit Account Modal -->
    <div id="edit-account-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">Editar Cuenta de Plataforma</h2>
                <button id="close-edit-account-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="edit-account-form" class="space-y-6">
                <input type="hidden" id="edit-account-id">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Plataforma</label>
                    <input type="text" id="edit-account-platform" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-account-email" class="block text-sm font-medium text-gray-600 mb-2">Correo</label>
                        <input type="email" id="edit-account-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="relative">
                        <label for="edit-account-password" class="block text-sm font-medium text-gray-600 mb-2">Contraseña</label>
                        <input type="password" id="edit-account-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Dejar en blanco para no cambiar">
                        <button type="button" class="absolute inset-y-0 right-0 top-6 flex items-center px-3 text-gray-500" onclick="togglePasswordVisibility('edit-account-password', this)">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-account-enlace" class="block text-sm font-medium text-gray-600 mb-2">Enlace (Opcional)</label>
                        <input type="text" id="edit-account-enlace" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="edit-account-fechaPago" class="block text-sm font-medium text-gray-600 mb-2">Fecha de pago</label>
                        <input type="date" id="edit-account-fechaPago" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" id="cancel-edit-account" class="bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="renewal-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">Renovar Suscripción</h2>
            <form id="renewal-form">
                <input type="hidden" id="renewal-sale-id">
                <div class="space-y-4">
                    <div>
                        <label for="renewal-days" class="block text-sm font-medium text-gray-600 mb-2">Días a renovar</label>
                        <input type="number" id="renewal-days" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="renewal-amount" class="block text-sm font-medium text-gray-600 mb-2">Monto de renovación (S/)</label>
                        <input type="number" id="renewal-amount" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-renewal-btn" class="bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-green-700 transition">Confirmar Renovación</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Profiles Modal -->
    <div id="manage-profiles-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-700">Gestionar Perfiles</h2>
                    <p id="profiles-modal-account-email" class="text-sm text-gray-500"></p>
                </div>
                <button id="close-profiles-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="profiles-content-area">
                <!-- Profile list or creation button will be injected here by JS -->
            </div>
        </div>
    </div>

    <script>
        function togglePasswordVisibility(inputId, button) { const input = document.getElementById(inputId), icon = button.querySelector('svg'); if (input.type === "password") { input.type = "text"; icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .946-3.11 3.563-5.522 6.837-6.141M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.581 10.41A7.48 7.48 0 0119.542 12c-1.274 4.057-5.064 7-9.542 7a10.046 10.046 0 01-3.132-.475M2.458 12c.946-3.11 3.563-5.522 6.837-6.141m1.581 2.318A4.5 4.5 0 0115 12a4.5 4.5 0 01-1.07 2.828M5 5l14 14" />`; } else { input.type = "password"; icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />`; } }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        const firebaseConfig = { apiKey: "AIzaSyCaYzhFY6keITDiN2Dn7kyEAnGPDt0hu2A", authDomain: "streaming-d0fac.firebaseapp.com", projectId: "streaming-d0fac", storageBucket: "streaming-d0fac.firebasestorage.app", messagingSenderId: "1017661259961", appId: "1:1017661259961:web:9303ad97c753fe95379b68" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        function startApp() {
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('logout-btn').addEventListener('click', () => { signOut(auth).catch((error) => console.error("Error al cerrar sesión", error)); });

            dayjs.extend(dayjs_plugin_relativeTime);
            dayjs.locale('es');
            const platformStyles = {
                'Netflix': { color: 'text-red-600', bg: '#E50914' },
                'Spotify': { color: 'text-green-500', bg: '#1DB954' },
                'Disney+': { color: 'text-blue-900', bg: '#01153E' },
                'HBO Max': { color: 'text-purple-600', bg: '#8A2BE2' },
                'Amazon Prime Video': { color: 'text-blue-400', bg: '#00A8E1' },
                'YouTube Premium': { color: 'text-red-500', bg: '#FF0000' },
                'Apple Music': { color: 'text-pink-500', bg: '#FA243C' },
                'Apple TV+': { color: 'text-gray-800', bg: '#000000' },
                'Crunchyroll': { color: 'text-orange-500', bg: '#F47521' },
                'Canva': { color: 'text-purple-500', bg: '#8D44AD' },
                'IPTV Premium': { color: 'text-teal-500', bg: '#00AEEF' },
                'Vix+': { color: 'text-yellow-400', bg: '#F8C100' },
                'Paramount+': { color: 'text-blue-800', bg: '#0064FF' },
                'Otro': { color: 'text-gray-500', bg: '#6B7280' }
            };
            let allSales = [], allExpenses = [], allPlatformAccounts = [], activePlatformFilter = 'Todos', currentSearchTerm = '', activeAccountFilter = '', activeStatusFilter = '';
            const selectors = {
                addSaleForm: document.getElementById('add-sale-form'),
                salesList: document.getElementById('sales-list'),
                searchInput: document.getElementById('search-input'),
                loadingState: document.getElementById('loading-state'),
                emptyState: document.getElementById('empty-state'),
                editModal: document.getElementById('edit-modal'),
                editForm: document.getElementById('edit-sale-form'),
                closeModalBtn: document.getElementById('close-modal'),
                cancelEditBtn: document.getElementById('cancel-edit'),
                plataformaSelect: document.getElementById('plataforma'),
                otroPlataformaContainer: document.getElementById('otro-plataforma-container'),
                otroPlataformaInput: document.getElementById('otro-plataforma'),
                editPlataformaSelect: document.getElementById('edit-plataforma'),
                editOtroPlataformaContainer: document.getElementById('edit-otro-plataforma-container'),
                editOtroPlataformaInput: document.getElementById('edit-otro-plataforma'),
                platformFilters: document.getElementById('platform-filters'),
                totalIngresos: document.getElementById('total-ingresos'),
                totalEgresos: document.getElementById('total-egresos'),
                balanceTotal: document.getElementById('balance-total'),
                addExpenseForm: document.getElementById('add-expense-form'),
                expensesList: document.getElementById('expenses-list'),
                addAccountForm: document.getElementById('add-account-form'),
                accountsList: document.getElementById('contenedor-cuentas-agrupadas'),
                platformAccountSelect: document.getElementById('platform-account'),
                editPlatformAccountSelect: document.getElementById('edit-platform-account'),
                accountFilter: document.getElementById('account-filter'),
                statusFilter: document.getElementById('status-filter'),
                profileSelect: document.getElementById('profile-select'),
                editProfileSelect: document.getElementById('edit-profile-select'),
                accountPlatformButtons: document.getElementById('account-platform-buttons'),
                editAccountModal: document.getElementById('edit-account-modal'),
                editAccountForm: document.getElementById('edit-account-form'),
                closeEditAccountModalBtn: document.getElementById('close-edit-account-modal'),
                cancelEditAccountBtn: document.getElementById('cancel-edit-account'),
                // Dashboard selectors
                kpiSalesToday: document.getElementById('kpi-sales-today'),
                kpiSalesMonth: document.getElementById('kpi-sales-month'),
                kpiActiveClients: document.getElementById('kpi-active-clients'),
                alertsSection: document.getElementById('alerts-section'),
                platformAccountAlertsSection: document.getElementById('platform-account-alerts-section'),
                summaryIngresos: document.getElementById('summary-ingresos'),
                summaryEgresos: document.getElementById('summary-egresos'),
                summaryBalance: document.getElementById('summary-balance'),
                 // Profiles Modal Selectors
                manageProfilesModal: document.getElementById('manage-profiles-modal'),
                closeProfilesModalBtn: document.getElementById('close-profiles-modal'),
                profilesContentArea: document.getElementById('profiles-content-area'),
                profilesModalAccountEmail: document.getElementById('profiles-modal-account-email'),
            };
            const getSaleStatus = (finPlan) => {
                if (dayjs().isAfter(dayjs(finPlan).endOf('day'))) {
                    return 'Vencido';
                }

                const today = dayjs().startOf('day');
                const expirationDate = dayjs(finPlan).startOf('day');
                const diffDays = expirationDate.diff(today, 'day');

                if (diffDays === 0) return 'Vence hoy';
                if (diffDays <= 7) return 'Próximo a Vencer';
                return 'Activo';
            };
            const formatCurrency = (amount) => `S/${(amount||0).toFixed(2)}`;
            const getPlatformHtml = (platformName) => { const style=platformStyles[platformName]||platformStyles['Otro']; return `<span class="font-bold ${style.color}">${platformName}</span>`};
            const getMetodoPagoBadge = (metodo) => {
                const styles = {
                    'BCP': 'bg-orange-400 text-white',
                    'Falta pagar': 'bg-red-500 text-white',
                    'Gratis': 'bg-green-500 text-white',
                };
                const style = styles[metodo] || 'bg-gray-400 text-white';
                return `<span class="px-2 py-1 text-xs font-semibold rounded-full ${style}">${metodo}</span>`;
            };
            const handlePlatformChange = (select, container, input) => { if (select.value==='Otro') { container.classList.remove('hidden'); input.required = true; } else { container.classList.add('hidden'); input.required = false; input.value = ''; }};
            const openModal = () => { selectors.editModal.classList.remove('hidden'); setTimeout(() => { selectors.editModal.classList.remove('opacity-0'); selectors.editModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10); };
            const closeModal = () => { selectors.editModal.classList.add('opacity-0'); selectors.editModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => selectors.editModal.classList.add('hidden'), 300); };
            const openProfilesModal = () => { selectors.manageProfilesModal.classList.remove('hidden'); setTimeout(() => { selectors.manageProfilesModal.classList.remove('opacity-0'); selectors.manageProfilesModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10); };
            const closeProfilesModal = () => { selectors.manageProfilesModal.classList.add('opacity-0'); selectors.manageProfilesModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => selectors.manageProfilesModal.classList.add('hidden'), 300); };
            const showConfirmationModal = (title, message, onConfirm) => {
                const modal = document.getElementById('confirmation-modal');
                document.getElementById('confirmation-title').textContent = title;
                document.getElementById('confirmation-message').textContent = message;

                const confirmBtn = document.getElementById('confirm-action-btn');
                const cancelBtn = document.getElementById('cancel-confirmation-btn');

                const confirmHandler = () => {
                    onConfirm();
                    hideConfirmationModal();
                };

                const cancelHandler = () => {
                    hideConfirmationModal();
                };

                confirmBtn.onclick = confirmHandler;
                cancelBtn.onclick = cancelHandler;

                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            };

            const hideConfirmationModal = () => {
                const modal = document.getElementById('confirmation-modal');
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.getElementById('confirm-action-btn').onclick = null;
                    document.getElementById('cancel-confirmation-btn').onclick = null;
                }, 300);
            };

            const showArchiveDeleteModal = (saleId) => {
                const modal = document.getElementById('archive-delete-modal');
                const archiveBtn = document.getElementById('archive-btn');
                const deleteBtn = document.getElementById('delete-permanently-btn');
                const cancelBtn = document.getElementById('cancel-action-btn');

                const archiveHandler = () => handleArchiveAction(saleId);
                const deleteHandler = () => handlePermanentDeleteAction(saleId);
                const cancelHandler = () => hideArchiveDeleteModal();

                archiveBtn.onclick = archiveHandler;
                deleteBtn.onclick = deleteHandler;
                cancelBtn.onclick = cancelHandler;

                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            };

            const hideArchiveDeleteModal = () => {
                const modal = document.getElementById('archive-delete-modal');
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    // Clean up event listeners
                    document.getElementById('archive-btn').onclick = null;
                    document.getElementById('delete-permanently-btn').onclick = null;
                    document.getElementById('cancel-action-btn').onclick = null;
                }, 300);
            };
            const updateFinancialSummary = () => { const salesIncome = allSales.reduce((sum, sale) => sum + (sale.precio || 0), 0); const totalIngresos = salesIncome; const totalEgresos = allExpenses.reduce((sum, expense) => sum + (expense.amount || 0), 0); const balance = totalIngresos - totalEgresos; selectors.totalIngresos.textContent = formatCurrency(totalIngresos); selectors.totalEgresos.textContent = formatCurrency(totalEgresos); selectors.balanceTotal.textContent = formatCurrency(balance); selectors.balanceTotal.classList.toggle('text-red-900', balance < 0); selectors.balanceTotal.classList.toggle('text-blue-900', balance >= 0); };

            const renderPlatformAccountAlerts = () => {
                const today = dayjs().startOf('day');
                const getPlatformAccountStatus = (fechaPago) => {
                    if (!fechaPago) return 'Activo';
                    if (dayjs().isAfter(dayjs(fechaPago).endOf('day'))) {
                        return 'Vencido';
                    }
                    const expirationDate = dayjs(fechaPago).startOf('day');
                    const diffDays = expirationDate.diff(today, 'day');
                    if (diffDays === 0) return 'Vence hoy';
                    if (diffDays <= 5) return 'Próximo a Vencer';
                    return 'Activo';
                };

                const alerts = allPlatformAccounts.filter(acc => {
                    const status = getPlatformAccountStatus(acc.fechaPago);
                    return status === 'Vencido' || status === 'Vence hoy' || status === 'Próximo a Vencer';
                }).sort((a, b) => new Date(a.fechaPago) - new Date(b.fechaPago));

                selectors.platformAccountAlertsSection.innerHTML = '';
                if (alerts.length > 0) {
                    selectors.platformAccountAlertsSection.className = 'space-y-3';
                    alerts.forEach(acc => {
                        const status = getPlatformAccountStatus(acc.fechaPago);
                        const borderColor = status === 'Vencido' ? 'border-red-500' : 'border-yellow-500';
                        const card = document.createElement('div');
                        card.className = `bg-gray-50 p-3 rounded-lg border-l-4 ${borderColor}`;

                        let statusText, statusColor;
                        const dueDate = dayjs(acc.fechaPago);

                        if (status === 'Vencido') {
                            statusText = 'Venció ' + dueDate.fromNow();
                            statusColor = 'text-red-600';
                        } else if (status === 'Vence hoy') {
                            statusText = 'Vence hoy';
                            statusColor = 'text-yellow-700';
                        } else {
                            statusText = 'Vence ' + dueDate.endOf('day').fromNow();
                            statusColor = 'text-yellow-600';
                        }

                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-sm text-gray-800 truncate">${acc.email}</p>
                                    <p class="text-xs text-gray-500">${getPlatformHtml(acc.platform)}</p>
                                </div>
                                <div class="text-right flex-shrink-0 ml-2">
                                    <p class="font-semibold text-xs ${statusColor}">${statusText}</p>
                                    <p class="text-xs text-gray-500">${dueDate.format('DD MMM')}</p>
                                </div>
                            </div>
                        `;
                        selectors.platformAccountAlertsSection.appendChild(card);
                    });
                } else {
                    selectors.platformAccountAlertsSection.className = 'space-y-3';
                    selectors.platformAccountAlertsSection.innerHTML = '<p class="text-gray-500 text-sm">No hay cuentas por vencer.</p>';
                }
            };

            const loadDashboardData = () => {
                const today = dayjs().startOf('day');
                const startOfMonth = dayjs().startOf('month');
                const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');

                // 1. KPI: Ventas de Hoy
                const salesToday = allSales.filter(sale => dayjs(sale.inicioPlan).isSame(today, 'day'))
                                           .reduce((sum, sale) => sum + sale.precio, 0);
                selectors.kpiSalesToday.textContent = formatCurrency(salesToday);

                // 2. KPI: Ventas del Mes
                const salesMonth = allSales.filter(sale => dayjs(sale.inicioPlan).isAfter(startOfMonth) || dayjs(sale.inicioPlan).isSame(startOfMonth))
                                         .reduce((sum, sale) => sum + sale.precio, 0);
                selectors.kpiSalesMonth.textContent = formatCurrency(salesMonth);

                // 3. KPI: Clientes Activos
                const activeClients = activeSales.length;
                selectors.kpiActiveClients.textContent = activeClients;

                // 4. Alertas de Vencimiento
                const expirationAlerts = activeSales.filter(sale => {
                    const status = getSaleStatus(sale.finPlan);
                    return status === 'Vencido' || status === 'Vence hoy' || status === 'Próximo a Vencer';
                }).filter(sale => {
                    const expirationDate = dayjs(sale.finPlan).startOf('day');
                    const diffDays = expirationDate.diff(today, 'day');
                    return diffDays <= 3; // Incluye vencidas y hasta 3 días próximos
                }).sort((a, b) => new Date(a.finPlan) - new Date(b.finPlan));

                selectors.alertsSection.innerHTML = '';
                if (expirationAlerts.length > 0) {
                    selectors.alertsSection.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                    expirationAlerts.forEach(sale => {
                        const status = getSaleStatus(sale.finPlan);
                        const borderColor = status === 'Vencido' ? 'border-red-500' : 'border-yellow-500';
                        const card = document.createElement('div');
                        card.className = `bg-white p-4 rounded-lg shadow-md border-l-4 ${borderColor} flex flex-col justify-between`;

                        let statusText, statusColor;
                        if (status === 'Vencido') {
                            statusText = 'Venció ' + dayjs(sale.finPlan).fromNow();
                            statusColor = 'text-red-600';
                        } else if (status === 'Vence hoy') {
                            statusText = 'Vence hoy';
                            statusColor = 'text-yellow-700';
                        } else {
                            statusText = 'Vence ' + dayjs(sale.finPlan).endOf('day').fromNow();
                            statusColor = 'text-yellow-600';
                        }

                        card.innerHTML = `
                            <div>
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-gray-800">${sale.cliente}</p>
                                        <p class="text-sm text-gray-500">${getPlatformHtml(sale.plataforma)}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold text-sm ${statusColor}">${statusText}</p>
                                        <p class="text-xs text-gray-500">${dayjs(sale.finPlan).format('DD [de] MMMM')}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button class="copy-alert-btn bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-semibold py-1 px-3 rounded-md transition-colors" data-sale-id="${sale.id}">
                                    Copiar Aviso
                                </button>
                            </div>
                        `;
                        selectors.alertsSection.appendChild(card);
                    });
                } else {
                    selectors.alertsSection.className = 'space-y-3';
                    selectors.alertsSection.innerHTML = '<p class="text-gray-500">No hay alertas de vencimiento.</p>';
                }

                // 5. Resumen Financiero
                const totalIngresos = allSales.reduce((sum, sale) => sum + (sale.precio || 0), 0);
                const totalEgresos = allExpenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
                const balance = totalIngresos - totalEgresos;
                selectors.summaryIngresos.textContent = formatCurrency(totalIngresos);
                selectors.summaryEgresos.textContent = formatCurrency(totalEgresos);
                selectors.summaryBalance.textContent = formatCurrency(balance);
                selectors.summaryBalance.classList.toggle('text-red-900', balance < 0);
                selectors.summaryBalance.classList.toggle('text-blue-900', balance >= 0);

                // Attach event listeners for copy buttons after rendering
                selectors.alertsSection.querySelectorAll('.copy-alert-btn').forEach(btn => {
                    btn.addEventListener('click', handleCopyAlert);
                });

                renderPlatformAccountAlerts();
            };

            const handleCopyAlert = (event) => {
                const button = event.currentTarget;
                const saleId = button.dataset.saleId;
                const sale = allSales.find(s => s.id === saleId);
                if (!sale) return;

                const status = getSaleStatus(sale.finPlan);
                let message = '';

                if (status === 'Vencido') {
                    message = `Buenas tardes 👋🏻, se le informa que su cuenta de "${sale.plataforma}" ya venció. Si desea renovar me avisa, por favor, para evitar el corte del servicio. Gracias por su preferencia 💯`;
                } else if (status === 'Vence hoy') {
                    message = `Buenas tardes 👋🏻, se le informa que su cuenta de "${sale.plataforma}" vence el día de hoy a la medianoche ‼. Si desea renovar me avisa, por favor. Gracias por su preferencia 💯`;
                } else { // Próximo a Vencer
                    const daysLeft = dayjs(sale.finPlan).endOf('day').diff(dayjs(), 'day');
                    const dayText = daysLeft === 0 ? 'mañana' : `en ${daysLeft + 1} días`;
                    message = `Buenas tardes 👋🏻, se le informa que su cuenta de "${sale.plataforma}" vence ${dayText}. Si desea renovar me avisa, por favor. Gracias por su preferencia 💯`;
                }

                navigator.clipboard.writeText(message).then(() => {
                    const originalText = button.textContent;
                    button.textContent = '¡Copiado!';
                    button.classList.add('bg-green-500', 'text-white');
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('bg-green-500', 'text-white');
                    }, 2000);
                }).catch(err => {
                    console.error('Error al copiar texto: ', err);
                    alert('No se pudo copiar el texto.');
                });
            };

            const applyFiltersAndRender = (salesToRender) => {
                let filteredSales = [...salesToRender];
                if (activePlatformFilter !== 'Todos') {
                    filteredSales = filteredSales.filter(sale => sale.plataforma === activePlatformFilter);
                }
                if (currentSearchTerm) {
                    const term = currentSearchTerm.toLowerCase();
                    filteredSales = filteredSales.filter(sale => sale.cliente.toLowerCase().includes(term) || sale.plataforma.toLowerCase().includes(term) || (sale.correo && sale.correo.toLowerCase().includes(term)));
                }
                if (activeAccountFilter) {
                    const account = allPlatformAccounts.find(a => a.id === activeAccountFilter);
                    if (account) {
                        filteredSales = filteredSales.filter(sale => sale.correo === account.email && sale.contrasena === account.password);
                    }
                }
                if (activeStatusFilter) {
                    filteredSales = filteredSales.filter(sale => getSaleStatus(sale.finPlan) === activeStatusFilter);
                }
                renderSales(filteredSales);
            };
            const renderPlatformFilters = () => {
                selectors.platformFilters.innerHTML = '';
                const platforms = ['Todos', ...Object.keys(platformStyles)];
                platforms.forEach(platform => {
                    const btn = document.createElement('button');
                    btn.dataset.platform = platform;
                    const activeClasses = 'border-indigo-500 bg-indigo-50';
                    const inactiveClasses = 'border-transparent hover:bg-gray-100';
                    btn.className = `p-2 rounded-lg border-2 transition-all duration-200 font-semibold ${activePlatformFilter === platform ? activeClasses : inactiveClasses}`;
                    if (platform === 'Todos') {
                        btn.textContent = 'Todos';
                    } else {
                        btn.innerHTML = getPlatformHtml(platform);
                    }
                    btn.addEventListener('click', () => {
                        activePlatformFilter = platform;
                        document.querySelectorAll('#platform-filters button').forEach(b => {
                            b.className = `p-2 rounded-lg border-2 transition-all duration-200 font-semibold ${inactiveClasses}`;
                        });
                        btn.className = `p-2 rounded-lg border-2 transition-all duration-200 font-semibold ${activeClasses}`;
                        const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');
                        applyFiltersAndRender(activeSales);
                    });
                    selectors.platformFilters.appendChild(btn);
                });
            };
            const renderAccountPlatformButtons = () => {
                const platformNames = Object.keys(platformStyles).filter(p => p !== 'Otro');
                selectors.accountPlatformButtons.innerHTML = '';

                // Función para determinar el mejor color de texto (blanco o negro) basado en el fondo
                const getTextColorForBg = (bgColor) => {
                    const color = (bgColor.charAt(0) === '#') ? bgColor.substring(1, 7) : bgColor;
                    const r = parseInt(color.substring(0, 2), 16); // Red
                    const g = parseInt(color.substring(2, 4), 16); // Green
                    const b = parseInt(color.substring(4, 6), 16); // Blue
                    const uicolors = [r / 255, g / 255, b / 255];
                    const c = uicolors.map((col) => {
                        if (col <= 0.03928) {
                            return col / 12.92;
                        }
                        return Math.pow((col + 0.055) / 1.055, 2.4);
                    });
                    const L = (0.2126 * c[0]) + (0.7152 * c[1]) + (0.0722 * c[2]);
                    return (L > 0.179) ? 'text-black' : 'text-white';
                };

                platformNames.forEach(name => {
                    const btn = document.createElement('button');
                    const platformStyle = platformStyles[name] || platformStyles['Otro'];
                    const textColorClass = getTextColorForBg(platformStyle.bg);

                    btn.type = 'button';
                    btn.textContent = name;
                    btn.dataset.platformName = name;
                    // Clases base y de transición
                    btn.className = `px-4 py-2 rounded-lg text-sm font-semibold border transition-all duration-200 ease-in-out transform hover:scale-105`;

                    // Estilos por defecto (no seleccionado)
                    btn.style.borderColor = platformStyle.bg;
                    btn.style.color = platformStyle.bg;
                    btn.style.backgroundColor = 'transparent';

                    btn.addEventListener('click', () => {
                        // Update hidden input
                        selectors.addAccountForm['account-platform'].value = name;

                        // Reset all buttons to their default (not selected) state
                        document.querySelectorAll('#account-platform-buttons button').forEach(b => {
                            const pStyle = platformStyles[b.dataset.platformName] || platformStyles['Otro'];
                            b.style.backgroundColor = 'transparent';
                            b.style.color = pStyle.bg;
                            b.classList.remove(getTextColorForBg(pStyle.bg)); // Asegurarse de quitar la clase de color de texto anterior
                        });

                        // Apply selected styles to the clicked button
                        btn.style.backgroundColor = platformStyle.bg;
                        btn.style.color = ''; // Limpiar color en línea para que la clase de Tailwind tome efecto
                        btn.classList.add(textColorClass);
                    });
                    selectors.accountPlatformButtons.appendChild(btn);
                });
            };
            const renderSales = (sales) => {
                selectors.salesList.innerHTML = '';
                const parentContainer = document.querySelector('.bg-white.rounded-2xl.shadow-lg.p-4');
                if (allSales.length === 0) {
                    selectors.emptyState.classList.remove('hidden');
                    parentContainer.classList.add('hidden');
                    return;
                }
                selectors.emptyState.classList.add('hidden');
                parentContainer.classList.remove('hidden');

                if (sales.length === 0) {
                    selectors.salesList.innerHTML = `<p class="text-gray-500 text-center col-span-8 py-4">No se encontraron ventas que coincidan.</p>`;
                    return;
                }

                const groupedSales = sales.reduce((acc, sale) => {
                    let key = 'Cuentas Manuales';
                    if (sale.accountId) {
                        const account = allPlatformAccounts.find(a => a.id === sale.accountId);
                        if (account) {
                            key = account.email;
                        } else if(sale.correo) {
                            key = sale.correo;
                        }
                    } else if (sale.correo) {
                         key = sale.correo;
                    }

                    if (!acc[key]) {
                        acc[key] = [];
                    }
                    acc[key].push(sale);
                    return acc;
                }, {});

                const sortedAccounts = Object.keys(groupedSales).sort();

                for (const accountEmail of sortedAccounts) {
                    const salesInGroup = groupedSales[accountEmail];
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'mb-6';

                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'py-2 px-4 bg-gray-100 rounded-t-lg border-b-2 border-gray-200';
                    groupHeader.innerHTML = `<h3 class="text-md font-semibold text-gray-800">${accountEmail}</h3>`;
                    groupContainer.appendChild(groupHeader);

                    const salesRowsContainer = document.createElement('div');
                    salesRowsContainer.className = 'bg-white rounded-b-lg shadow-sm border border-t-0 border-gray-200';

                    salesInGroup.forEach(sale => {
                        const statusText = getSaleStatus(sale.finPlan);
                        const statusInfo = { 'Vencido': { color: 'orange' }, 'Vence hoy': { color: 'red' }, 'Próximo a Vencer': { color: 'yellow' }, 'Activo': { color: 'green' } }[statusText];
                        const endDateForDisplay = dayjs(sale.finPlan);
                        const endDateForRelative = dayjs(sale.finPlan).endOf('day');

                        const row = document.createElement('div');
                        row.className = `grid grid-cols-2 md:grid-cols-8 gap-4 items-center p-3 hover:bg-gray-50 transition-colors duration-200 border-b last:border-b-0 border-gray-100 text-sm`;
                        row.innerHTML = `
                            <div class="col-span-2 font-semibold text-gray-800">
                                ${sale.cliente}
                                <div class="font-normal text-xs text-gray-500 md:hidden mt-1">
                                    ${getPlatformHtml(sale.plataforma)} &middot; Vence: ${endDateForDisplay.format('DD/MM/YYYY')}
                                </div>
                            </div>
                            <div class="hidden md:block">${getPlatformHtml(sale.plataforma)}</div>
                            <div class="hidden md:block">${endDateForDisplay.format('DD/MM/YYYY')} <span class="text-xs text-gray-500">(${endDateForRelative.fromNow()})</span></div>
                            <div class="hidden md:block"><span class="text-xs font-semibold py-1 px-2 uppercase rounded-full text-${statusInfo.color}-600 bg-${statusInfo.color}-100">${statusText}</span></div>
                            <div class="hidden md:block font-bold text-gray-800">${formatCurrency(sale.precio)}</div>
                            <div class="hidden md:block">${getMetodoPagoBadge(sale.metodoPago) || 'N/A'}</div>
                            <div class="flex justify-end gap-3 items-center">
                                <button class="edit-btn p-1 text-indigo-600 hover:text-indigo-800 hover:bg-indigo-100 rounded-full transition" data-id="${sale.id}" title="Editar">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>
                                </button>
                                <button class="renew-btn p-1 text-green-600 hover:text-green-800 hover:bg-green-100 rounded-full transition" data-id="${sale.id}" title="Renovar">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5"></path></svg>
                                </button>
                                <button class="delete-btn p-1 text-red-600 hover:text-red-800 hover:bg-red-100 rounded-full transition" data-id="${sale.id}" title="Eliminar">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                            <div class="md:hidden col-span-2 mt-2 pt-2 border-t flex justify-between items-center text-xs">
                                <span class="font-semibold py-1 px-2 uppercase rounded-full text-${statusInfo.color}-600 bg-${statusInfo.color}-100">${statusText}</span>
                                <span class="font-bold text-gray-800 text-base">${formatCurrency(sale.precio)}</span>
                            </div>
                        `;
                        salesRowsContainer.appendChild(row);
                    });

                    groupContainer.appendChild(salesRowsContainer);
                    selectors.salesList.appendChild(groupContainer);
                }

                selectors.salesList.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', e => handleEdit(e.currentTarget.dataset.id)));
                selectors.salesList.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', e => handleDeleteSale(e.currentTarget.dataset.id)));
                selectors.salesList.querySelectorAll('.renew-btn').forEach(b => b.addEventListener('click', e => openRenewalModal(e.currentTarget.dataset.id)));
            };
            const renderExpenses = () => {
                selectors.expensesList.innerHTML = '';
                if (allExpenses.length === 0) {
                    selectors.expensesList.innerHTML = '<p class="text-gray-500 text-center py-4">No hay egresos registrados.</p>';
                    return;
                }
                allExpenses.forEach(expense => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center py-3 border-b border-gray-100 last:border-b-0';
                    item.innerHTML = `
                        <div class="p-3 bg-red-50 rounded-full mr-4">
                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path></svg>
                        </div>
                        <div class="flex-grow">
                            <p class="font-medium text-gray-800">${expense.description}</p>
                            <p class="text-sm text-gray-500">${dayjs(expense.date).format('DD [de] MMMM, YYYY')}</p>
                        </div>
                        <div class="text-right mx-4">
                            <p class="font-semibold text-red-600 text-base">${formatCurrency(expense.amount)}</p>
                        </div>
                        <button class="delete-expense-btn text-gray-400 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition-colors" data-id="${expense.id}" title="Eliminar Gasto">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                        </button>
                    `;
                    selectors.expensesList.appendChild(item);
                });
                selectors.expensesList.querySelectorAll('.delete-expense-btn').forEach(b => b.addEventListener('click', e => handleDeleteExpense(e.currentTarget.dataset.id)));
            };
            const renderPlatformAccounts = () => {
                const { accountsList } = selectors;
                accountsList.innerHTML = '';

                if (allPlatformAccounts.length === 0) {
                    accountsList.innerHTML = '<p class="text-sm text-gray-400">No hay cuentas de plataforma registradas.</p>';
                    return;
                }

                // 1. Group accounts by platform
                const groupedAccounts = allPlatformAccounts.reduce((acc, account) => {
                    const { platform } = account;
                    if (!acc[platform]) {
                        acc[platform] = [];
                    }
                    acc[platform].push(account);
                    return acc;
                }, {});

                // 2. Iterate and render each group
                for (const platform in groupedAccounts) {
                    const accounts = groupedAccounts[platform];
                    const platformStyle = platformStyles[platform] || platformStyles['Otro'];

                    const listItems = accounts.map(account => {
                        let fechaPagoHtml = '';
                        if (account.fechaPago) {
                            const fechaPago = dayjs(account.fechaPago);
                            const hoy = dayjs().startOf('day');
                            const diffDays = fechaPago.diff(hoy, 'day');

                            const statusClasses = diffDays <= 5
                                ? 'bg-red-100 text-red-800'
                                : 'bg-green-100 text-green-800';

                            fechaPagoHtml = `<div class="mt-1"><span class="px-2 py-1 text-xs font-semibold rounded-lg ${statusClasses}">Próx. Pago: ${fechaPago.format('DD/MM/YYYY')}</span></div>`;
                        }

                        const enlaceBtnHtml = account.enlace
                            ? `<a href="${account.enlace}" target="_blank" class="p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded-full transition" title="Abrir enlace">
                                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                               </a>`
                            : `<span class="p-1 text-gray-400 cursor-not-allowed rounded-full" title="No hay enlace">
                                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                               </span>`;

                        const userIconSvg = `<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>`;
                        let profilesIndicatorHtml = '<div class="flex items-center gap-1.5 mt-2">';

                        if (account.profiles && account.profiles.length > 0) {
                            const sortedProfiles = account.profiles.sort((a, b) => a.nombre.localeCompare(b.nombre));
                            sortedProfiles.forEach(profile => {
                                const color = profile.estado === 'Disponible' ? 'text-green-500' : 'text-red-500';
                                profilesIndicatorHtml += `<span class="${color}" title="${profile.nombre}: ${profile.estado}">${userIconSvg}</span>`;
                            });
                        } else {
                            for (let i = 0; i < 5; i++) {
                                profilesIndicatorHtml += `<span class="text-gray-300" title="Perfil no configurado">${userIconSvg}</span>`;
                            }
                        }
                        profilesIndicatorHtml += '</div>';
                        return `
                            <li class="list-group-item flex flex-col md:flex-row justify-between items-start md:items-center py-3 px-4">
                                <div class="mb-2 md:mb-0">
                                    <span class="font-semibold text-gray-800 break-all">${account.email}</span>
                                    ${profilesIndicatorHtml}
                                    ${fechaPagoHtml}
                                </div>
                                <div class="flex items-center gap-2 self-end md:self-center">
                                    <input type="password" value="${account.password}" class="w-40 bg-gray-100 border-gray-200 text-sm rounded-md px-2 py-1" readonly>
                                    <button class="toggle-password-btn p-1 text-gray-500 hover:text-gray-800 hover:bg-gray-200 rounded-full transition" title="Mostrar/Ocultar contraseña">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    </button>
                                    <button class="manage-profiles-btn p-1 text-teal-600 hover:text-teal-800 hover:bg-teal-100 rounded-full transition" data-id="${account.id}" title="Gestionar Perfiles">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                    </button>
                                    <button class="edit-account-btn p-1 text-indigo-600 hover:text-indigo-800 hover:bg-indigo-100 rounded-full transition" data-id="${account.id}" title="Editar Cuenta">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>
                                    </button>
                                    ${enlaceBtnHtml}
                                    <button class="delete-account-btn p-1 text-red-600 hover:text-red-800 hover:bg-red-100 rounded-full transition" data-id="${account.id}" title="Eliminar">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </li>`;
                    }).join('');

                    const cardHtml = `
                        <div class="bg-white rounded-2xl shadow-lg mb-6 overflow-hidden border border-gray-200">
                            <div class="px-4 py-3 border-b border-gray-200" style="background-color: ${platformStyle.bg};">
                                <h3 class="text-lg font-semibold text-white">${platform}</h3>
                            </div>
                            <ul class="divide-y divide-gray-200">
                                ${listItems}
                            </ul>
                        </div>
                    `;
                    accountsList.innerHTML += cardHtml;
                }

                // 3. Add Event Listeners after rendering
                accountsList.querySelectorAll('.delete-account-btn').forEach(btn => {
                    btn.addEventListener('click', e => handleDeleteAccount(e.currentTarget.dataset.id));
                });
                 accountsList.querySelectorAll('.edit-account-btn').forEach(btn => {
                    btn.addEventListener('click', e => handleEditAccount(e.currentTarget.dataset.id));
                });
                accountsList.querySelectorAll('.manage-profiles-btn').forEach(btn => {
                    btn.addEventListener('click', e => handleManageProfiles(e.currentTarget.dataset.id));
                });

                accountsList.querySelectorAll('.toggle-password-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const button = e.currentTarget;
                        const passwordInput = button.previousElementSibling;
                        const icon = button.querySelector('svg');

                        if (passwordInput && passwordInput.tagName === 'INPUT') {
                            if (passwordInput.type === 'password') {
                                passwordInput.type = 'text';
                                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .946-3.11 3.563-5.522 6.837-6.141M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.581 10.41A7.48 7.48 0 0119.542 12c-1.274 4.057-5.064 7-9.542 7a10.046 10.046 0 01-3.132-.475M2.458 12c.946-3.11 3.563-5.522 6.837-6.141m1.581 2.318A4.5 4.5 0 0115 12a4.5 4.5 0 01-1.07 2.828M5 5l14 14" />`;
                            } else {
                                passwordInput.type = 'password';
                                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />`;
                            }
                        }
                    });
                });
            };

            const populatePlatformAccountsDropdowns = (platform = null) => {
                let accountsToDisplay = allPlatformAccounts;
                if (platform && platform !== 'Otro') {
                    accountsToDisplay = allPlatformAccounts.filter(acc => acc.platform === platform);
                }

                const createOption = (account) => `<option value="${account.id}">${account.platform} - ${account.email}</option>`;
                const options = accountsToDisplay.map(createOption).join('');

                // For the "Add Sale" form
                selectors.platformAccountSelect.innerHTML = `<option value="">Sin cuenta / Ingresar manualmente</option>${options}`;

                // For the "Edit Sale" form - we might need to show all for existing sales
                const allOptions = allPlatformAccounts.map(createOption).join('');
                selectors.editPlatformAccountSelect.innerHTML = `<option value="">Sin cuenta / Ingresar manualmente</option>${allOptions}`;

                // For the general filter, always show all
                selectors.accountFilter.innerHTML = `<option value="">Filtrar por cuenta...</option>${allOptions}`;
            };

            const handlePlatformAccountChange = (select, emailInput, passwordInput, credentialsContainer, profileSelect) => {
                const accountId = select.value;
                const account = allPlatformAccounts.find(a => a.id === accountId);

                // Reset profile dropdown
                profileSelect.innerHTML = '<option value="">Selecciona una cuenta madre primero</option>';
                profileSelect.disabled = true;
                profileSelect.classList.add('bg-gray-200');

                if (account) {
                    emailInput.value = account.email;
                    passwordInput.value = account.password;
                    credentialsContainer.forEach(el => el.classList.add('hidden'));

                    if (account.profiles && account.profiles.length > 0) {
                        const availableProfiles = account.profiles.filter(p => p.estado === 'Disponible');
                        if (availableProfiles.length > 0) {
                            profileSelect.innerHTML = '<option value="">Selecciona un perfil</option>';
                            availableProfiles.forEach(p => {
                                profileSelect.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
                            });
                            profileSelect.disabled = false;
                            profileSelect.classList.remove('bg-gray-200');
                        } else {
                            profileSelect.innerHTML = '<option value="">No hay perfiles disponibles</option>';
                        }
                    } else {
                         profileSelect.innerHTML = '<option value="">Perfiles no configurados</option>';
                    }
                } else {
                    emailInput.value = '';
                    passwordInput.value = '';
                    credentialsContainer.forEach(el => el.classList.remove('hidden'));
                }
            };
            const handleEdit = (id) => {
                const sale = allSales.find(s => s.id === id);
                if (!sale) return;
                const f = selectors.editForm;
                f['edit-sale-id'].value = sale.id;
                f['edit-cliente'].value = sale.cliente;
                f['edit-precio'].value = sale.precio;
                f['edit-inicioPlan'].value = sale.inicioPlan;
                f['edit-finPlan'].value = sale.finPlan;
                f['edit-correo'].value = sale.correo || '';
                f['edit-contrasena'].value = sale.contrasena || '';
                f['edit-pin'].value = sale.pin || '';
                f['edit-notas'].value = sale.notas || '';
                f['edit-metodoPago'].value = sale.metodoPago || '';
                f['edit-platform-account'].value = sale.accountId || '';

                // Populate and set the profile dropdown
                const account = allPlatformAccounts.find(a => a.id === sale.accountId);
                selectors.editProfileSelect.innerHTML = '<option value="">Selecciona un perfil</option>';
                if (account && account.profiles) {
                    const currentProfile = account.profiles.find(p => p.id === sale.profileId);
                    const availableProfiles = account.profiles.filter(p => p.estado === 'Disponible');

                    // Add available profiles first
                    availableProfiles.forEach(p => {
                        selectors.editProfileSelect.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
                    });

                    // Add the currently assigned profile if it's not already in the list (i.e., it's 'Ocupado')
                    if (currentProfile && !availableProfiles.some(p => p.id === currentProfile.id)) {
                         selectors.editProfileSelect.innerHTML += `<option value="${currentProfile.id}">${currentProfile.nombre} (Ocupado)</option>`;
                    }
                }
                 f['edit-profile-select'].value = sale.profileId || '';


                // El menú desplegable se actualiza directamente con .value

                const standardPlatforms = Array.from(f['edit-plataforma'].options).map(o => o.value);
                if (standardPlatforms.includes(sale.plataforma)) {
                    f['edit-plataforma'].value = sale.plataforma;
                } else {
                    f['edit-plataforma'].value = 'Otro';
                    selectors.editOtroPlataformaInput.value = sale.plataforma;
                }
                handlePlatformChange(selectors.editPlataformaSelect, selectors.editOtroPlataformaContainer, selectors.editOtroPlataformaInput);
                openModal();
            };
            const openRenewalModal = (saleId) => {
                const sale = allSales.find(s => s.id === saleId);
                if (!sale) return;

                const modal = document.getElementById('renewal-modal');
                const form = document.getElementById('renewal-form');

                form['renewal-sale-id'].value = sale.id;
                form['renewal-amount'].value = sale.precio.toFixed(2);
                form['renewal-days'].value = 30; // Default a 30 días

                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            };

            const closeRenewalModal = () => {
                const modal = document.getElementById('renewal-modal');
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.getElementById('renewal-form').reset();
                }, 300);
            };

            const handleRenew = async (id) => {
                const originalSale = allSales.find(s => s.id === id);
                if (!originalSale) {
                    alert('Error: No se encontró la venta original.');
                    return;
                }

                // Archivar la venta original
                await updateDoc(doc(db, "sales", id), { estado: 'ARCHIVADO' });

                // Crear una nueva venta
                const renewalDays = parseInt(document.getElementById('renewal-days').value, 10);
                const renewalAmount = parseFloat(document.getElementById('renewal-amount').value);

                if (isNaN(renewalDays) || isNaN(renewalAmount) || renewalDays <= 0) {
                    alert('Por favor, ingresa un número de días y un monto válidos.');
                    return;
                }

                const today = dayjs();
                const currentEndDate = dayjs(originalSale.finPlan);

                let newEndDate;
                if (currentEndDate.isAfter(today)) {
                    // Caso A: Suscripción activa - sumar a la fecha de fin existente
                    newEndDate = currentEndDate.add(renewalDays, 'day');
                } else {
                    // Caso B: Suscripción vencida - sumar a la fecha de hoy
                    newEndDate = today.add(renewalDays, 'day');
                }

                const newSale = {
                    ...originalSale, // Copiar datos originales
                    precio: renewalAmount,
                    inicioPlan: dayjs().format('YYYY-MM-DD'), // El inicio es hoy
                    finPlan: newEndDate.format('YYYY-MM-DD'),
                    estado: 'ACTIVO', // Asegurarse de que el estado sea activo
                    createdAt: new Date().toISOString()
                };
                delete newSale.id; // Eliminar el ID para que Firestore genere uno nuevo

                try {
                    await addDoc(collection(db, "sales"), newSale);
                    closeRenewalModal();
                } catch (error) {
                    console.error("Error al crear la nueva venta de renovación:", error);
                    // Opcional: Revertir el archivado si la creación falla
                    await updateDoc(doc(db, "sales", id), { estado: 'ACTIVO' });
                    alert('Hubo un error al procesar la renovación.');
                }
            };
            const handlePermanentDeleteAction = async (id) => {
                const sale = allSales.find(s => s.id === id);
                if (sale && sale.accountId && sale.profileId) {
                    const profileRef = doc(db, "platformAccounts", sale.accountId, "Perfiles", sale.profileId);
                    await updateDoc(profileRef, { estado: 'Disponible', fechaVencimiento: null, clienteId: null });

                    const account = allPlatformAccounts.find(a => a.id === sale.accountId);
                    const profile = account.profiles.find(p => p.id === sale.profileId);
                    profile.estado = 'Disponible';
                    renderPlatformAccounts();
                }
                try {
                    await deleteDoc(doc(db, "sales", id));
                    hideArchiveDeleteModal();
                } catch (e) {
                    console.error("Error deleting sale: ", e);
                    alert('Error al eliminar la venta.');
                    hideArchiveDeleteModal();
                }
            };

            const handleArchiveAction = async (id) => {
                 const sale = allSales.find(s => s.id === id);
                if (sale && sale.accountId && sale.profileId) {
                    const profileRef = doc(db, "platformAccounts", sale.accountId, "Perfiles", sale.profileId);
                    await updateDoc(profileRef, { estado: 'Disponible', fechaVencimiento: null, clienteId: null });

                    const account = allPlatformAccounts.find(a => a.id === sale.accountId);
                    const profile = account.profiles.find(p => p.id === sale.profileId);
                    profile.estado = 'Disponible';
                    renderPlatformAccounts();
                }
                try {
                    await updateDoc(doc(db, "sales", id), { estado: 'ARCHIVADO' });
                    hideArchiveDeleteModal();
                } catch (e) {
                    console.error("Error archiving sale: ", e);
                    alert('Error al archivar la venta.');
                    hideArchiveDeleteModal();
                }
            };
             const openEditAccountModal = () => {
                selectors.editAccountModal.classList.remove('hidden');
                setTimeout(() => {
                    selectors.editAccountModal.classList.remove('opacity-0');
                    selectors.editAccountModal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            };

            const closeEditAccountModal = () => {
                selectors.editAccountModal.classList.add('opacity-0');
                selectors.editAccountModal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => selectors.editAccountModal.classList.add('hidden'), 300);
            };
             const handleEditAccount = (id) => {
                const account = allPlatformAccounts.find(acc => acc.id === id);
                if (!account) return;

                const form = selectors.editAccountForm;
                form['edit-account-id'].value = account.id;
                form['edit-account-platform'].value = account.platform;
                form['edit-account-email'].value = account.email;
                form['edit-account-enlace'].value = account.enlace || '';
                form['edit-account-fechaPago'].value = account.fechaPago || '';
                form['edit-account-password'].value = ''; // Clear password field for security

                openEditAccountModal();
            };

            const handleManageProfiles = async (accountId) => {
                const account = allPlatformAccounts.find(acc => acc.id === accountId);
                if (!account) return;

                selectors.profilesModalAccountEmail.textContent = account.email;
                const profilesRef = collection(db, "platformAccounts", accountId, "Perfiles");
                const profilesSnapshot = await getDocs(profilesRef);

                if (profilesSnapshot.empty) {
                    selectors.profilesContentArea.innerHTML = `
                        <div class="text-center p-8">
                            <p class="text-gray-600 mb-4">Esta cuenta aún no tiene perfiles configurados.</p>
                            <button id="create-profiles-btn" data-account-id="${accountId}" class="bg-teal-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-teal-700 transition">
                                Crear 5 Perfiles Iniciales
                            </button>
                        </div>
                    `;
                    document.getElementById('create-profiles-btn').addEventListener('click', async (e) => {
                        const btn = e.currentTarget;
                        btn.disabled = true;
                        btn.textContent = 'Creando...';

                        const newProfiles = await createInitialProfiles(accountId);

                        // Manually update the in-memory state
                        const accountIndex = allPlatformAccounts.findIndex(acc => acc.id === accountId);
                        if (accountIndex !== -1) {
                            allPlatformAccounts[accountIndex].profiles = newProfiles;
                        }

                        // Re-render the main accounts list to show new icons
                        renderPlatformAccounts();

                        // Refresh the modal content
                        await handleManageProfiles(accountId);
                    });
                } else {
                    let profilesHtml = '<ul class="space-y-3">';
                    const profiles = profilesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.nombre.localeCompare(b.nombre));

                    profiles.forEach(profile => {
                        const isAvailable = profile.estado === 'Disponible';
                        const statusColor = isAvailable ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const statusIcon = isAvailable
                            ? `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`
                            : `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;

                        profilesHtml += `
                            <li class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <span class="font-semibold text-gray-700">${profile.nombre}</span>
                                <span class="px-3 py-1 text-xs font-bold rounded-full ${statusColor} flex items-center gap-1">
                                    ${statusIcon}
                                    ${profile.estado}
                                </span>
                            </li>
                        `;
                    });
                    profilesHtml += '</ul>';
                    selectors.profilesContentArea.innerHTML = profilesHtml;
                }

                openProfilesModal();
            };

            const createInitialProfiles = async (accountId) => {
                const profilesRef = collection(db, "platformAccounts", accountId, "Perfiles");
                const createdProfiles = [];
                for (let i = 1; i <= 5; i++) {
                    const profileDoc = {
                        nombre: `Perfil ${i}`,
                        estado: 'Disponible',
                        fechaVencimiento: null,
                        clienteId: null,
                        pin: ''
                    };
                    const docRef = await addDoc(profilesRef, profileDoc);
                    createdProfiles.push({ id: docRef.id, ...profileDoc });
                }
                return createdProfiles;
            };


            const handleDeleteSale = (id) => showArchiveDeleteModal(id);
            const handleDeleteExpense = (id) => {
                showConfirmationModal(
                    'Eliminar Gasto',
                    '¿Estás seguro de que quieres eliminar este gasto? Esta acción no se puede deshacer.',
                    () => {
                        deleteDoc(doc(db, "expenses", id)).catch(e => console.error(e));
                    }
                );
            };
            const handleDeleteAccount = (id) => {
                showConfirmationModal(
                    'Eliminar Cuenta',
                    '¿Estás seguro de que quieres eliminar esta cuenta de plataforma? Esto no afectará a las ventas ya registradas.',
                    () => {
                        deleteDoc(doc(db, "platformAccounts", id)).catch(e => console.error(e));
                    }
                );
            };
            onSnapshot(collection(db, "sales"), (snapshot) => {
                allSales = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');
                activeSales.sort((a, b) => new Date(a.finPlan) - new Date(b.finPlan));
                selectors.loadingState.classList.add('hidden');
                if (activeSales.length === 0) {
                    selectors.emptyState.classList.remove('hidden');
                } else {
                    selectors.emptyState.classList.add('hidden');
                }
                renderPlatformFilters();
                renderAccountPlatformButtons();
                applyFiltersAndRender(activeSales); // Pass the filtered list
                updateFinancialSummary(); // This will still use allSales to include archived in totals
                loadDashboardData();
            }, (e) => {
                console.error("Error al cargar ventas:", e);
            });
            onSnapshot(collection(db, "expenses"), (snapshot) => { allExpenses = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); allExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)); renderExpenses(); updateFinancialSummary(); loadDashboardData(); }, (e) => { console.error("Error al cargar egresos:", e); });
            onSnapshot(collection(db, "platformAccounts"), async (snapshot) => {
                const accountsPromises = snapshot.docs.map(async (accountDoc) => {
                    const accountData = { id: accountDoc.id, ...accountDoc.data() };
                    const profilesRef = collection(db, "platformAccounts", accountDoc.id, "Perfiles");
                    const profilesSnapshot = await getDocs(profilesRef);
                    accountData.profiles = profilesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    return accountData;
                });

                allPlatformAccounts = await Promise.all(accountsPromises);

                renderPlatformAccounts();
                populatePlatformAccountsDropdowns();
                loadDashboardData();
            }, (e) => { console.error("Error al cargar cuentas:", e); });
            selectors.addSaleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const f = selectors.addSaleForm;
                const accountId = f['platform-account'].value;
                const profileId = f['profile-select'].value;

                if (accountId && !profileId) {
                    alert('Por favor, selecciona un perfil para esta cuenta.');
                    return;
                }

                const newSale = { cliente: f.cliente.value, plataforma: f.plataforma.value === 'Otro' ? selectors.otroPlataformaInput.value : f.plataforma.value, precio: parseFloat(f.precio.value), inicioPlan: f.inicioPlan.value, finPlan: f.finPlan.value, correo: f.correo.value, contrasena: f.contrasena.value, pin: f.pin.value, notas: f.notas.value, metodoPago: f.metodoPago.value, accountId, profileId, createdAt: new Date().toISOString(), estado: 'ACTIVO' };

                try {
                    const docRef = await addDoc(collection(db, "sales"), newSale);

                    if (accountId && profileId) {
                        const profileRef = doc(db, "platformAccounts", accountId, "Perfiles", profileId);
                        await updateDoc(profileRef, {
                            estado: 'Ocupado',
                            fechaVencimiento: f.finPlan.value,
                            clienteId: docRef.id
                        });

                        const account = allPlatformAccounts.find(a => a.id === accountId);
                        const profile = account.profiles.find(p => p.id === profileId);
                        profile.estado = 'Ocupado';
                        renderPlatformAccounts();
                    }

                    f.reset();
                    f.metodoPago.value = ""; // Reiniciar el select
                    handlePlatformChange(selectors.plataformaSelect, selectors.otroPlataformaContainer, selectors.otroPlataformaInput);
                } catch (err) {
                    console.error("Error al guardar venta:", err);
                    alert("Error al guardar la venta. Revisa la consola (F12).");
                }
            });

            selectors.editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const f = selectors.editForm;
                const saleId = f['edit-sale-id'].value;
                const originalSale = allSales.find(s => s.id === saleId);

                const newAccountId = f['edit-platform-account'].value;
                const newProfileId = f['edit-profile-select'].value;

                // Check if profile has changed
                if (originalSale.accountId && originalSale.profileId && (originalSale.accountId !== newAccountId || originalSale.profileId !== newProfileId)) {
                    // Free up the old profile
                    const oldProfileRef = doc(db, "platformAccounts", originalSale.accountId, "Perfiles", originalSale.profileId);
                    await updateDoc(oldProfileRef, { estado: 'Disponible', fechaVencimiento: null, clienteId: null });
                }

                const updatedSale = {
                    cliente: f['edit-cliente'].value,
                    plataforma: f['edit-plataforma'].value === 'Otro' ? selectors.editOtroPlataformaInput.value : f['edit-plataforma'].value,
                    precio: parseFloat(f['edit-precio'].value),
                    inicioPlan: f['edit-inicioPlan'].value,
                    finPlan: f['edit-finPlan'].value,
                    correo: f['edit-correo'].value,
                    contrasena: f['edit-contrasena'].value,
                    pin: f['edit-pin'].value,
                    notas: f['edit-notas'].value,
                    metodoPago: f['edit-metodoPago'].value,
                    accountId: newAccountId,
                    profileId: newProfileId
                };

                try {
                    await updateDoc(doc(db, "sales", saleId), updatedSale);

                    // Occupy the new profile
                    if (newAccountId && newProfileId) {
                        const newProfileRef = doc(db, "platformAccounts", newAccountId, "Perfiles", newProfileId);
                        await updateDoc(newProfileRef, {
                            estado: 'Ocupado',
                            fechaVencimiento: updatedSale.finPlan,
                            clienteId: saleId
                        });
                    }

                    // Manually trigger a re-render
                    const accountsSnapshot = await getDocs(collection(db, "platformAccounts"));
                     const accountsPromises = accountsSnapshot.docs.map(async (accountDoc) => {
                        const accountData = { id: accountDoc.id, ...accountDoc.data() };
                        const profilesRef = collection(db, "platformAccounts", accountDoc.id, "Perfiles");
                        const profilesSnapshot = await getDocs(profilesRef);
                        accountData.profiles = profilesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        return accountData;
                    });
                    allPlatformAccounts = await Promise.all(accountsPromises);
                    renderPlatformAccounts();

                    closeModal();
                } catch (err) {
                    console.error("Error al actualizar la venta:", err);
                    alert("Error al actualizar la venta. Revisa la consola (F12).");
                }
            });
            selectors.addExpenseForm.addEventListener('submit', async (e) => { e.preventDefault(); const f = selectors.addExpenseForm; const description = f['expense-description'].value; const amount = parseFloat(f['expense-amount'].value); const date = f['expense-date'].value; if (!description || !date || isNaN(amount) || amount <= 0) return; try { await addDoc(collection(db, "expenses"), { description, amount, date }); f.reset(); f['expense-date'].value = dayjs().format('YYYY-MM-DD'); } catch (err) { console.error("Error al añadir egreso:", err); } });
            selectors.addAccountForm.addEventListener('submit', async (e) => { e.preventDefault(); const f = selectors.addAccountForm; const newAccount = { platform: f['account-platform'].value, email: f['account-email'].value, password: f['account-password'].value, enlace: f.enlace.value, fechaPago: f.fechaPago.value }; try { await addDoc(collection(db, "platformAccounts"), newAccount); f.reset(); document.querySelectorAll('#account-platform-buttons button').forEach(b => b.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600')); } catch (err) { console.error("Error al guardar cuenta:", err); } });
            selectors.searchInput.addEventListener('input', e => {
                currentSearchTerm = e.target.value;
                const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');
                applyFiltersAndRender(activeSales);
            });
            selectors.accountFilter.addEventListener('change', e => {
                activeAccountFilter = e.target.value;
                const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');
                applyFiltersAndRender(activeSales);
            });
            selectors.statusFilter.addEventListener('change', e => {
                activeStatusFilter = e.target.value;
                const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');
                applyFiltersAndRender(activeSales);
            });
            selectors.plataformaSelect.addEventListener('change', () => {
                handlePlatformChange(selectors.plataformaSelect, selectors.otroPlataformaContainer, selectors.otroPlataformaInput);
                populatePlatformAccountsDropdowns(selectors.plataformaSelect.value);
            });
            selectors.editPlataformaSelect.addEventListener('change', () => {
                handlePlatformChange(selectors.editPlataformaSelect, selectors.editOtroPlataformaContainer, selectors.editOtroPlataformaInput);
                // We don't filter the edit form dropdown to avoid issues with existing data
            });
            selectors.closeModalBtn.addEventListener('click', closeModal);
            selectors.cancelEditBtn.addEventListener('click', closeModal);
            selectors.closeProfilesModalBtn.addEventListener('click', closeProfilesModal);


            document.getElementById('renewal-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const saleId = document.getElementById('renewal-sale-id').value;
                handleRenew(saleId);
            });

            document.getElementById('cancel-renewal-btn').addEventListener('click', closeRenewalModal);
            selectors.platformAccountSelect.addEventListener('change', () => handlePlatformAccountChange(selectors.platformAccountSelect, selectors.addSaleForm.correo, selectors.addSaleForm.contrasena, document.querySelectorAll('.manual-credentials'), selectors.profileSelect));
            selectors.editPlatformAccountSelect.addEventListener('change', () => handlePlatformAccountChange(selectors.editPlatformAccountSelect, selectors.editForm['edit-correo'], selectors.editForm['edit-contrasena'], document.querySelectorAll('.edit-manual-credentials'), selectors.editProfileSelect));
             selectors.editAccountForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = selectors.editAccountForm;
                const id = form['edit-account-id'].value;
                const account = allPlatformAccounts.find(acc => acc.id === id);
                if (!account) return;

                const updatedData = {
                    email: form['edit-account-email'].value,
                    enlace: form['edit-account-enlace'].value,
                    fechaPago: form['edit-account-fechaPago'].value,
                };

                const newPassword = form['edit-account-password'].value;
                if (newPassword) {
                    updatedData.password = newPassword;
                }

                try {
                    await updateDoc(doc(db, "platformAccounts", id), updatedData);
                    closeEditAccountModal();
                } catch (err) {
                    console.error("Error al actualizar la cuenta:", err);
                    alert("Error al actualizar la cuenta. Revisa la consola (F12).");
                }
            });

            selectors.closeEditAccountModalBtn.addEventListener('click', closeEditAccountModal);
            selectors.cancelEditAccountBtn.addEventListener('click', closeEditAccountModal);
            const diasPlanInput = document.getElementById('diasPlan'); const inicioPlanInput = document.getElementById('inicioPlan'); const finPlanInput = document.getElementById('finPlan');
            const editFinPlanInput = document.getElementById('edit-finPlan');

            const calculateEndDate = () => {
                const days = parseInt(diasPlanInput.value, 10);
                const startDate = inicioPlanInput.value;
                if (!isNaN(days) && startDate) {
                    const newEndDate = dayjs(startDate).add(days, 'day').format('YYYY-MM-DD');
                    finPlanInput.value = newEndDate;
                }
            };

            diasPlanInput.addEventListener('input', calculateEndDate);
            inicioPlanInput.addEventListener('change', calculateEndDate);


            // Set default expense date
            document.getElementById('expense-date').value = dayjs().format('YYYY-MM-DD');


            // Navigation logic
            const navLinks = {
                'nav-dashboard': 'Dashboard',
                'nav-cuentas': 'Cuentas',
                'nav-ventas': 'Ventas',
                'nav-finanzas': 'Finanzas'
            };
            const views = document.querySelectorAll('.view');

            Object.keys(navLinks).forEach(navId => {
                document.getElementById(navId).addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = `${navLinks[navId].toLowerCase()}-view`;

                    views.forEach(view => {
                        if (view.id === viewId) {
                            view.classList.remove('hidden');
                        } else {
                            view.classList.add('hidden');
                        }
                    });

                    // Update active styles for nav links
                    document.querySelectorAll('nav a').forEach(link => link.classList.remove('bg-gray-700'));
                    document.getElementById(navId).classList.add('bg-gray-700');
                });
            });

            // Set default view
            document.getElementById('nav-dashboard').click();


            // Quick Access button listeners
            document.getElementById('quick-add-sale').addEventListener('click', () => {
                document.getElementById('nav-ventas').click();
            });
            document.getElementById('quick-add-expense').addEventListener('click', () => {
                document.getElementById('nav-finanzas').click();
            });
        }

        const checkAndReleaseExpiredProfiles = async () => {
            const today = dayjs().startOf('day');
            const accountsSnapshot = await getDocs(collection(db, "platformAccounts"));
            for (const accountDoc of accountsSnapshot.docs) {
                const profilesRef = collection(db, "platformAccounts", accountDoc.id, "Perfiles");
                const profilesSnapshot = await getDocs(profilesRef);
                for (const profileDoc of profilesSnapshot.docs) {
                    const profile = profileDoc.data();
                    if (profile.estado === 'Ocupado' && profile.fechaVencimiento) {
                        if (today.isAfter(dayjs(profile.fechaVencimiento))) {
                            console.log(`Liberando perfil ${profile.nombre} de la cuenta ${accountDoc.data().email} por vencimiento.`);
                            const profileRef = doc(db, "platformAccounts", accountDoc.id, "Perfiles", profileDoc.id);
                            await updateDoc(profileRef, { estado: 'Disponible', fechaVencimiento: null, clienteId: null });
                        }
                    }
                }
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                checkAndReleaseExpiredProfiles().then(() => {
                    startApp();
                });
            } else {
                window.location.href = 'login.html';
            }
        });
        window.startApp = startApp;

        // Toast notification logic
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('loggedin')) {
                const toast = document.createElement('div');
                toast.className = 'toast fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-x-full opacity-0';
                toast.textContent = 'Bienvenido a NineStreaming. Renzo y Charitsa';
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                    toast.classList.add('translate-x-0', 'opacity-100');
                }, 100);

                setTimeout(() => {
                    toast.classList.remove('translate-x-0', 'opacity-100');
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => {
                        toast.remove();
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 500);
                }, 5000);
            }
        });
    </script>
    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js');
    });
  }
</script>
</body>
</html>