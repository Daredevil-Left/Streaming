<!DOCTYPE html>
<html lang="es">

<head>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo_nuevo.png" type="image/png">
    <link href="./output.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ventas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/es.js"></script>
</head>


<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6;
    }

    .modal {
        transition: opacity 0.3s ease;
    }

    .modal-content {
        transition: transform 0.3s ease;
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield;
    }

    .platform-btn img {
        transition: transform 0.2s ease-in-out;
    }

    .platform-btn:hover img {
        transform: scale(1.1);
    }

    .sidebar-text {
        display: inline-block;
        opacity: 1;
        white-space: nowrap;
        transition: opacity 0.3s ease-in-out;
    }

    /* Desktop behaviors */
    @media (min-width: 768px) {
        .sidebar-text {
            display: none;
            opacity: 0;
        }

        #sidebar:hover .sidebar-text {
            display: inline-block;
            opacity: 1;
        }

        #sidebar:not(:hover) nav a,
        #sidebar:not(:hover) #logout-btn {
            justify-content: center;
        }
    }

    .toast {
        transition: opacity 0.5s, transform 0.5s;
    }

    /* Skeleton Loading Animation */
    .skeleton {
        animation: skeleton-loading 1.5s infinite;
        border-radius: 0.5rem;
        color: transparent !important;
        user-select: none;
        background-color: rgba(255, 255, 255, 0.2);
        /* Default for dark backgrounds */
        display: inline-block;
        min-width: 80px;
    }

    .skeleton-dark {
        background-color: rgba(0, 0, 0, 0.1) !important;
        /* For light backgrounds */
    }

    @keyframes skeleton-loading {
        0% {
            opacity: 0.6;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.6;
        }
    }

    /* Sidebar Responsive Styles */
    #sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        z-index: 50;
        width: 16rem;
        transform: translateX(-100%);
        transition: all 0.3s ease-in-out;
    }

    #sidebar.open {
        transform: translateX(0);
    }

    @media (min-width: 768px) {
        #sidebar {
            position: relative !important;
            transform: none !important;
            width: 4rem !important;
            z-index: auto;
        }

        #sidebar:hover {
            width: 16rem !important;
        }
    }

    .tilt-card {
        transition: transform 0.1s ease-out;
        transform-style: preserve-3d;
        will-change: transform;
    }

    /* Masonry Layout Support */
    #contenedor-cuentas-agrupadas {
        column-count: 1;
        column-gap: 1.5rem;
    }

    @media (min-width: 1024px) {
        #contenedor-cuentas-agrupadas {
            column-count: 3;
        }
    }

    .break-inside-avoid {
        break-inside: avoid;
        page-break-inside: avoid;
        -webkit-column-break-inside: avoid;
        display: inline-block;
        width: 100%;
    }
</style>
</head>

<body class="antialiased">

    <div id="app" class="flex h-screen bg-gray-100 hidden">
        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"
            onclick="toggleMobileMenu()"></div>

        <!-- Sidebar -->
        <div id="sidebar" class="bg-gray-800 text-white flex flex-col overflow-hidden">
            <div class="flex items-center justify-center h-20 border-b border-gray-700">
                <img src="logo_nuevo.png" alt="Logo" class="h-10 w-10 object-contain">
            </div>
            <nav class="flex-1 px-2 py-4 space-y-2">
                <a href="#" id="nav-dashboard" class="flex items-center py-2.5 px-2 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                        </path>
                    </svg>
                    <span class="ml-4 sidebar-text">Dashboard</span>
                </a>
                <a href="#" id="nav-cuentas" class="flex items-center py-2.5 px-2 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="ml-4 sidebar-text">Cuentas</span>
                </a>
                <a href="#" id="nav-ventas" class="flex items-center py-2.5 px-2 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
                        </path>
                    </svg>
                    <span class="ml-4 sidebar-text">Ventas</span>
                </a>
                <a href="#" id="nav-finanzas" class="flex items-center py-2.5 px-2 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                    </svg>
                    <span class="ml-4 sidebar-text">Finanzas</span>
                </a>
                <a href="#" id="nav-precios" class="flex items-center py-2.5 px-2 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                        </path>
                    </svg>
                    <span class="ml-4 sidebar-text">Precios</span>
                </a>
            </nav>
            <div class="px-2 py-4">
                <button id="logout-btn"
                    class="w-full flex items-center py-2.5 px-2 rounded-md bg-red-500 hover:bg-red-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                    <span class="ml-4 sidebar-text">Cerrar Sesión</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Mobile Header -->
            <header class="md:hidden bg-white shadow-sm p-4 flex items-center justify-between z-10">
                <button onclick="toggleMobileMenu()" class="text-gray-600 hover:text-gray-900 focus:outline-none">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <div class="flex items-center">
                    <img src="logo_nuevo.png" alt="Logo" class="h-8 w-auto mr-2">
                    <span class="font-bold text-gray-800">Control de Ventas</span>
                </div>
                <div class="w-6"></div> <!-- Spacer for alignment -->
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-2 md:p-8">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view hidden">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 md:mb-8 px-2 md:px-0">Dashboard</h1>
                    <!-- KPI Widgets -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
                        <div class="bg-[linear-gradient(to_right,#00b09b,#1a2a27)] p-4 md:p-6 rounded-2xl flex items-center tilt-card">
                            <div>
                                <!-- Icono Ventas Hoy (Forma Sol) -->
                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                                    </path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-sm font-medium text-white/75">Ventas de Hoy</h3>
                                <p id="kpi-sales-today" class="text-2xl font-black text-white skeleton"
                                    style="text-shadow: 0 0 8px rgba(0, 176, 155, 0.7);">&nbsp;</p>
                            </div>
                        </div>
                        <div class="bg-[linear-gradient(to_right,#2c3e50,#000428)] p-4 md:p-6 rounded-2xl flex items-center tilt-card">
                            <div>
                                <!-- Icono Calendario -->
                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                    </path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-sm font-medium text-white/75">Ventas del Mes</h3>
                                <p id="kpi-sales-month" class="text-2xl font-black text-white skeleton"
                                    style="text-shadow: 0 0 8px rgba(44, 62, 80, 0.7);">&nbsp;</p>
                            </div>
                        </div>
                        <div class="bg-[linear-gradient(to_right,#6a3093,#301934)] p-4 md:p-6 rounded-2xl flex items-center tilt-card">
                            <div>
                                <!-- Icono Usuario -->
                                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-sm font-medium text-white/75">Clientes Activos</h3>
                                <p id="kpi-active-clients" class="text-2xl font-black text-white skeleton"
                                    style="text-shadow: 0 0 8px rgba(106, 48, 147, 0.7);">&nbsp;</p>
                            </div>
                        </div>
                    </div>

                    <!-- Search PIN and Available Accounts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <!-- PIN Search -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg tilt-card">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Buscar Perfil</h3>
                            <div class="relative">
                                <input type="text" id="pin-search-input" placeholder="Ingrese nombre del cliente..."
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <div id="pin-search-result" class="mt-4 space-y-2 hidden max-h-48 overflow-y-auto">
                                <!-- Result will be injected here -->
                            </div>
                        </div>

                        <!-- Available Accounts -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg tilt-card">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Perfiles Disponibles</h3>
                            <div id="available-accounts-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                <p class="text-gray-500 col-span-full">Cargando disponibilidad...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Alerts and Quick Access -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg tilt-card">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Alertas de Vencimiento</h3>
                            <div id="alerts-section" class="space-y-3">
                                <!-- Alertas se cargarán aquí -->
                                <p class="text-gray-500">No hay vencimientos próximos.</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg tilt-card">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Alertas de Cuentas</h3>
                            <div id="platform-account-alerts-section" class="space-y-3">
                                <!-- Alertas de cuentas se cargarán aquí -->
                                <p class="text-gray-500">No hay cuentas por vencer.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cuentas View -->
                <div id="cuentas-view" class="view">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 md:mb-8 px-2 md:px-0">Cuentas</h1>
                    <div class="bg-white p-3 md:p-6 rounded-2xl shadow mb-8 max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-4 md:mb-6">
                            <h2 class="text-xl md:text-2xl font-semibold text-gray-700">Añadir Cuenta de Plataforma</h2>
                            <button id="toggle-add-account-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2 text-sm font-medium">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Nueva Cuenta
                            </button>
                        </div>
                        <div id="collapsible-accounts-content" class="mt-6 hidden transition-all duration-300 ease-in-out">
                            <form id="add-account-form" class="space-y-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-2">Plataforma</label>
                                    <div id="account-platform-buttons" class="flex flex-wrap gap-2"></div>
                                    <input type="hidden" id="account-platform" name="account-platform" required>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div>
                                        <label for="account-email"
                                            class="block text-sm font-medium text-gray-600 mb-2">Correo</label>
                                        <input type="text" id="account-email" name="account-email"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                    </div>
                                    <div class="relative">
                                        <label for="account-password"
                                            class="block text-sm font-medium text-gray-600 mb-2">Contraseña</label>
                                        <input type="password" id="account-password" name="account-password"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                        <button type="button"
                                            class="absolute inset-y-0 right-0 top-6 flex items-center px-3 text-gray-500"
                                            onclick="togglePasswordVisibility('account-password', this)">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        </button>
                                    </div>
                                    <div>
                                        <label for="enlace" class="block text-sm font-medium text-gray-600 mb-2">Enlace
                                            (Opcional)</label>
                                        <input type="text" id="enlace" name="enlace"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label for="fechaPago"
                                            class="block text-sm font-medium text-gray-600 mb-2">Fecha de pago</label>
                                        <input type="date" id="fechaPago" name="fechaPago"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                </div>
                                <div class="text-right">
                                    <button type="submit"
                                        class="bg-blue-600 w-full md:w-auto text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 transition">Añadir
                                        Cuenta</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div id="account-view-filters" class="max-w-7xl mx-auto mb-6 flex flex-wrap gap-2 justify-center md:justify-start"></div>
                    <div id="contenedor-cuentas-agrupadas" class="max-w-7xl mx-auto"></div>
                </div>

                <!-- Ventas View -->
                <div id="ventas-view" class="view hidden">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 md:mb-8 px-2 md:px-0">Ventas</h1>
                    <div class="bg-white p-3 md:p-6 rounded-2xl shadow-lg mb-8 max-w-5xl mx-auto">
                        <h2 class="text-xl md:text-2xl font-semibold text-gray-700 mb-4 md:mb-6">Añadir Nueva Venta</h2>
                        <form id="add-sale-form"
                            class="grid grid-cols-1 gap-4 md:grid-cols-2 md:gap-6 lg:grid-cols-3 xl:grid-cols-4">
                            <div><label for="cliente" class="block text-sm font-medium text-gray-600 mb-2">Nombre del
                                    Cliente</label><input type="text" id="cliente" name="cliente"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            <div>
                                <label for="celular" class="block text-sm font-medium text-gray-600 mb-2">Celular (WhatsApp)</label>
                                <input type="tel" id="celular" name="celular"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="999999999">
                            </div>
                            <div><label for="plataforma"
                                    class="block text-sm font-medium text-gray-600 mb-2">Plataforma</label><select
                                    id="plataforma" name="plataforma"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="" disabled selected>Cargando...</option>
                                </select></div>
                            <div id="otro-plataforma-container" class="hidden"><label for="otro-plataforma"
                                    class="block text-sm font-medium text-gray-600 mb-2">Especificar
                                    Plataforma</label><input type="text" id="otro-plataforma" name="otro-plataforma"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                            <div><label for="precio" class="block text-sm font-medium text-gray-600 mb-2">Precio Pagado
                                    (S/)</label><input type="number" id="precio" name="precio" min="0" step="0.01"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            <div><label for="inicioPlan" class="block text-sm font-medium text-gray-600 mb-2">Inicio del
                                    Plan</label><input type="date" id="inicioPlan" name="inicioPlan"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            <div><label for="diasPlan" class="block text-sm font-medium text-gray-600 mb-2">Nº
                                    Días</label><input type="number" id="diasPlan" name="diasPlan"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                            <div><label for="finPlan" class="block text-sm font-medium text-gray-600 mb-2">Fin del
                                    Plan</label><input type="date" id="finPlan" name="finPlan"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label for="platform-account"
                                    class="block text-sm font-medium text-gray-600 mb-2">Cuenta Madre</label>
                                <select id="platform-account" name="platform-account"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" required>
                                    <option value="">Seleccione una cuenta madre</option>
                                </select>
                            </div>
                            <div>
                                <label for="profile-select"
                                    class="block text-sm font-medium text-gray-600 mb-2">Perfil</label>
                                <select id="profile-select" name="profile-select"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-200" disabled
                                    required>
                                    <option value="">Selecciona una cuenta madre primero</option>
                                </select>
                            </div>
                            <div><label for="pin" class="block text-sm font-medium text-gray-600 mb-2">PIN</label><input
                                    type="text" id="pin" name="pin"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                            <div><label for="notas" class="block text-sm font-medium text-gray-600 mb-2">Notas
                                    Adicionales</label><input type="text" id="notas" name="notas"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                            <div>
                                <label for="metodoPago" class="block text-sm font-medium text-gray-600 mb-2">Método de
                                    Pago</label>
                                <select id="metodoPago" name="metodoPago"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" required>
                                    <option value="" disabled selected>Seleccione un método</option>
                                    <option value="BCP">BCP</option>
                                    <option value="Falta pagar">Falta pagar</option>
                                    <option value="Gratis">Gratis</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 lg:col-span-3 xl:col-span-4 text-right self-end flex flex-col md:flex-row gap-4 justify-end">
                                <button type="button" id="save-and-add-btn"
                                    style="background: linear-gradient(to right, #f97316, #dc2626);"
                                    class="text-white font-semibold px-6 py-3 rounded-lg hover:opacity-90 focus:outline-none focus:ring-4 focus:ring-orange-500 focus:ring-opacity-50 transition-transform transform hover:scale-105 w-full md:w-auto shadow-md">Guardar
                                    y Agregar Otra</button>
                                <button type="submit"
                                    class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition-transform transform hover:scale-105 w-full md:w-auto shadow-md">Guardar
                                    Venta</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-lg mb-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="relative flex-grow w-full md:col-span-1"><input type="text" id="search-input"
                                    placeholder="Buscar por cliente, plataforma o correo..."
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"><svg
                                    class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg></div>
                            <div>
                                <select id="account-filter"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="">Filtrar por cuenta...</option>
                                </select>
                            </div>
                            <div>
                                <select id="status-filter"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="">Filtrar por estado...</option>
                                    <option value="Activo">Activo</option>
                                    <option value="Próximo a Vencer">Próximo a Vencer</option>
                                    <option value="Vence hoy">Vence hoy</option>
                                    <option value="Vencido">Vencido</option>
                                </select>
                            </div>
                        </div>
                        <div id="platform-filters" class="flex flex-wrap justify-center gap-3 sm:gap-4 mb-4"></div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4">
                        <div
                            class="hidden md:grid grid-cols-8 gap-4 font-semibold text-gray-600 border-b pb-3 mb-3 text-sm">
                            <div class="col-span-2">Cliente</div>
                            <div>Plataforma</div>
                            <div>Vencimiento</div>
                            <div>Estado</div>
                            <div>Precio</div>
                            <div>Método de Pago</div>
                            <div class="text-right">Acciones</div>
                        </div>
                        <div id="sales-list" class="space-y-2"></div>
                    </div>
                    <div id="loading-state" class="text-center py-10">
                        <p class="text-gray-500">Cargando ventas...</p>
                    </div>
                    <div id="empty-state" class="hidden text-center py-20 bg-white rounded-2xl shadow-lg"><svg
                            class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                        </svg>
                        <h3 class="mt-2 text-xl font-medium text-gray-900">No hay ventas registradas</h3>
                        <p class="mt-1 text-sm text-gray-500">Comienza añadiendo una nueva venta.</p>
                    </div>
                </div>

                <!-- Finanzas View -->
                <div id="finanzas-view" class="view hidden max-w-7xl mx-auto">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 md:mb-8 px-2 md:px-0">Finanzas</h1>
                    <!-- Financial Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Total Ingresos -->
                        <div id="total-ingresos-card"
                            class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 rounded-2xl shadow-lg flex items-center">
                            <div id="total-ingresos-icon-bg" class="p-4 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                    class="w-8 h-8 text-white">
                                    <path fill-rule="evenodd"
                                        d="M15.22 6.268a.75.75 0 0 1 .968-.432l5.942 2.28a.75.75 0 0 1 .431.97l-2.28 5.94a.75.75 0 1 1-1.4-.537l1.63-4.251-1.086.484a11.2 11.2 0 0 0-5.45 5.173.75.75 0 0 1-1.199.19L9 12.312l-6.22 6.22a.75.75 0 0 1-1.06-1.06l6.75-6.75a.75.75 0 0 1 1.06 0l3.606 3.606a12.7 12.7 0 0 1 5.68-4.974l1.086-.483-4.251-1.632a.75.75 0 0 1-.432-.97Z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 id="total-ingresos-text" class="text-sm font-medium text-white">Ingresos Totales
                                </h3>
                                <p id="total-ingresos" class="text-2xl font-bold text-white">S/0.00</p>
                            </div>
                        </div>
                        <!-- Total Egresos -->
                        <div id="total-egresos-card"
                            class="bg-gradient-to-r from-red-500 to-orange-500 p-6 rounded-2xl shadow-lg flex items-center">
                            <div id="total-egresos-icon-bg" class="p-4 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                    class="w-8 h-8 text-white">
                                    <path fill-rule="evenodd"
                                        d="M1.72 5.47a.75.75 0 0 1 1.06 0L9 11.69l3.756-3.756a.75.75 0 0 1 .984-.067 12.693 12.693 0 0 1 4.575 6.832l.308 1.149 2.277-3.943a.75.75 0 1 1 1.3.75l-3.182 5.51a.75.75 0 0 1-1.025.275l-5.511-3.182a.75.75 0 0 1 .75-1.3l3.943 2.277-.308-1.149a11.194 11.194 0 0 0-3.528-5.617l-3.81 3.81a.75.75 0 0 1-1.06 0L1.72 6.53a.75.75 0 0 1 0-1.061Z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 id="total-egresos-text" class="text-sm font-medium text-white">Egresos Totales</h3>
                                <p id="total-egresos" class="text-2xl font-bold text-white">S/0.00</p>
                            </div>
                        </div>
                        <!-- Balance General -->
                        <div id="balance-total-card"
                            class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6 rounded-2xl shadow-lg flex items-center">
                            <div id="balance-total-icon-bg" class="p-4 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-white">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 id="balance-total-text" class="text-sm font-medium text-white">Balance General</h3>
                                <p id="balance-total" class="text-2xl font-bold text-white">S/0.00</p>
                            </div>
                        </div>
                    </div>

                    <!-- Add Expense, Recent Income, and Recent Expenses -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Add Expense Form -->
                        <div class="lg:col-span-1">
                            <div class="bg-white p-6 rounded-2xl shadow-lg h-full">
                                <h3 class="text-xl font-semibold text-gray-700 mb-6">Añadir Egreso</h3>
                                <form id="add-expense-form" class="space-y-6">
                                    <div>
                                        <label for="expense-description"
                                            class="block text-sm font-medium text-gray-600 mb-2">Descripción</label>
                                        <input type="text" id="expense-description" name="expense-description"
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                            placeholder="Ej: Pago de internet" required>
                                    </div>
                                    <div>
                                        <label for="expense-amount"
                                            class="block text-sm font-medium text-gray-600 mb-2">Monto (S/)</label>
                                        <input type="number" id="expense-amount" name="expense-amount" min="0"
                                            step="0.01"
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                            placeholder="Ej: 50.00" required>
                                    </div>
                                    <div>
                                        <label for="expense-date"
                                            class="block text-sm font-medium text-gray-600 mb-2">Fecha</label>
                                        <input type="date" id="expense-date" name="expense-date"
                                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                            required>
                                    </div>
                                    <button type="submit"
                                        class="w-full bg-gradient-to-r from-red-500 to-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:from-red-600 hover:to-orange-600 transition-all duration-300 transform hover:scale-105 shadow-md">Añadir
                                        Gasto</button>
                                </form>
                            </div>
                        </div>

                        <!-- Recent Income List -->
                        <div class="lg:col-span-1">
                            <div class="bg-white p-6 rounded-2xl shadow-lg h-full">
                                <h3 class="text-xl font-semibold text-gray-700 mb-6">Últimos Ingresos</h3>
                                <div id="recent-income-list" class="space-y-4 pr-2 -mr-2 max-h-96 overflow-y-auto">
                                    <p class="text-gray-500">Cargando ingresos...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Expenses List -->
                        <div id="expenses-list-container" class="lg:col-span-1">
                            <div class="bg-white p-6 rounded-2xl shadow-lg h-full">
                                <h3 class="text-xl font-semibold text-gray-700 mb-6">Últimos Egresos</h3>
                                <div id="expenses-list" class="space-y-4 pr-2 -mr-2 max-h-96 overflow-y-auto">
                                    <p class="text-gray-500">No hay egresos registrados.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Precios View (Calculadora) -->
                <div id="precios-view" class="view hidden max-w-7xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 px-2 md:px-0">
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Calculadora de Precios</h1>
                        <div class="flex gap-4 mt-4 md:mt-0">
                            <button id="add-platform-btn"
                                class="flex items-center text-blue-600 hover:text-blue-800 transition font-medium">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Agregar Plataforma
                            </button>
                            <button id="toggle-config-btn"
                                class="flex items-center text-gray-600 hover:text-gray-900 transition">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                    </path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Configurar Costos
                            </button>
                        </div>
                    </div>

                    <!-- Config Panel -->
                    <div id="config-panel"
                        class="hidden bg-white p-6 rounded-2xl shadow-lg mb-8 border border-gray-200">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-700">Costos de Proveedor (Cuenta Completa)</h3>
                            <div class="mt-2 md:mt-0 bg-blue-50 border-l-4 border-blue-500 p-3 rounded text-sm text-blue-700 max-w-2xl" style="background-color: #eff6ff; border-left-width: 4px; border-color: #3b82f6; color: #1d4ed8;">
                                <p class="font-bold flex items-center"><svg class="w-4 h-4 mr-1" style="width: 16px; height: 16px; margin-right: 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Cómo funciona:</p>
                                <p>El sistema sugiere un precio de venta para asegurar una ganancia mínima de <strong>S/15.00</strong> por Cuenta Madre. <br>
                                <span class="text-xs opacity-80">Fórmula: (Precio Venta × Perfiles) - Costo Cuenta = Ganancia Estimada</span></p>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Plataforma</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Costo Cuenta</th>
                                        <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider" title="Perfiles por cuenta">Perfiles</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Costo Unit.</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Precio Venta</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Ganancia Est.</th>
                                    </tr>
                                </thead>
                                <tbody id="cost-inputs-grid" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows injected via JS -->
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-6 flex justify-end">
                            <button id="save-costs-btn"
                                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 shadow-md font-medium transition transform hover:scale-105">Guardar
                                Costos</button>
                        </div>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-8">
                        <!-- Main Area: Duration & Services -->
                        <div class="flex-grow">
                            <!-- Duration Selector -->
                            <div
                                class="bg-white p-4 rounded-2xl shadow-sm mb-6 flex flex-wrap gap-4 items-center justify-center md:justify-start">
                                <span class="font-medium text-gray-600 mr-2">Duración:</span>
                                <div id="duration-buttons" class="flex gap-2">
                                    <!-- Buttons injected via JS -->
                                </div>
                            </div>

                            <!-- Services Grid -->
                            <div id="services-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
                                <!-- Service Cards injected via JS -->
                            </div>
                        </div>

                        <!-- Results Ticket -->
                        <div class="w-full lg:w-80 flex-shrink-0">
                            <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200 sticky top-4">
                                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Resumen</h2>
                                <div id="ticket-items" class="space-y-2 mb-4 text-sm">
                                    <p class="text-gray-400 italic">Selecciona servicios...</p>
                                </div>

                                <div class="space-y-2 pt-4 border-t border-dashed border-gray-300">
                                    <div class="flex justify-between text-gray-500">
                                        <span>Precio Regular</span>
                                        <span id="ticket-regular-price">S/0.00</span>
                                    </div>
                                    <div class="flex justify-between text-green-600 font-medium">
                                        <span>Descuento Combo</span>
                                        <span id="ticket-discount-amount">-S/0.00</span>
                                    </div>
                                    <div class="flex justify-between items-end mt-2">
                                        <span class="font-bold text-gray-800 text-lg">TOTAL</span>
                                        <span id="ticket-final-price"
                                            class="font-black text-3xl text-indigo-600">S/0.00</span>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                                        <span>Ganancia Neta</span>
                                        <span id="ticket-profit">S/0.00</span>
                                    </div>
                                </div>

                                <button id="copy-promo-btn"
                                    class="w-full mt-6 bg-green-500 text-white font-bold py-3 rounded-xl hover:bg-green-600 transition flex items-center justify-center shadow-lg transform active:scale-95">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3">
                                        </path>
                                    </svg>
                                    Copiar Promo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div id="confirmation-modal"
        class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 text-center">
            <h2 id="confirmation-title" class="text-2xl font-bold text-gray-800 mb-4">Confirmar Acción</h2>
            <p id="confirmation-message" class="text-gray-600 mb-8">¿Estás seguro de que quieres continuar?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-confirmation-btn"
                    class="bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-300 transition w-full md:w-auto">
                    Cancelar
                </button>
                <button id="confirm-action-btn"
                    class="bg-red-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-red-700 transition w-full md:w-auto">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <div id="edit-modal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-4xl rounded-2xl shadow-2xl p-6 transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">Editar Venta</h2><button id="close-modal"
                    class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg></button>
            </div>
            <form id="edit-sale-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <input type="hidden" id="edit-sale-id" name="edit-sale-id">
                <div><label for="edit-cliente" class="block text-sm font-medium text-gray-600 mb-2">Nombre del
                        Cliente</label><input type="text" id="edit-cliente" name="edit-cliente"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                <div>
                    <label for="edit-celular" class="block text-sm font-medium text-gray-600 mb-2">Celular
                        (WhatsApp)</label>
                    <input type="tel" id="edit-celular" name="edit-celular"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="999999999">
                </div>
                <div><label for="edit-plataforma"
                        class="block text-sm font-medium text-gray-600 mb-2">Plataforma</label><select
                        id="edit-plataforma" name="edit-plataforma"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                        <option value="" disabled selected>Cargando...</option>
                    </select></div>
                <div id="edit-otro-plataforma-container" class="hidden"><label for="edit-otro-plataforma"
                        class="block text-sm font-medium text-gray-600 mb-2">Especificar Plataforma</label><input
                        type="text" id="edit-otro-plataforma" name="edit-otro-plataforma"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                <div><label for="edit-precio" class="block text-sm font-medium text-gray-600 mb-2">Precio Pagado
                        (S/)</label><input type="number" id="edit-precio" name="edit-precio" min="0" step="0.01"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                <div><label for="edit-inicioPlan" class="block text-sm font-medium text-gray-600 mb-2">Inicio del
                        Plan</label><input type="date" id="edit-inicioPlan" name="edit-inicioPlan"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                <div>
                    <label for="edit-finPlan" class="block text-sm font-medium text-gray-600 mb-2">Fin del Plan</label>
                    <input type="date" id="edit-finPlan" name="edit-finPlan"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" required>
                </div>
                <div>
                    <label for="edit-platform-account" class="block text-sm font-medium text-gray-600 mb-2">Cuenta
                        Madre</label>
                    <select id="edit-platform-account" name="edit-platform-account"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                        <option value="">Sin cuenta / Ingresar manualmente</option>
                    </select>
                </div>
                <div>
                    <label for="edit-profile-select" class="block text-sm font-medium text-gray-600 mb-2">Perfil</label>
                    <select id="edit-profile-select" name="edit-profile-select"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                        <option value="">Selecciona un perfil</option>
                    </select>
                </div>
                <div><label for="edit-pin" class="block text-sm font-medium text-gray-600 mb-2">PIN</label><input
                        type="text" id="edit-pin" name="edit-pin"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                <div>
                    <label for="edit-metodoPago" class="block text-sm font-medium text-gray-600 mb-2">Método de
                        Pago</label>
                    <select id="edit-metodoPago" name="edit-metodoPago"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" required>
                        <option value="BCP">BCP</option>
                        <option value="Falta pagar">Falta pagar</option>
                        <option value="Gratis">Gratis</option>
                    </select>
                </div>
                <div class="lg:col-span-1 md:col-span-1"><label for="edit-notas"
                        class="block text-sm font-medium text-gray-600 mb-2">Notas Adicionales</label><input type="text"
                        id="edit-notas" name="edit-notas" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <div class="lg:col-span-3 md:col-span-2 flex justify-end gap-4 mt-4"><button type="button"
                        id="cancel-edit"
                        class="bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-300 transition">Cancelar</button><button
                        type="submit"
                        class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700">Guardar
                        Cambios</button></div>
            </form>
        </div>
    </div>
    <div id="maintenance-modal"
        class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-4xl rounded-2xl shadow-2xl p-6 transform scale-95 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h2 class="text-2xl font-semibold text-gray-700">Clientes en Mantenimiento</h2>
                <button id="close-maintenance-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="overflow-y-auto flex-grow">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="maintenance-list">
                    <!-- Items injected via JS -->
                </div>
            </div>
        </div>
    </div>

    <div id="archive-delete-modal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-lg rounded-2xl shadow-2xl p-8 transform scale-95 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">¿Qué deseas hacer con esta venta?</h2>
            <p class="text-gray-600 mb-8">Elige una opción según si la venta se concretó o fue un error.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Archivar</h3>
                    <p class="text-sm text-gray-500 mb-6">La venta fue real y el dinero se recibió, pero la suscripción
                        ya terminó. La venta desaparecerá de la lista principal pero se contará en el resumen
                        financiero.</p>
                    <button id="archive-btn"
                        class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition">
                        Archivar Venta
                    </button>
                </div>

                <div class="border border-red-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                    <h3 class="text-xl font-semibold text-red-700 mb-2">Eliminar Permanentemente</h3>
                    <p class="text-sm text-gray-500 mb-6">Solo si registraste esta venta por error y nunca recibiste el
                        dinero. Se borrará para siempre y no se contará en el resumen financiero.</p>
                    <button id="delete-permanently-btn"
                        class="w-full bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700 transition">
                        Eliminar Permanentemente
                    </button>
                </div>
            </div>

            <div class="mt-8">
                <button id="cancel-action-btn" class="text-gray-500 hover:text-gray-700 font-medium">Cancelar</button>
            </div>
        </div>
    </div>
    <!-- Edit Account Modal -->
    <div id="edit-account-modal"
        class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">Editar Cuenta de Plataforma</h2>
                <button id="close-edit-account-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <form id="edit-account-form" class="space-y-6">
                <input type="hidden" id="edit-account-id">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">Plataforma</label>
                    <select id="edit-account-platform"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-account-email"
                            class="block text-sm font-medium text-gray-600 mb-2">Correo</label>
                        <input type="text" id="edit-account-email"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="relative">
                        <label for="edit-account-password"
                            class="block text-sm font-medium text-gray-600 mb-2">Contraseña</label>
                        <input type="password" id="edit-account-password"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                            placeholder="Dejar en blanco para no cambiar">
                        <button type="button"
                            class="absolute inset-y-0 right-0 top-6 flex items-center px-3 text-gray-500"
                            onclick="togglePasswordVisibility('edit-account-password', this)">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-account-enlace" class="block text-sm font-medium text-gray-600 mb-2">Enlace
                            (Opcional)</label>
                        <input type="text" id="edit-account-enlace"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="edit-account-fechaPago" class="block text-sm font-medium text-gray-600 mb-2">Fecha
                            de pago</label>
                        <input type="date" id="edit-account-fechaPago"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" id="cancel-edit-account"
                        class="bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit"
                        class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700">Guardar
                        Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="renewal-modal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">Renovar Suscripción</h2>
            <form id="renewal-form">
                <input type="hidden" id="renewal-sale-id">
                <div class="space-y-4">
                    <div>
                        <label for="renewal-days" class="block text-sm font-medium text-gray-600 mb-2">Días a
                            renovar</label>
                        <input type="number" id="renewal-days"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="renewal-amount" class="block text-sm font-medium text-gray-600 mb-2">Monto de
                            renovación (S/)</label>
                        <input type="number" id="renewal-amount" step="0.01"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-renewal-btn"
                        class="bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit"
                        class="bg-green-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-green-700 transition">Confirmar
                        Renovación</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Custom Service Modal -->
    <div id="add-custom-service-modal"
        class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">Agregar Nueva Plataforma</h2>
                <button id="close-add-service-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <form id="add-custom-service-form" class="space-y-4">
                <div>
                    <label for="custom-name" class="block text-sm font-medium text-gray-600 mb-2">Nombre de
                        Plataforma</label>
                    <input type="text" id="custom-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                        placeholder="Ej. Star+" required>
                </div>
                <div>
                    <label for="custom-color" class="block text-sm font-medium text-gray-600 mb-2">Color de
                        Fondo</label>
                    <div class="flex items-center gap-4">
                        <input type="color" id="custom-color"
                            class="w-12 h-12 p-1 border border-gray-300 rounded cursor-pointer" value="#3b82f6">
                        <span id="custom-color-hex" class="text-gray-500 text-sm">#3B82F6</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="custom-cost" class="block text-sm font-medium text-gray-600 mb-2">Costo Cuenta
                            (S/)</label>
                        <input type="number" id="custom-cost" step="0.01" min="0"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="custom-divider" class="block text-sm font-medium text-gray-600 mb-2">Perfiles</label>
                        <input type="number" id="custom-divider" step="1" min="1"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="5" required>
                    </div>
                </div>
                <div>
                    <label for="custom-price" class="block text-sm font-medium text-gray-600 mb-2">Precio Sugerido
                        (S/)</label>
                    <input type="number" id="custom-price" step="0.01" min="0"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" id="cancel-add-service-btn"
                        class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit"
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Profiles Modal -->
    <div id="manage-profiles-modal"
        class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-700">Gestionar Perfiles</h2>
                    <p id="profiles-modal-account-email" class="text-sm text-gray-500"></p>
                </div>
                <button id="close-profiles-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div id="profiles-content-area">
                <!-- Profile list or creation button will be injected here by JS -->
            </div>
        </div>
    </div>

    <!-- Success Sale Modal -->
    <div id="success-sale-modal"
        class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-all">
            <!-- Header -->
            <div id="modal-header-bg" class="bg-gray-800 p-6 text-center transition-colors duration-300">
                <h2 id="modal-platform-name" class="text-2xl font-bold text-white">Plataforma</h2>
            </div>

            <!-- Body -->
            <div class="p-6 space-y-4">

                <!-- Credential Box -->
                <div class="bg-gray-50 rounded-xl p-4 border border-gray-100 space-y-3">
                    <div class="flex items-center group">
                        <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-5 flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        </div>
                        <div class="flex-grow min-w-0 mr-2">
                            <p class="text-xs text-gray-500 uppercase font-semibold">Correo</p>
                            <p id="modal-email" class="text-gray-800 font-medium select-all truncate">correo@ejemplo.com</p>
                        </div>
                        <button class="copy-field-btn ml-3 px-3 py-1.5 border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 hover:text-indigo-600 rounded-lg shadow-sm transition-all flex items-center gap-2 text-xs font-medium" data-target="modal-email" title="Copiar Correo">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                            <span>Copiar</span>
                        </button>
                    </div>

                    <div class="flex items-center group">
                        <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center mr-5 flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        </div>
                        <div class="flex-grow min-w-0 mr-2">
                            <p class="text-xs text-gray-500 uppercase font-semibold">Contraseña</p>
                            <p id="modal-password" class="text-gray-800 font-medium select-all truncate">********</p>
                        </div>
                        <button class="copy-field-btn ml-3 px-3 py-1.5 border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 hover:text-purple-600 rounded-lg shadow-sm transition-all flex items-center gap-2 text-xs font-medium" data-target="modal-password" title="Copiar Contraseña">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                             <span>Copiar</span>
                        </button>
                    </div>
                </div>

                <!-- Info Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-100" id="modal-profile-container">
                         <p class="text-xs text-gray-500 uppercase font-semibold mb-1">Perfil</p>
                         <div class="flex items-center gap-2">
                             <span id="modal-profile" class="font-bold text-gray-700 text-sm truncate">Perfil 1</span>
                         </div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-100" id="modal-pin-container">
                         <p class="text-xs text-gray-500 uppercase font-semibold mb-1">PIN</p>
                         <div class="flex items-center gap-2">
                             <span id="modal-pin" class="font-bold text-gray-700 text-sm">----</span>
                         </div>
                    </div>
                </div>

                <!-- Footer Text -->
                <p class="text-xs text-center text-gray-400">
                    ⚠️ Cuenta para 1 dispositivo. No compartir.
                </p>

            </div>

            <!-- Footer Actions -->
            <div class="p-4 bg-gray-50 border-t border-gray-100 flex flex-col sm:flex-row gap-3">
                <a id="modal-open-link-btn" href="#" target="_blank" class="hidden flex-1 py-3 bg-blue-50 text-blue-600 font-semibold rounded-xl hover:bg-blue-100 transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    Abrir Enlace
                </a>
                <button id="copy-sale-message-btn" class="flex-1 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 shadow-md transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    Copiar Datos
                </button>
            </div>
        </div>
    </div>

    <script>
        function togglePasswordVisibility(inputId, button) { const input = document.getElementById(inputId), icon = button.querySelector('svg'); if (input.type === "password") { input.type = "text"; icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .946-3.11 3.563-5.522 6.837-6.141M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.581 10.41A7.48 7.48 0 0119.542 12c-1.274 4.057-5.064 7-9.542 7a10.046 10.046 0 01-3.132-.475M2.458 12c.946-3.11 3.563-5.522 6.837-6.141m1.581 2.318A4.5 4.5 0 0115 12a4.5 4.5 0 01-1.07 2.828M5 5l14 14" />`; } else { input.type = "password"; icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />`; } }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('hidden');
        }
    </script>

    <script type="module">
        import { collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDocs, setDoc, getDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { db, auth } from "./firebase-config.js";

        let currentSeller = '';

        async function startApp() {
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('logout-btn').addEventListener('click', () => { signOut(auth).catch((error) => console.error("Error al cerrar sesión", error)); });

            dayjs.extend(dayjs_plugin_relativeTime);
            dayjs.locale('es');
            const platformStyles = {
                'Netflix': { color: 'text-red-600', bg: '#E50914', logo: 'https://logo.clearbit.com/netflix.com' },
                'Spotify': { color: 'text-green-500', bg: '#1DB954', logo: 'https://logo.clearbit.com/spotify.com' },
                'Disney+': { color: 'text-blue-900', bg: '#01153E', logo: 'https://logo.clearbit.com/disneyplus.com' },
                'HBO Max Estándar': { color: 'text-purple-600', bg: '#8A2BE2', logo: 'https://logo.clearbit.com/hbomax.com' },
                'HBO Max Platinium': { color: 'text-blue-900', bg: '#1e3a8a', bgGradient: 'linear-gradient(to right, #000428, #004e92)', logo: 'https://logo.clearbit.com/hbomax.com' },
                'Amazon Prime Video': { color: 'text-blue-400', bg: '#00A8E1', logo: 'https://logo.clearbit.com/primevideo.com' },
                'YouTube Premium': { color: 'text-red-500', bg: '#FF0000', logo: 'https://logo.clearbit.com/youtube.com' },
                'Apple TV+': { color: 'text-gray-800', bg: '#000000', logo: 'https://logo.clearbit.com/tv.apple.com' },
                'Crunchyroll': { color: 'text-orange-500', bg: '#F47521', logo: 'https://logo.clearbit.com/crunchyroll.com' },
                'Canva': { color: 'text-purple-500', bg: '#8D44AD', logo: 'https://logo.clearbit.com/canva.com' },
                'IPTV Premium': { color: 'text-teal-500', bg: '#00AEEF', logo: 'https://cdn-icons-png.flaticon.com/512/2989/2989835.png' },
                'Vix+': { color: 'text-yellow-400', bg: '#F8C100', logo: 'https://logo.clearbit.com/vix.com' },
                'Paramount+': { color: 'text-blue-800', bg: '#0064FF', logo: 'https://logo.clearbit.com/paramountplus.com' },
                'Otro': { color: 'text-gray-500', bg: '#6B7280', logo: '' }
            };
            platformStyles['HBO Max'] = platformStyles['HBO Max Estándar'];

            const defaultServices = [
                { id: 'netflix', name: 'Netflix', cost: 38.00, price: 12.00, type: 'monthly', divider: 5, logo: 'https://upload.wikimedia.org/wikipedia/commons/0/08/Netflix_2015_logo.svg', color: '#E50914' },
                { id: 'disney', name: 'Disney+', cost: 18.00, price: 8.00, type: 'monthly', divider: 5, logo: 'https://upload.wikimedia.org/wikipedia/commons/3/3e/Disney%2B_logo.svg', color: '#01153E' },
                { id: 'max_plat', name: 'HBO Max Platinium', cost: 17.00, price: 8.00, type: 'monthly', divider: 5, logo: 'https://upload.wikimedia.org/wikipedia/commons/c/ce/Max_logo.svg', color: '#1e3a8a', bgGradient: 'linear-gradient(to right, #000428, #004e92)' },
                { id: 'max_bas', name: 'HBO Max Estándar', cost: 10.20, price: 6.00, type: 'monthly', divider: 5, label: 'Estándar', logo: 'https://upload.wikimedia.org/wikipedia/commons/c/ce/Max_logo.svg', color: '#8A2BE2' },
                { id: 'prime', name: 'Amazon Prime', cost: 11.00, price: 6.00, type: 'monthly', divider: 5, logo: 'https://upload.wikimedia.org/wikipedia/commons/1/11/Amazon_Prime_Video_logo.svg', color: '#00A8E1' },
                { id: 'plex', name: 'Plex', cost: 14.00, price: 9.00, type: 'monthly', divider: 4, logo: 'https://upload.wikimedia.org/wikipedia/commons/7/7b/Plex_logo_2022.svg', color: '#e5a00d' },
                { id: 'paramount', name: 'Paramount+', cost: 8.50, price: 6.00, type: 'monthly', divider: 5, logo: 'https://upload.wikimedia.org/wikipedia/commons/a/a5/Paramount_Plus.svg', color: '#0064FF' },
                { id: 'crunchy', name: 'Crunchyroll', cost: 7.50, price: 5.00, type: 'monthly', divider: 5, logo: 'https://upload.wikimedia.org/wikipedia/commons/0/08/Crunchyroll_Logo.png', color: '#F47521' },
                { id: 'vix', name: 'Vix+', cost: 8.20, price: 6.00, type: 'monthly', divider: 5, logo: 'https://upload.wikimedia.org/wikipedia/commons/b/b6/ViX_logo_2022.svg', color: '#F8C100' },
                { id: 'universal', name: 'Universal+', cost: 7.50, price: 6.00, type: 'monthly', divider: 5, logo: 'https://upload.wikimedia.org/wikipedia/commons/2/2d/Universal_Pictures_Logo.svg', color: '#000000' },
                { id: 'canva', name: 'Canva Pro', cost: 8.00, price: 8.00, type: 'annual', divider: 1, logo: 'https://upload.wikimedia.org/wikipedia/commons/0/08/Canva_icon_2021.svg', color: '#8D44AD' }
            ];

            let allServices = [...defaultServices];
            let allSales = [], allExpenses = [], allPlatformAccounts = [], activePlatformFilter = 'Todos', currentSearchTerm = '', activeAccountFilter = '', activeStatusFilter = '';
            let activeAccountViewFilter = 'Todos';
            let selectedServices = new Map(), selectedMonths = 1;
            let platformOrder = [];

            // Cargar configuración y servicios personalizados
            const loadCustomServices = async () => {
                try {
                    // 1. Reset to defaults
                    allServices = [...defaultServices];

                    // 2. Load Custom Services
                    const customServicesDoc = await getDoc(doc(db, "config", "custom_services"));
                    if (customServicesDoc.exists()) {
                        const customServices = customServicesDoc.data().services || [];
                        allServices = [...allServices, ...customServices];

                        // Merge into platformStyles
                        customServices.forEach(s => {
                            if (!platformStyles[s.name]) {
                                platformStyles[s.name] = {
                                    color: 'text-gray-800', // Default, handled by inline style in getPlatformHtml
                                    bg: s.color,
                                    logo: '',
                                    isCustom: true
                                };
                            }
                        });
                    }

                    // 3. Load Price Overrides
                    const configDoc = await getDoc(doc(db, "config", "service_prices"));
                    if (configDoc.exists()) {
                        const data = configDoc.data();
                        allServices.forEach(s => {
                            if (data[s.id]) {
                                s.cost = data[s.id].cost !== undefined ? data[s.id].cost : s.cost;
                                s.price = data[s.id].price !== undefined ? data[s.id].price : s.price;
                            }
                        });
                    }
                } catch (error) {
                    console.error("Error cargando configuración de precios:", error);
                }
            };
            await loadCustomServices();
            renderPlatformSelects();

            const selectors = {
                addSaleForm: document.getElementById('add-sale-form'),
                salesList: document.getElementById('sales-list'),
                searchInput: document.getElementById('search-input'),
                loadingState: document.getElementById('loading-state'),
                emptyState: document.getElementById('empty-state'),
                editModal: document.getElementById('edit-modal'),
                editForm: document.getElementById('edit-sale-form'),
                closeModalBtn: document.getElementById('close-modal'),
                cancelEditBtn: document.getElementById('cancel-edit'),
                plataformaSelect: document.getElementById('plataforma'),
                otroPlataformaContainer: document.getElementById('otro-plataforma-container'),
                otroPlataformaInput: document.getElementById('otro-plataforma'),
                editPlataformaSelect: document.getElementById('edit-plataforma'),
                editOtroPlataformaContainer: document.getElementById('edit-otro-plataforma-container'),
                editOtroPlataformaInput: document.getElementById('edit-otro-plataforma'),
                platformFilters: document.getElementById('platform-filters'),
                totalIngresos: document.getElementById('total-ingresos'),
                totalEgresos: document.getElementById('total-egresos'),
                balanceTotal: document.getElementById('balance-total'),
                addExpenseForm: document.getElementById('add-expense-form'),
                expensesList: document.getElementById('expenses-list'),
                recentIncomeList: document.getElementById('recent-income-list'),
                addAccountForm: document.getElementById('add-account-form'),
                accountsList: document.getElementById('contenedor-cuentas-agrupadas'),
                platformAccountSelect: document.getElementById('platform-account'),
                editPlatformAccountSelect: document.getElementById('edit-platform-account'),
                accountFilter: document.getElementById('account-filter'),
                statusFilter: document.getElementById('status-filter'),
                profileSelect: document.getElementById('profile-select'),
                editProfileSelect: document.getElementById('edit-profile-select'),
                accountPlatformButtons: document.getElementById('account-platform-buttons'),
                editAccountModal: document.getElementById('edit-account-modal'),
                editAccountForm: document.getElementById('edit-account-form'),
                closeEditAccountModalBtn: document.getElementById('close-edit-account-modal'),
                cancelEditAccountBtn: document.getElementById('cancel-edit-account'),
                kpiSalesToday: document.getElementById('kpi-sales-today'),
                kpiSalesMonth: document.getElementById('kpi-sales-month'),
                kpiActiveClients: document.getElementById('kpi-active-clients'),
                alertsSection: document.getElementById('alerts-section'),
                platformAccountAlertsSection: document.getElementById('platform-account-alerts-section'),
                manageProfilesModal: document.getElementById('manage-profiles-modal'),
                closeProfilesModalBtn: document.getElementById('close-profiles-modal'),
                profilesContentArea: document.getElementById('profiles-content-area'),
                profilesModalAccountEmail: document.getElementById('profiles-modal-account-email'),
                // Precios View Selectors
                preciosView: document.getElementById('precios-view'),
                toggleConfigBtn: document.getElementById('toggle-config-btn'),
                configPanel: document.getElementById('config-panel'),
                costInputsGrid: document.getElementById('cost-inputs-grid'),
                saveCostsBtn: document.getElementById('save-costs-btn'),
                durationButtons: document.getElementById('duration-buttons'),
                servicesGrid: document.getElementById('services-grid'),
                ticketItems: document.getElementById('ticket-items'),
                ticketRegularPrice: document.getElementById('ticket-regular-price'),
                ticketDiscountAmount: document.getElementById('ticket-discount-amount'),
                ticketFinalPrice: document.getElementById('ticket-final-price'),
                ticketProfit: document.getElementById('ticket-profit'),
                copyPromoBtn: document.getElementById('copy-promo-btn'),
                // New Selectors for Custom Services
                addPlatformBtn: document.getElementById('add-platform-btn'),
                addCustomServiceModal: document.getElementById('add-custom-service-modal'),
                closeAddServiceModalBtn: document.getElementById('close-add-service-modal'),
                cancelAddServiceBtn: document.getElementById('cancel-add-service-btn'),
                addCustomServiceForm: document.getElementById('add-custom-service-form'),
                customColorInput: document.getElementById('custom-color'),
                customColorHex: document.getElementById('custom-color-hex'),
                successSaleModal: document.getElementById('success-sale-modal'),
                copySaleMessageBtn: document.getElementById('copy-sale-message-btn'),
                // New Selectors for PIN Search and Available Accounts
                pinSearchInput: document.getElementById('pin-search-input'),
                pinSearchResult: document.getElementById('pin-search-result'),
                availableAccountsGrid: document.getElementById('available-accounts-grid'),
                accountViewFilters: document.getElementById('account-view-filters'),
                toggleAddAccountBtn: document.getElementById('toggle-add-account-btn'),
                collapsibleAccountsContent: document.getElementById('collapsible-accounts-content'),
                maintenanceModal: document.getElementById('maintenance-modal'),
                closeMaintenanceModalBtn: document.getElementById('close-maintenance-modal'),
                maintenanceList: document.getElementById('maintenance-list'),
                editSaleStatus: document.getElementById('edit-sale-status') || (() => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.id = 'edit-sale-status';
                    input.name = 'edit-sale-status';
                    document.getElementById('edit-sale-form').appendChild(input);
                    return input;
                })(), // Ensure hidden input exists
            };

            selectors.toggleAddAccountBtn.addEventListener('click', () => {
                const content = selectors.collapsibleAccountsContent;
                const isHidden = content.classList.contains('hidden');

                if (isHidden) {
                    content.classList.remove('hidden');
                    selectors.toggleAddAccountBtn.innerHTML = `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Cancelar
                    `;
                    selectors.toggleAddAccountBtn.classList.replace('bg-indigo-600', 'bg-red-500');
                    selectors.toggleAddAccountBtn.classList.replace('hover:bg-indigo-700', 'hover:bg-red-600');
                } else {
                    content.classList.add('hidden');
                    selectors.toggleAddAccountBtn.innerHTML = `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Nueva Cuenta
                    `;
                    selectors.toggleAddAccountBtn.classList.replace('bg-red-500', 'bg-indigo-600');
                    selectors.toggleAddAccountBtn.classList.replace('hover:bg-red-600', 'hover:bg-indigo-700');
                }
            });

            const renderAccountViewFilters = () => {
                selectors.accountViewFilters.innerHTML = '';

                // Get unique platforms from existing accounts
                const platforms = new Set(['Todos']);
                allPlatformAccounts.forEach(acc => platforms.add(acc.platform));

                // Convert to array and sort (Todos first)
                const sortedPlatforms = Array.from(platforms).sort((a, b) => {
                    if (a === 'Todos') return -1;
                    if (b === 'Todos') return 1;
                    return a.localeCompare(b);
                });

                sortedPlatforms.forEach(platform => {
                    const btn = document.createElement('button');
                    const style = platformStyles[platform] || platformStyles['Otro'];
                    const isSelected = activeAccountViewFilter === platform;

                    btn.className = `px-4 py-2 rounded-full font-bold text-sm transition-all duration-200 transform hover:scale-105 focus:outline-none shadow-sm flex items-center gap-2`;

                    if (isSelected) {
                        // Selected State: Solid Brand Color
                        if (style.bgGradient) {
                            btn.style.background = style.bgGradient;
                        } else {
                            btn.style.backgroundColor = style.bg;
                        }
                        btn.style.color = getContrastYIQ(style.bg);
                        btn.classList.add('ring-2', 'ring-offset-2', 'ring-indigo-200');
                    } else {
                        // Unselected State: White bg, Brand Color text/border
                        btn.style.backgroundColor = 'white';
                        btn.style.color = style.bg;
                        btn.style.border = `1px solid ${style.bg}`;
                        btn.classList.add('hover:shadow-md');
                    }

                    btn.textContent = platform;

                    btn.addEventListener('click', () => {
                        activeAccountViewFilter = platform;
                        renderAccountViewFilters(); // Re-render buttons to update state styles
                        renderPlatformAccounts(); // Re-render accounts list
                    });

                    selectors.accountViewFilters.appendChild(btn);
                });
            };

            const prefillSaleFromAvailable = (platformName) => {
                // 1. Switch to Sales View
                document.getElementById('nav-ventas').click();

                // 2. Reset Form
                selectors.addSaleForm.reset();
                selectors.addSaleForm.metodoPago.value = "";
                handlePlatformChange(selectors.plataformaSelect, selectors.otroPlataformaContainer, selectors.otroPlataformaInput);

                // 3. Set Platform
                selectors.plataformaSelect.value = platformName;
                handlePlatformChange(selectors.plataformaSelect, selectors.otroPlataformaContainer, selectors.otroPlataformaInput);
                populatePlatformAccountsDropdowns(platformName, selectors.platformAccountSelect);

                // 4. Find first account with available profiles
                const availableAccount = allPlatformAccounts.find(acc =>
                    (acc.platform === platformName) &&
                    acc.profiles &&
                    acc.profiles.some(p => p.estado === 'Disponible')
                );

                if (availableAccount) {
                    selectors.platformAccountSelect.value = availableAccount.id;

                    // 5. Trigger Account Change to populate profiles
                    handlePlatformAccountChange(selectors.platformAccountSelect, selectors.profileSelect);

                    // 6. Find first available profile
                    const availableProfile = availableAccount.profiles.find(p => p.estado === 'Disponible');
                    if (availableProfile) {
                        selectors.profileSelect.value = availableProfile.id;
                        selectors.profileSelect.dispatchEvent(new Event('change'));
                    }
                }
            };

            const renderAvailableAccounts = () => {
                const availability = {};

                // Initialize counts for all platforms to 0
                Object.keys(platformStyles).forEach(p => {
                    if (p !== 'Otro') availability[p] = 0;
                });

                allPlatformAccounts.forEach(account => {
                    if (account.platform === 'Canva') return; // Skip Canva as it doesn't have standard profile management

                    if (account.profiles && Array.isArray(account.profiles)) {
                        const availableCount = account.profiles.filter(p => p.estado === 'Disponible').length;
                        const platform = account.platform || 'Otro';
                        availability[platform] = (availability[platform] || 0) + availableCount;
                    }
                });

                selectors.availableAccountsGrid.innerHTML = '';

                // Sort platforms: Prioritize those with availability, then alphabetical
                const sortedPlatforms = Object.keys(availability).filter(p => availability[p] > 0).sort();

                if (sortedPlatforms.length === 0) {
                     selectors.availableAccountsGrid.innerHTML = '<p class="text-gray-500 col-span-full text-sm">No hay perfiles disponibles.</p>';
                     return;
                }

                sortedPlatforms.forEach(platform => {
                    const count = availability[platform];
                    const style = platformStyles[platform] || platformStyles['Otro'];
                    const bgColor = style.bg;
                    const textColor = getContrastYIQ(bgColor);

                    const btn = document.createElement('div');
                    // Styling: Card-like button, solid background
                    btn.className = 'flex items-center justify-between p-4 rounded-xl shadow-md cursor-pointer transition-all transform hover:scale-105 hover:shadow-lg active:scale-95';

                    if (style.bgGradient) {
                        btn.style.background = style.bgGradient;
                    } else {
                        btn.style.backgroundColor = bgColor;
                    }
                    btn.style.color = textColor;

                    // Badge color: White with brand text
                    const badgeBg = 'white';
                    const badgeText = bgColor;

                    btn.innerHTML = `
                        <span class="font-bold text-lg truncate mr-2">${platform}</span>
                        <span class="text-sm font-black px-3 py-1 rounded-full shadow-sm" style="background-color: ${badgeBg}; color: ${badgeText}">${count}</span>
                    `;

                    btn.onclick = () => prefillSaleFromAvailable(platform);

                    selectors.availableAccountsGrid.appendChild(btn);
                });
            };

            // Profile Search Logic
            selectors.pinSearchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase().trim();
                const resultContainer = selectors.pinSearchResult;
                resultContainer.innerHTML = '';

                if (term.length === 0) {
                    resultContainer.classList.add('hidden');
                    return;
                }

                const matches = allSales.filter(sale =>
                    sale.cliente.toLowerCase().includes(term) && sale.estado !== 'ARCHIVADO'
                );

                if (matches.length === 0) {
                    resultContainer.classList.remove('hidden');
                    resultContainer.innerHTML = '<p class="text-gray-500 text-sm">No se encontraron resultados.</p>';
                    return;
                }

                resultContainer.classList.remove('hidden');
                matches.forEach(sale => {
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-white border border-gray-200 rounded-lg shadow-sm flex justify-between items-center gap-2 cursor-pointer hover:bg-gray-50 transition-colors group';

                    let profileName = null;
                    if (sale.accountId && sale.profileId) {
                        const account = allPlatformAccounts.find(a => a.id === sale.accountId);
                        if (account && account.profiles) {
                            const profile = account.profiles.find(p => p.id === sale.profileId);
                            if (profile) profileName = profile.nombre;
                        }
                    }

                    item.onclick = () => openSuccessSaleModal(sale, profileName);

                    item.innerHTML = `
                        <div class="flex-grow min-w-0">
                            <p class="font-bold text-gray-800 text-sm truncate">${sale.cliente}</p>
                            <p class="text-xs text-gray-500">${getPlatformHtml(sale.plataforma)}</p>
                        </div>
                        <div class="flex-shrink-0 text-gray-400 group-hover:text-indigo-500 transition-colors">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                    `;

                    resultContainer.appendChild(item);
                });
            });

            const getSaleStatus = (finPlan, estado) => {
                if (estado === 'EN_MANTENIMIENTO') return 'Mantenimiento';
                if (dayjs().isAfter(dayjs(finPlan).endOf('day'))) { return 'Vencido'; }
                const today = dayjs().startOf('day');
                const expirationDate = dayjs(finPlan).startOf('day');
                const diffDays = expirationDate.diff(today, 'day');
                if (diffDays === 0) return 'Vence hoy';
                if (diffDays <= 7) return 'Próximo a Vencer';
                return 'Activo';
            };
            const formatCurrency = (amount) => `S/${(amount || 0).toFixed(2)}`;
            const getPlatformHtml = (platformName) => {
                const style = platformStyles[platformName] || platformStyles['Otro'];
                if (style.isCustom) {
                    return `<span class="font-bold" style="color: ${style.bg}">${platformName}</span>`;
                }
                return `<span class="font-bold ${style.color}">${platformName}</span>`;
            };
            const getMetodoPagoBadge = (metodo) => {
                const styles = { 'BCP': 'bg-orange-400 text-white', 'Falta pagar': 'bg-red-500 text-white', 'Gratis': 'bg-green-500 text-white' };
                const style = styles[metodo] || 'bg-gray-400 text-white';
                return `<span class="px-2 py-1 text-xs font-semibold rounded-full ${style}">${metodo}</span>`;
            };
            const handlePlatformChange = (select, container, input) => { if (select.value === 'Otro') { container.classList.remove('hidden'); input.required = true; } else { container.classList.add('hidden'); input.required = false; input.value = ''; } };
            const openModal = () => { selectors.editModal.classList.remove('hidden'); setTimeout(() => { selectors.editModal.classList.remove('opacity-0'); selectors.editModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10); };
            const closeModal = () => { selectors.editModal.classList.add('opacity-0'); selectors.editModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => selectors.editModal.classList.add('hidden'), 300); };
            const openProfilesModal = () => { selectors.manageProfilesModal.classList.remove('hidden'); setTimeout(() => { selectors.manageProfilesModal.classList.remove('opacity-0'); selectors.manageProfilesModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10); };
            const closeProfilesModal = () => { selectors.manageProfilesModal.classList.add('opacity-0'); selectors.manageProfilesModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => selectors.manageProfilesModal.classList.add('hidden'), 300); };
            const showConfirmationModal = (title, message, onConfirm) => {
                const modal = document.getElementById('confirmation-modal');
                document.getElementById('confirmation-title').textContent = title;
                document.getElementById('confirmation-message').textContent = message;
                const confirmBtn = document.getElementById('confirm-action-btn');
                const cancelBtn = document.getElementById('cancel-confirmation-btn');
                confirmBtn.onclick = () => { onConfirm(); hideConfirmationModal(); };
                cancelBtn.onclick = () => { hideConfirmationModal(); };
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
            };
            const hideConfirmationModal = () => {
                const modal = document.getElementById('confirmation-modal');
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => { modal.classList.add('hidden'); document.getElementById('confirm-action-btn').onclick = null; document.getElementById('cancel-confirmation-btn').onclick = null; }, 300);
            };
            const showArchiveDeleteModal = (saleId) => {
                const modal = document.getElementById('archive-delete-modal');
                const archiveBtn = document.getElementById('archive-btn');
                const deleteBtn = document.getElementById('delete-permanently-btn');
                const cancelBtn = document.getElementById('cancel-action-btn');
                archiveBtn.onclick = () => handleArchiveAction(saleId);
                deleteBtn.onclick = () => handlePermanentDeleteAction(saleId);
                cancelBtn.onclick = () => hideArchiveDeleteModal();
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
            };
            const hideArchiveDeleteModal = () => {
                const modal = document.getElementById('archive-delete-modal');
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => { modal.classList.add('hidden'); document.getElementById('archive-btn').onclick = null; document.getElementById('delete-permanently-btn').onclick = null; document.getElementById('cancel-action-btn').onclick = null; }, 300);
            };

            const generateSaleMessage = (saleData, profileName) => {
                let message = `📺 Plataforma: ${saleData.plataforma}\n`;
                if (saleData.correo) message += `📧 Correo: ${saleData.correo}\n`;
                if (saleData.contrasena) message += `🔑 Contraseña: ${saleData.contrasena}\n`;
                if (saleData.plataforma !== 'Canva') {
                const displayProfile = profileName || saleData.cliente;
                message += `👤 Perfil: ${displayProfile}\n`;
                }
                if (saleData.pin) message += `🔒 PIN: ${saleData.pin}\n`;

                if (saleData.finPlan) {
                    const vigencia = dayjs(saleData.finPlan).format('DD/MM/YYYY');
                    message += `📅 Vigencia: ${vigencia}\n`;
                }

                message += `\n⚠️ Advertencia: La cuenta es solo para un dispositivo, en caso se use en más dispositivos se dará de baja a la cuenta`;

                return message;
            };

            const openSuccessSaleModal = (saleData, profileName) => {
                // Populate Modal Data
                const platformStyle = platformStyles[saleData.plataforma] || platformStyles['Otro'];

                // Header Styling
                const headerBg = document.getElementById('modal-header-bg');
                if (platformStyle.bgGradient) {
                    headerBg.style.background = platformStyle.bgGradient;
                } else {
                    headerBg.style.backgroundColor = platformStyle.bg;
                }

                // Platform Info
            const platformNameEl = document.getElementById('modal-platform-name');
            platformNameEl.textContent = saleData.plataforma;
            platformNameEl.style.color = getContrastYIQ(platformStyle.bg);

                // Credentials
                document.getElementById('modal-email').textContent = saleData.correo || 'No disponible';
                document.getElementById('modal-password').textContent = saleData.contrasena || '********';

                // Profile
                const profileContainer = document.getElementById('modal-profile-container');
                if (saleData.plataforma === 'Canva' || !profileName) {
                    profileContainer.classList.add('hidden');
                } else {
                    profileContainer.classList.remove('hidden');
                    document.getElementById('modal-profile').textContent = profileName;
                }

                // PIN
                const pinContainer = document.getElementById('modal-pin-container');
                if (!saleData.pin) {
                    pinContainer.classList.add('hidden');
                } else {
                    pinContainer.classList.remove('hidden');
                    document.getElementById('modal-pin').textContent = saleData.pin;
                }

                // Adjust grid if items are hidden
                const grid = profileContainer.parentElement;
                if (profileContainer.classList.contains('hidden') && pinContainer.classList.contains('hidden')) {
                    grid.classList.add('hidden');
                } else if (profileContainer.classList.contains('hidden') || pinContainer.classList.contains('hidden')) {
                    grid.classList.remove('grid-cols-2');
                    grid.classList.add('grid-cols-1');
                } else {
                    grid.classList.remove('grid-cols-1');
                    grid.classList.add('grid-cols-2');
                }

                // Link Button Logic
                const linkBtn = document.getElementById('modal-open-link-btn');
                const account = allPlatformAccounts.find(a => a.id === saleData.accountId);
                if (account && account.enlace) {
                    linkBtn.href = account.enlace;
                    linkBtn.classList.remove('hidden');
                } else {
                    linkBtn.classList.add('hidden');
                    linkBtn.href = '#';
                }

                // Store data for copy button
                selectors.copySaleMessageBtn.onclick = () => {
                    const message = generateSaleMessage(saleData, profileName);
                    navigator.clipboard.writeText(message).then(() => {
                        const btn = selectors.copySaleMessageBtn;
                        const originalHtml = btn.innerHTML;
                        btn.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>¡Copiado!`;
                        btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                        btn.classList.add('bg-green-600', 'hover:bg-green-700');

                        setTimeout(() => {
                            btn.innerHTML = originalHtml;
                            btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                            btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        }, 2000);
                    });
                };

                selectors.successSaleModal.classList.remove('hidden');
                setTimeout(() => {
                    selectors.successSaleModal.classList.remove('opacity-0');
                    selectors.successSaleModal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            };

            const closeSuccessSaleModal = () => {
                selectors.successSaleModal.classList.add('opacity-0');
                selectors.successSaleModal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => {
                    selectors.successSaleModal.classList.add('hidden');
                }, 300);
            };

            const updateFinancialSummary = () => {
                const salesIncome = allSales.filter(s => s.metodoPago !== 'Falta pagar').reduce((sum, sale) => sum + (sale.precio || 0), 0);
                const totalIngresos = salesIncome;
                const totalEgresos = allExpenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
                const balance = totalIngresos - totalEgresos;
                selectors.totalIngresos.textContent = formatCurrency(totalIngresos);
                selectors.totalEgresos.textContent = formatCurrency(totalEgresos);
                selectors.balanceTotal.textContent = formatCurrency(balance);
                selectors.balanceTotal.classList.toggle('text-red-900', balance < 0);
                selectors.balanceTotal.classList.toggle('text-blue-900', balance >= 0);
            };

            const renderRecentIncome = () => {
                const recentIncome = allSales
                    .filter(sale => {
                        const date = sale.createdAt ? dayjs(sale.createdAt) : dayjs(sale.inicioPlan);
                        return date.isAfter(dayjs().subtract(10, 'day').startOf('day'));
                    })
                    .sort((a, b) => {
                        const dateA = a.createdAt ? new Date(a.createdAt) : new Date(a.inicioPlan);
                        const dateB = b.createdAt ? new Date(b.createdAt) : new Date(b.inicioPlan);
                        return dateB - dateA;
                    });

                selectors.recentIncomeList.innerHTML = '';
                if (recentIncome.length === 0) {
                    selectors.recentIncomeList.innerHTML = '<p class="text-gray-500 text-center py-4">No hay ingresos recientes.</p>';
                    return;
                }

                recentIncome.forEach(sale => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center py-3 border-b border-gray-100 last:border-b-0';
                    const dateDisplay = sale.createdAt ? dayjs(sale.createdAt) : dayjs(sale.inicioPlan);

                    item.innerHTML = `
                    <div class="p-3 bg-green-50 rounded-full mr-4 flex-shrink-0">
                        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <div class="flex-grow min-w-0">
                        <p class="font-medium text-gray-800 truncate">${sale.plataforma} - ${sale.cliente}</p>
                        <p class="text-sm text-gray-500 truncate">${sale.correo || 'Cuenta no especificada'}</p>
                        <p class="text-xs text-gray-400">${dateDisplay.format('DD [de] MMM, HH:mm')}${sale.vendedor ? ' • ' + sale.vendedor : ''}</p>
                    </div>
                    <div class="text-right mx-2 flex-shrink-0">
                        <p class="font-semibold text-green-600 text-base">${formatCurrency(sale.precio)}</p>
                    </div>
                    `;
                    selectors.recentIncomeList.appendChild(item);
                });
            };

            const renderPlatformAccountAlerts = () => {
                const today = dayjs().startOf('day');
                const getPlatformAccountStatus = (fechaPago) => {
                    if (!fechaPago) return 'Activo';
                    if (dayjs().isAfter(dayjs(fechaPago).endOf('day'))) { return 'Vencido'; }
                    const expirationDate = dayjs(fechaPago).startOf('day');
                    const diffDays = expirationDate.diff(today, 'day');
                    if (diffDays === 0) return 'Vence hoy';
                    if (diffDays <= 5) return 'Próximo a Vencer';
                    return 'Activo';
                };
                const alerts = allPlatformAccounts.filter(acc => {
                    const status = getPlatformAccountStatus(acc.fechaPago);
                    return status === 'Vencido' || status === 'Vence hoy' || status === 'Próximo a Vencer';
                }).sort((a, b) => new Date(a.fechaPago) - new Date(b.fechaPago));
                selectors.platformAccountAlertsSection.innerHTML = '';
                if (alerts.length > 0) {
                    selectors.platformAccountAlertsSection.className = 'space-y-3';
                    alerts.forEach(acc => {
                        const status = getPlatformAccountStatus(acc.fechaPago);
                        const borderColor = status === 'Vencido' ? 'border-red-500' : 'border-yellow-500';
                        const card = document.createElement('div');
                        card.className = `bg-gray-50 p-3 rounded-lg border-l-4 ${borderColor}`;
                        let statusText, statusColor;
                        const dueDate = dayjs(acc.fechaPago);
                        if (status === 'Vencido') { statusText = 'Venció ' + dueDate.fromNow(); statusColor = 'text-red-600'; } else if (status === 'Vence hoy') { statusText = 'Vence hoy'; statusColor = 'text-yellow-700'; } else { statusText = 'Vence ' + dueDate.endOf('day').fromNow(); statusColor = 'text-yellow-600'; }
                        card.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-bold text-sm text-gray-800 truncate">${acc.email}</p><p class="text-xs text-gray-500">${getPlatformHtml(acc.platform)}</p></div><div class="text-right flex-shrink-0 ml-2"><p class="font-semibold text-xs ${statusColor}">${statusText}</p><p class="text-xs text-gray-500">${dueDate.format('DD MMM')}</p></div></div>`;
                        selectors.platformAccountAlertsSection.appendChild(card);
                    });
                } else { selectors.platformAccountAlertsSection.className = 'space-y-3'; selectors.platformAccountAlertsSection.innerHTML = '<p class="text-gray-500 text-sm">No hay cuentas por vencer.</p>'; }
            };

            const loadDashboardData = () => {
                const today = dayjs().startOf('day');
                const startOfMonth = dayjs().startOf('month');
                const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');
                const salesToday = allSales.filter(sale => dayjs(sale.inicioPlan).isSame(today, 'day') && sale.metodoPago !== 'Falta pagar').reduce((sum, sale) => sum + sale.precio, 0);
                selectors.kpiSalesToday.textContent = formatCurrency(salesToday);
                selectors.kpiSalesToday.classList.remove('skeleton');

                const salesMonth = allSales.filter(sale => (dayjs(sale.inicioPlan).isAfter(startOfMonth) || dayjs(sale.inicioPlan).isSame(startOfMonth)) && sale.metodoPago !== 'Falta pagar').reduce((sum, sale) => sum + sale.precio, 0);
                selectors.kpiSalesMonth.textContent = formatCurrency(salesMonth);
                selectors.kpiSalesMonth.classList.remove('skeleton');

                const activeClients = activeSales.length;
                selectors.kpiActiveClients.textContent = activeClients;
                selectors.kpiActiveClients.classList.remove('skeleton');

                const expirationAlerts = activeSales.filter(sale => {
                    const status = getSaleStatus(sale.finPlan, sale.estado);
                    return status === 'Vencido' || status === 'Vence hoy' || status === 'Próximo a Vencer';
                }).filter(sale => {
                    const expirationDate = dayjs(sale.finPlan).startOf('day');
                    const diffDays = expirationDate.diff(today, 'day');
                    return diffDays <= 3;
                }).sort((a, b) => new Date(a.finPlan) - new Date(b.finPlan));
                selectors.alertsSection.innerHTML = '';
                if (expirationAlerts.length > 0) {
                    selectors.alertsSection.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                    expirationAlerts.forEach(sale => {
                        const status = getSaleStatus(sale.finPlan, sale.estado);
                        const borderColor = status === 'Vencido' ? 'border-red-500' : 'border-yellow-500';
                        const card = document.createElement('div');
                        card.className = `bg-white p-4 rounded-lg shadow-md border-l-4 ${borderColor} flex flex-col justify-between`;
                        let statusText, statusColor;
                        if (status === 'Vencido') { statusText = 'Venció ' + dayjs(sale.finPlan).fromNow(); statusColor = 'text-red-600'; } else if (status === 'Vence hoy') { statusText = 'Vence hoy'; statusColor = 'text-yellow-700'; } else { statusText = 'Vence ' + dayjs(sale.finPlan).endOf('day').fromNow(); statusColor = 'text-yellow-600'; }

                        let motherAccountEmail = '';
                        if (sale.accountId) {
                            const account = allPlatformAccounts.find(a => a.id === sale.accountId);
                            if (account) motherAccountEmail = account.email;
                        }

                        card.innerHTML = `
                            <div>
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-gray-800">${sale.cliente}</p>
                                        <p class="text-sm text-gray-500">${getPlatformHtml(sale.plataforma)}</p>
                                        ${motherAccountEmail ? `<p class="text-xs text-gray-400 mt-1 truncate max-w-[150px]" title="${motherAccountEmail}">📩 ${motherAccountEmail}</p>` : ''}
                                        <p class="text-sm text-gray-700 font-medium mt-1">👤 ${sale.vendedor || 'N/A'}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold text-sm ${statusColor}">${statusText}</p>
                                        <p class="text-xs text-gray-500">${dayjs(sale.finPlan).format('DD [de] MMMM')}</p>
                                    </div>
                                </div>
                            </div>`;

                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = "mt-4 flex justify-end gap-2";

                        const goToSaleBtn = document.createElement('button');
                        goToSaleBtn.className = "bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-xs font-semibold py-1 px-3 rounded-md transition-colors";
                        goToSaleBtn.textContent = "Ir a Ventas";
                        goToSaleBtn.onclick = () => window.goToSale(sale.cliente);

                        const copyBtn = document.createElement('button');
                        copyBtn.className = "copy-alert-btn bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-semibold py-1 px-3 rounded-md transition-colors";
                        copyBtn.textContent = "Copiar Aviso";
                        copyBtn.dataset.saleId = sale.id;

                        actionsDiv.appendChild(goToSaleBtn);
                        actionsDiv.appendChild(copyBtn);
                        card.appendChild(actionsDiv);

                        selectors.alertsSection.appendChild(card);
                    });
                } else { selectors.alertsSection.className = 'space-y-3'; selectors.alertsSection.innerHTML = '<p class="text-gray-500">No hay alertas de vencimiento.</p>'; }
                selectors.alertsSection.querySelectorAll('.copy-alert-btn').forEach(btn => { btn.addEventListener('click', handleCopyAlert); });
                renderPlatformAccountAlerts();
            };

            const handleCopyAlert = (event) => {
                const button = event.currentTarget;
                const saleId = button.dataset.saleId;
                const sale = allSales.find(s => s.id === saleId);
                if (!sale) return;
                const status = getSaleStatus(sale.finPlan, sale.estado);
                let message = '';
                if (status === 'Vencido') { message = `Buenas tardes 👋🏻, se le informa que su cuenta de "${sale.plataforma}" ya venció. Si desea renovar me avisa, por favor, para evitar el corte del servicio. Gracias por su preferencia 💯`; } else if (status === 'Vence hoy') { message = `Buenas tardes 👋🏻, se le informa que su cuenta de "${sale.plataforma}" vence el día de hoy a la medianoche ‼. Si desea renovar me avisa, por favor. Gracias por su preferencia 💯`; } else { const daysLeft = dayjs(sale.finPlan).endOf('day').diff(dayjs(), 'day'); const dayText = daysLeft === 0 ? 'mañana' : `en ${daysLeft + 1} días`; message = `Buenas tardes 👋🏻, se le informa que su cuenta de "${sale.plataforma}" vence ${dayText}. Si desea renovar me avisa, por favor. Gracias por su preferencia 💯`; }
                navigator.clipboard.writeText(message).then(() => { const originalText = button.textContent; button.textContent = '¡Copiado!'; button.classList.add('bg-green-500', 'text-white'); setTimeout(() => { button.textContent = originalText; button.classList.remove('bg-green-500', 'text-white'); }, 2000); }).catch(err => { console.error('Error al copiar texto: ', err); alert('No se pudo copiar el texto.'); });
            };

            const applyFiltersAndRender = (salesToRender) => {
                let filteredSales = [...salesToRender];
                if (activePlatformFilter !== 'Todos') { filteredSales = filteredSales.filter(sale => sale.plataforma === activePlatformFilter); }
                if (currentSearchTerm) { const term = currentSearchTerm.toLowerCase(); filteredSales = filteredSales.filter(sale => sale.cliente.toLowerCase().includes(term) || sale.plataforma.toLowerCase().includes(term) || (sale.correo && sale.correo.toLowerCase().includes(term))); }
                if (activeAccountFilter) { const account = allPlatformAccounts.find(a => a.id === activeAccountFilter); if (account) { filteredSales = filteredSales.filter(sale => sale.correo === account.email && sale.contrasena === account.password); } }
                if (activeStatusFilter) { filteredSales = filteredSales.filter(sale => getSaleStatus(sale.finPlan, sale.estado) === activeStatusFilter); }
                renderSales(filteredSales);
            };
            const renderPlatformFilters = () => {
                selectors.platformFilters.innerHTML = '';
                const platforms = ['Todos', ...Object.keys(platformStyles)];
                platforms.forEach(platform => {
                    const btn = document.createElement('button');
                    btn.dataset.platform = platform;
                    const activeClasses = 'border-indigo-500 bg-indigo-50';
                    const inactiveClasses = 'border-transparent hover:bg-gray-100';
                    btn.className = `p-2 rounded-lg border-2 transition-all duration-200 font-semibold ${activePlatformFilter === platform ? activeClasses : inactiveClasses}`;
                    if (platform === 'Todos') { btn.textContent = 'Todos'; } else { btn.innerHTML = getPlatformHtml(platform); }
                    btn.addEventListener('click', () => {
                        activePlatformFilter = platform;
                        document.querySelectorAll('#platform-filters button').forEach(b => {
                            if (!b.id || b.id !== 'view-maintenance-btn') {
                                b.className = `p-2 rounded-lg border-2 transition-all duration-200 font-semibold ${inactiveClasses}`;
                            }
                        });
                        btn.className = `p-2 rounded-lg border-2 transition-all duration-200 font-semibold ${activeClasses}`;
                        const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');
                        applyFiltersAndRender(activeSales);
                    });
                    selectors.platformFilters.appendChild(btn);
                });

                // Maintenance Button
                const maintenanceBtn = document.createElement('button');
                maintenanceBtn.id = 'view-maintenance-btn';
                maintenanceBtn.className = 'text-yellow-600 font-medium hover:text-yellow-800 underline transition flex items-center gap-1 p-2 ml-2';
                maintenanceBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    Mantenimiento
                `;
                maintenanceBtn.addEventListener('click', toggleMaintenanceModal);
                selectors.platformFilters.appendChild(maintenanceBtn);
            };

            function renderPlatformSelects() {
                const platforms = Object.keys(platformStyles).filter(p => p !== 'Otro' && p !== 'HBO Max').sort();
                platforms.push('Otro');

                const optionsHtml = platforms.map(p => `<option value="${p}">${p}</option>`).join('');

                const addSaleSelect = document.getElementById('plataforma');
                const editSaleSelect = document.getElementById('edit-plataforma');

                if (addSaleSelect) addSaleSelect.innerHTML = optionsHtml;
                if (editSaleSelect) editSaleSelect.innerHTML = optionsHtml;
            }

            const renderAccountPlatformButtons = () => {
                const platformNames = Object.keys(platformStyles).filter(p => p !== 'Otro' && p !== 'HBO Max');
                selectors.accountPlatformButtons.innerHTML = '';

                const resetButtons = () => {
                    document.querySelectorAll('#account-platform-buttons button').forEach(b => {
                        const pname = b.dataset.platformName;
                        const pStyle = platformStyles[pname] || platformStyles['Otro'];
                        b.style.backgroundColor = 'white';
                        b.style.color = pStyle.bg;
                        b.style.borderColor = pStyle.bg;
                        b.classList.remove('scale-110', 'shadow-md', 'ring-2', 'ring-offset-2', 'ring-indigo-500');
                    });
                };

                platformNames.forEach(name => {
                    const btn = document.createElement('button');
                    const platformStyle = platformStyles[name] || platformStyles['Otro'];
                    btn.type = 'button';
                    btn.dataset.platformName = name;
                    btn.className = `px-4 py-2 rounded-lg border-2 font-bold text-sm transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none`;

                    // Initial State: Outline
                    btn.style.backgroundColor = 'white';
                    btn.style.borderColor = platformStyle.bg;
                    btn.style.color = platformStyle.bg;
                    btn.textContent = name;

                    btn.addEventListener('click', () => {
                        selectors.addAccountForm['account-platform'].value = name;
                        resetButtons();
                        // Active State: Solid
                        btn.style.backgroundColor = platformStyle.bg;
                        btn.style.color = 'white';
                        btn.classList.add('scale-110', 'shadow-md');
                    });
                    selectors.accountPlatformButtons.appendChild(btn);
                });

                // Add Custom Platform Button
                const addPlatformBtn = document.createElement('button');
                addPlatformBtn.type = 'button';
                addPlatformBtn.className = `px-4 py-2 rounded-lg border-2 border-dashed border-gray-400 text-gray-500 font-bold text-sm transition-all duration-200 ease-in-out transform hover:scale-105 hover:border-gray-600 hover:text-gray-700 focus:outline-none flex items-center gap-1`;
                addPlatformBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Agregar
                `;
                addPlatformBtn.addEventListener('click', () => {
                    toggleAddServiceModal();
                });
                selectors.accountPlatformButtons.appendChild(addPlatformBtn);
            };

            const renderSales = (sales) => {
                selectors.salesList.innerHTML = '';
                if (sales.length === 0) {
                    selectors.salesList.innerHTML = `<p class="text-gray-500 text-center col-span-8 py-4">No se encontraron ventas que coincidan.</p>`;
                    return;
                }
                const groupedSales = sales.reduce((acc, sale) => {
                    let key = 'Cuentas Manuales';
                    if (sale.accountId) {
                        const account = allPlatformAccounts.find(a => a.id === sale.accountId);
                        if (account) {
                            key = account.email;
                        } else if (sale.correo) {
                            key = sale.correo;
                        }
                    } else if (sale.correo) {
                        key = sale.correo;
                    }

                    if (!acc[key]) {
                        acc[key] = [];
                    }
                    acc[key].push(sale);
                    return acc;
                }, {});

                const sortedAccounts = Object.keys(groupedSales).sort();

                for (const accountEmail of sortedAccounts) {
                    const salesInGroup = groupedSales[accountEmail];
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'mb-6';

                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'py-2 px-4 bg-gray-100 rounded-t-lg border-b-2 border-gray-200';
                    groupHeader.innerHTML = `<h3 class="text-md font-semibold text-gray-800">${accountEmail}</h3>`;
                    groupContainer.appendChild(groupHeader);

                    const salesRowsContainer = document.createElement('div');
                    salesRowsContainer.className = 'bg-white rounded-b-lg shadow-sm border border-t-0 border-gray-200';

                    salesInGroup.forEach(sale => {
                        const statusText = getSaleStatus(sale.finPlan, sale.estado);
                        const statusInfo = {
                            'Vencido': { color: 'orange' },
                            'Vence hoy': { color: 'red' },
                            'Próximo a Vencer': { color: 'yellow' },
                            'Activo': { color: 'green' },
                            'Mantenimiento': { color: 'gray' }
                        }[statusText];
                        const endDateForDisplay = dayjs(sale.finPlan);
                        const endDateForRelative = dayjs(sale.finPlan).endOf('day');

                        const row = document.createElement('div');
                        row.className = `grid grid-cols-2 md:grid-cols-8 gap-4 items-center p-3 hover:bg-gray-50 transition-colors
    duration-200 border-b last:border-b-0 border-gray-100 text-sm`;
                        row.innerHTML = `
    <div class="col-span-2 font-semibold text-gray-800">
        ${sale.cliente}
        ${sale.vendedor ? `<div class="hidden md:block text-xs font-normal text-gray-500 mt-0.5">Vendedor: ${sale.vendedor}</div>` : ''}
        <div class="font-normal text-xs text-gray-500 md:hidden mt-1 flex flex-wrap gap-2 items-center">
            <span>${getPlatformHtml(sale.plataforma)}</span>
            ${sale.vendedor ? `<span class="bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded border border-gray-200">👤 ${sale.vendedor}</span>` : ''}
            <span class="text-gray-400">&middot;</span>
            <span>Vence: ${endDateForDisplay.format('DD/MM/YYYY')}</span>
        </div>
    </div>
    <div class="hidden md:block">${getPlatformHtml(sale.plataforma)}</div>
    <div class="hidden md:block">${endDateForDisplay.format('DD/MM/YYYY')} <span
            class="text-xs text-gray-500">(${endDateForRelative.fromNow()})</span></div>
    <div class="hidden md:block"><span
            class="text-xs font-semibold py-1 px-2 uppercase rounded-full text-${statusInfo.color}-600 bg-${statusInfo.color}-100">${statusText}</span>
    </div>
    <div class="hidden md:block font-bold text-gray-800">${formatCurrency(sale.precio)}</div>
    <div class="hidden md:block">${getMetodoPagoBadge(sale.metodoPago) || 'N/A'}</div>
    <div class="flex justify-end gap-2 items-center">
        ${sale.celular ? `
        <button class="whatsapp-btn p-1 text-green-600 hover:text-green-800 hover:bg-green-100 rounded-full transition"
            data-id="${sale.id}" title="Enviar WhatsApp">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
            </svg>
        </button>` : ''}
        <button class="copy-details-btn p-1 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-full transition"
             data-id="${sale.id}" title="Copiar Datos">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
             </svg>
        </button>
        <button class="edit-btn p-1 text-indigo-600 hover:text-indigo-800 hover:bg-indigo-100 rounded-full transition"
            data-id="${sale.id}" title="Editar">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z">
                </path>
            </svg>
        </button>
        <button class="renew-btn p-1 text-green-600 hover:text-green-800 hover:bg-green-100 rounded-full transition"
            data-id="${sale.id}" title="Renovar">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5"></path>
            </svg>
        </button>
        <button class="delete-btn p-1 text-red-600 hover:text-red-800 hover:bg-red-100 rounded-full transition"
            data-id="${sale.id}" title="Eliminar">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                </path>
            </svg>
        </button>
        <button class="maintenance-btn p-1 text-yellow-600 hover:text-yellow-800 hover:bg-yellow-100 rounded-full transition"
            data-id="${sale.id}" title="Mantenimiento">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065zM15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
        </button>
    </div>
    <div class="md:hidden col-span-2 mt-2 pt-2 border-t flex justify-between items-center text-xs">
        <span
            class="font-semibold py-1 px-2 uppercase rounded-full text-${statusInfo.color}-600 bg-${statusInfo.color}-100">${statusText}</span>
        <span class="font-bold text-gray-800 text-base">${formatCurrency(sale.precio)}</span>
    </div>
    `;
                        salesRowsContainer.appendChild(row);
                    });

                    groupContainer.appendChild(salesRowsContainer);
                    selectors.salesList.appendChild(groupContainer);
                }

                selectors.salesList.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', e =>
                    handleEdit(e.currentTarget.dataset.id)));
                selectors.salesList.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', e =>
                    handleDeleteSale(e.currentTarget.dataset.id)));
                selectors.salesList.querySelectorAll('.renew-btn').forEach(b => b.addEventListener('click', e =>
                    openRenewalModal(e.currentTarget.dataset.id)));
                selectors.salesList.querySelectorAll('.maintenance-btn').forEach(b => b.addEventListener('click', e =>
                    handleMoveToMaintenance(e.currentTarget.dataset.id)));
                selectors.salesList.querySelectorAll('.copy-details-btn').forEach(b => b.addEventListener('click', e =>
                    handleCopySaleDetails(e.currentTarget.dataset.id, e.currentTarget)));
                selectors.salesList.querySelectorAll('.whatsapp-btn').forEach(b => b.addEventListener('click', e =>
                    handleWhatsAppClick(e.currentTarget.dataset.id)));
            };

            const handleWhatsAppClick = (saleId) => {
                const sale = allSales.find(s => s.id === saleId);
                if (!sale || !sale.celular) return;

                const now = dayjs();
                const end = dayjs(sale.finPlan);
                const daysDiff = end.diff(now, 'day');

                let message = "";
                if (daysDiff > 0) {
                    message = `Hola, le informamos que su cuenta de *${sale.plataforma}* está por vencer en *${daysDiff} días*.`;
                } else if (daysDiff === 0) {
                    message = `Hola, le informamos que su cuenta de *${sale.plataforma}* vence *hoy*.`;
                } else {
                    message = `Hola, le informamos que su cuenta de *${sale.plataforma}* ya ha vencido.`;
                }

                // Append renewal text (optional but helpful)
                // message += " Si desea renovar, por favor avíseme.";

                const url = `https://wa.me/${sale.celular}?text=${encodeURIComponent(message)}`;
                window.open(url, '_blank');
            };

            const handleCopySaleDetails = (saleId, btn) => {
                const sale = allSales.find(s => s.id === saleId);
                if (!sale) return;

                let profileName = '';
                if (sale.accountId && sale.profileId) {
                    const account = allPlatformAccounts.find(a => a.id === sale.accountId);
                    if (account && account.profiles) {
                        const profile = account.profiles.find(p => p.id === sale.profileId);
                        if (profile) profileName = profile.nombre;
                    }
                }

                const message = generateSaleMessage(sale, profileName);
                navigator.clipboard.writeText(message).then(() => {
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = `<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                    setTimeout(() => {
                         btn.innerHTML = originalHtml;
                    }, 2000);
                }).catch(err => console.error("Could not copy text: ", err));
            };
            const renderExpenses = () => {
                selectors.expensesList.innerHTML = '';
                if (allExpenses.length === 0) {
                    selectors.expensesList.innerHTML = '<p class="text-gray-500 text-center py-4">No hay egresos registrados.</p>';
                    return;
                }
                allExpenses.forEach(expense => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center py-3 border-b border-gray-100 last:border-b-0';
                    item.innerHTML = `
    <div class="p-3 bg-red-50 rounded-full mr-4">
        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path>
        </svg>
    </div>
    <div class="flex-grow">
        <p class="font-medium text-gray-800">${expense.description}</p>
        <p class="text-sm text-gray-500">${dayjs(expense.date).format('DD [de] MMMM, YYYY')}</p>
    </div>
    <div class="text-right mx-4">
        <p class="font-semibold text-red-600 text-base">${formatCurrency(expense.amount)}</p>
    </div>
    <button
        class="delete-expense-btn text-gray-400 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition-colors"
        data-id="${expense.id}" title="Eliminar Gasto">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
                d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z"
                clip-rule="evenodd"></path>
        </svg>
    </button>
    `;
                    selectors.expensesList.appendChild(item);
                });
                selectors.expensesList.querySelectorAll('.delete-expense-btn').forEach(b => b.addEventListener('click', e =>
                    handleDeleteExpense(e.currentTarget.dataset.id)));
            };
            const renderPlatformAccounts = () => {
                const { accountsList } = selectors;
                accountsList.innerHTML = '';

                let accountsToRender = allPlatformAccounts;

                // Filter based on selected view filter
                if (activeAccountViewFilter !== 'Todos') {
                    accountsToRender = accountsToRender.filter(acc => acc.platform === activeAccountViewFilter);

                    // GRID LAYOUT FOR FILTERED VIEW
                    accountsList.removeAttribute('style'); // Clear any previous inline styles
                    accountsList.style.columnCount = 'auto';
                    accountsList.style.display = 'grid';
                    accountsList.className = 'max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';

                    if (accountsToRender.length === 0) {
                        accountsList.innerHTML = '<p class="text-sm text-gray-400 col-span-full">No hay cuentas registradas para esta plataforma.</p>';
                        return;
                    }

                    const cardsHtml = accountsToRender.map(account => {
                        const platformStyle = platformStyles[account.platform] || platformStyles['Otro'];
                        const headerBgStyle = platformStyle.bgGradient ? `background: ${platformStyle.bgGradient};` : `background-color: ${platformStyle.bg};`;
                        const headerTextColor = getContrastYIQ(platformStyle.bg);

                        // Calculate Date Status
                        let fechaPagoHtml = '';
                        if (account.fechaPago) {
                            const fechaPago = dayjs(account.fechaPago);
                            const hoy = dayjs().startOf('day');
                            const diffDays = fechaPago.diff(hoy, 'day');
                            const statusClasses = diffDays <= 5 ? 'bg-red-100 text-red-800 border-red-200' : 'bg-green-100 text-green-800 border-green-200';
                            const label = diffDays < 0 ? 'Vencido' : 'Próx. Pago';
                            fechaPagoHtml = `<span class="px-2 py-1 rounded-md ${statusClasses} font-semibold text-xs border truncate">${label}: ${fechaPago.format('DD/MM/YYYY')}</span>`;
                        }

                        // Profiles
                        const userIconSvg = `<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>`;
                        let profilesHtml = '<div class="flex flex-wrap gap-1 mb-4">';
                        if (account.platform !== 'Canva') {
                             if (account.profiles && account.profiles.length > 0) {
                                const sortedProfiles = account.profiles.sort((a, b) => a.nombre.localeCompare(b.nombre));
                                sortedProfiles.forEach(profile => {
                                    const color = profile.estado === 'Disponible' ? 'text-green-500' : 'text-red-500';
                                    const title = `${profile.nombre}: ${profile.estado}`;
                                    profilesHtml += `<span class="${color}" title="${title}">${userIconSvg}</span>`;
                                });
                            } else {
                                // Empty slots placeholders
                                for (let i = 0; i < 5; i++) {
                                    profilesHtml += `<span class="text-gray-300" title="No configurado">${userIconSvg}</span>`;
                                }
                            }
                        }
                        profilesHtml += '</div>';

                        // Link Button
                        const enlaceBtnHtml = account.enlace
                            ? `<a href="${account.enlace}" target="_blank" class="text-blue-600 hover:text-blue-800 transition bg-blue-50 hover:bg-blue-100 p-1 rounded-full" title="Abrir enlace"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></a>`
                            : `<span class="p-1 text-gray-300 cursor-not-allowed rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></span>`;

                        // Manage Profiles Button
                        const manageProfilesBtnHtml = account.platform !== 'Canva'
                            ? `<button class="manage-profiles-btn p-2 text-teal-600 hover:bg-teal-50 rounded-lg transition" data-id="${account.id}" title="Gestionar Perfiles"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg></button>`
                            : '';

                        return `
                        <div class="bg-white rounded-2xl shadow-md overflow-hidden border border-gray-200 hover:shadow-xl transition-shadow duration-300 flex flex-col h-full">
                            <div class="px-4 py-3 flex justify-between items-center" style="${headerBgStyle}">
                                <h3 class="font-bold text-lg truncate flex-1 mr-2" style="color: ${headerTextColor}" title="${account.email}">${account.email}</h3>
                                <button class="copy-account-email-btn p-1 rounded hover:bg-white/20 transition flex-shrink-0" data-text="${account.email}" style="color: ${headerTextColor}" title="Copiar Correo">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                </button>
                            </div>
                            <div class="p-4 flex flex-col gap-3 flex-grow justify-between">
                                <div>
                                    <div class="flex justify-between items-start mb-3">
                                         ${fechaPagoHtml}
                                         ${enlaceBtnHtml}
                                    </div>
                                    ${profilesHtml}
                                    <div class="flex items-center w-full mb-1">
                                         <input type="password" value="${account.password}" class="w-full bg-gray-50 border border-gray-200 text-sm rounded-l-md px-3 py-2 focus:outline-none text-gray-700 font-mono" readonly>
                                         <button class="toggle-password-btn bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 transition h-[38px] border-y border-r border-gray-200 flex items-center justify-center" title="Mostrar/Ocultar">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                         </button>
                                         <button class="copy-account-password-btn bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-r-md transition h-[38px] border border-l-0 border-gray-200 flex items-center justify-center" data-text="${account.password}" title="Copiar Contraseña">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                         </button>
                                    </div>
                                </div>
                                <div class="flex justify-end gap-2 pt-3 border-t border-gray-100 mt-2">
                                    ${manageProfilesBtnHtml}
                                    <button class="edit-account-btn p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" data-id="${account.id}" title="Editar"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button>
                                    <button class="delete-account-btn p-2 text-red-600 hover:bg-red-50 rounded-lg transition" data-id="${account.id}" title="Eliminar"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                </div>
                            </div>
                        </div>`;
                    }).join('');

                    accountsList.innerHTML = cardsHtml;

                    // Add Event Listeners for Copy Buttons (Specific to Grid View)
                    const handleCopyBtn = (btn) => {
                        const text = btn.dataset.text;
                        navigator.clipboard.writeText(text).then(() => {
                            const icon = btn.querySelector('svg');
                            // Hardcoded original path for restore
                            const originalPath = btn.classList.contains('copy-account-email-btn')
                                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>'
                                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>';

                            icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';

                            // Visual feedback
                            if (btn.classList.contains('copy-account-password-btn')) {
                                btn.classList.add('text-green-600');
                                setTimeout(() => {
                                    icon.innerHTML = originalPath;
                                    btn.classList.remove('text-green-600');
                                }, 2000);
                            } else {
                                // For email button (in header), might be white or black text.
                                // Changing text color might be invisible if background is green.
                                // Let's just change icon.
                                setTimeout(() => {
                                    icon.innerHTML = originalPath;
                                }, 2000);
                            }
                        });
                    };

                    accountsList.querySelectorAll('.copy-account-email-btn').forEach(btn => btn.addEventListener('click', (e) => handleCopyBtn(e.currentTarget)));
                    accountsList.querySelectorAll('.copy-account-password-btn').forEach(btn => btn.addEventListener('click', (e) => handleCopyBtn(e.currentTarget)));

                } else {
                    // MASONRY LAYOUT FOR 'TODOS' VIEW (Existing Logic)
                    accountsList.removeAttribute('style'); // Reset inline styles
                    accountsList.className = 'max-w-7xl mx-auto'; // Reset classes to default

                    if (accountsToRender.length === 0) {
                        accountsList.innerHTML = '<p class="text-sm text-gray-400">No hay cuentas de plataforma registradas.</p>';
                        return;
                    }

                    // 1. Group accounts by platform
                    const groupedAccounts = accountsToRender.reduce((acc, account) => {
                        const { platform } = account;
                        if (!acc[platform]) {
                            acc[platform] = [];
                        }
                        acc[platform].push(account);
                        return acc;
                    }, {});

                    // 2. Sort and Render
                    let sortedAccounts = Object.keys(groupedAccounts).sort();

                    if (platformOrder.length > 0) {
                        sortedAccounts = sortedAccounts.sort((a, b) => {
                            const indexA = platformOrder.indexOf(a);
                            const indexB = platformOrder.indexOf(b);

                            if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                            if (indexA !== -1) return -1;
                            if (indexB !== -1) return 1;
                            return 0; // Keep alphabetical for those not in order list
                        });
                    }

                    for (const platform of sortedAccounts) {
                        const accounts = groupedAccounts[platform];
                        const platformStyle = platformStyles[platform] || platformStyles['Otro'];

                        const listItems = accounts.map(account => {
                            let fechaPagoHtml = '';
                            if (account.fechaPago) {
                                const fechaPago = dayjs(account.fechaPago);
                                const hoy = dayjs().startOf('day');
                                const diffDays = fechaPago.diff(hoy, 'day');

                                const statusClasses = diffDays <= 5 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                                fechaPagoHtml = `<div class="mt-1"><span class="px-2 py-1 text-xs font-semibold rounded-lg ${statusClasses}">Próx. Pago: ${fechaPago.format('DD/MM/YYYY')}</span></div>`;
                            }

                            const enlaceBtnHtml = account.enlace
                                ? `<a href="${account.enlace}" target="_blank"
                class="p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded-full transition"
                title="Abrir enlace">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1">
                    </path>
                </svg>
            </a>`
                                : `<span class="p-1 text-gray-400 cursor-not-allowed rounded-full" title="No hay enlace">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1">
                    </path>
                </svg>
            </span>`;

                            const userIconSvg = `<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
            </svg>`;
                            let profilesIndicatorHtml = '';

                            if (account.platform !== 'Canva') {
                                profilesIndicatorHtml = '<div class="flex flex-wrap items-center gap-1.5 mt-2">';
                                if (account.profiles && account.profiles.length > 0) {
                                    const sortedProfiles = account.profiles.sort((a, b) => a.nombre.localeCompare(b.nombre));
                                    sortedProfiles.forEach(profile => {
                                        const color = profile.estado === 'Disponible' ? 'text-green-500' : 'text-red-500';
                                        profilesIndicatorHtml += `<span class="${color}"
                    title="${profile.nombre}: ${profile.estado}">${userIconSvg}</span>`;
                                    });
                                } else {
                                    for (let i = 0; i < 5; i++) {
                                        profilesIndicatorHtml += `<span class="text-gray-300"
                    title="Perfil no configurado">${userIconSvg}</span>`;
                                    }
                                }
                                profilesIndicatorHtml += '</div>';
                            }

                            const manageProfilesBtnHtml = account.platform !== 'Canva'
                                ? `<button
                class="manage-profiles-btn p-1 text-teal-600 hover:text-teal-800 hover:bg-teal-100 rounded-full transition"
                data-id="${account.id}" title="Gestionar Perfiles">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                </svg>
            </button>`
                                : '';

                            return `
            <li class="list-group-item flex flex-col justify-between items-start py-4 px-4 border-b last:border-b-0 border-gray-100">
                <div class="w-full mb-4">
                    <div class="flex flex-col">
                        <span class="font-semibold text-gray-800 break-all text-base">${account.email}</span>
                        ${profilesIndicatorHtml}
                        ${fechaPagoHtml}
                    </div>
                </div>
                <div class="w-full flex flex-col gap-3">
                    <div class="flex items-center w-full">
                        <input type="password" value="${account.password}"
                            class="w-full bg-gray-100 border-gray-200 text-sm rounded-l-md px-3 py-2 focus:outline-none" readonly>
                        <button
                            class="toggle-password-btn bg-gray-200 hover:bg-gray-300 text-gray-600 p-2 rounded-r-md transition h-[38px]"
                            title="Mostrar/Ocultar contraseña">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                                </path>
                            </svg>
                        </button>
                    </div>

                    <div class="flex items-center gap-2 justify-end w-full">
                        ${manageProfilesBtnHtml}
                        <button
                            class="edit-account-btn p-2 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-lg transition"
                            data-id="${account.id}" title="Editar Cuenta">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z">
                                </path>
                            </svg>
                        </button>
                        ${enlaceBtnHtml}
                        <button
                            class="delete-account-btn p-2 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg transition"
                            data-id="${account.id}" title="Eliminar">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>
            </li>`;
                        }).join('');

                        const cardHtml = `
            <div class="bg-white rounded-2xl shadow-lg mb-6 overflow-hidden border border-gray-200 platform-card-container transition-transform duration-200 break-inside-avoid"
                data-platform="${platform}">
                <div class="px-4 py-3 border-b border-gray-200 cursor-move platform-card-header" draggable="true" style="${platformStyle.bgGradient ? `background: ${platformStyle.bgGradient};` : `background-color: ${platformStyle.bg};`}">
                    <h3 class="text-lg font-semibold text-white pointer-events-none select-none">${platform}</h3>
                </div>
                <ul class="divide-y divide-gray-200">
                    ${listItems}
                </ul>
            </div>
            `;
                        accountsList.innerHTML += cardHtml;
                    }
                }

                // 3. Add Event Listeners (Common logic remains mostly the same, re-attaching to new elements)
                accountsList.querySelectorAll('.delete-account-btn').forEach(btn => {
                    btn.addEventListener('click', e => handleDeleteAccount(e.currentTarget.dataset.id));
                });
                accountsList.querySelectorAll('.edit-account-btn').forEach(btn => {
                    btn.addEventListener('click', e => handleEditAccount(e.currentTarget.dataset.id));
                });
                accountsList.querySelectorAll('.manage-profiles-btn').forEach(btn => {
                    btn.addEventListener('click', e => handleManageProfiles(e.currentTarget.dataset.id));
                });

                accountsList.querySelectorAll('.toggle-password-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const button = e.currentTarget;
                        const passwordInput = button.previousElementSibling;
                        const icon = button.querySelector('svg');

                        if (passwordInput && passwordInput.tagName === 'INPUT') {
                            if (passwordInput.type === 'password') {
                                passwordInput.type = 'text';
                                icon.innerHTML = `
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .946-3.11 3.563-5.522 6.837-6.141M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17.581 10.41A7.48 7.48 0 0119.542 12c-1.274 4.057-5.064 7-9.542 7a10.046 10.046 0 01-3.132-.475M2.458 12c.946-3.11 3.563-5.522 6.837-6.141m1.581 2.318A4.5 4.5 0 0115 12a4.5 4.5 0 01-1.07 2.828M5 5l14 14" />
            `;
                            } else {
                                passwordInput.type = 'password';
                                icon.innerHTML = `
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            `;
                            }
                        }
                    });
                });

                // Attach Drag and Drop Event Listeners ONLY for 'Todos'
                if (activeAccountViewFilter === 'Todos') {
                    let draggedItem = null;
                    const platformCards = accountsList.querySelectorAll('.platform-card-container');

                    platformCards.forEach(card => {
                        const header = card.querySelector('.platform-card-header');

                        header.addEventListener('dragstart', (e) => {
                            draggedItem = card;
                            e.dataTransfer.effectAllowed = 'move';
                            e.dataTransfer.setData('text/plain', card.dataset.platform);
                            setTimeout(() => card.style.opacity = '0.5', 0);
                        });

                        header.addEventListener('dragend', () => {
                            draggedItem = null;
                            card.style.opacity = '1';
                            platformCards.forEach(c => c.style.borderTop = '');
                        });

                        card.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            e.dataTransfer.dropEffect = 'move';

                            const bounding = card.getBoundingClientRect();
                            const offset = e.clientY - bounding.top + (e.clientX - bounding.left)/2;

                            // We are keeping it simple for vertical list
                        });

                        card.addEventListener('drop', async (e) => {
                            e.preventDefault();
                            if (draggedItem && draggedItem !== card) {
                                // Find position
                                const bounding = card.getBoundingClientRect();
                                const offset = e.clientY - bounding.top;

                                if (offset > bounding.height / 2) {
                                    card.after(draggedItem);
                                } else {
                                    card.before(draggedItem);
                                }

                                // Save new order
                                savePlatformOrder();
                            }
                        });
                    });
                }
            };

            const savePlatformOrder = async () => {
                const newOrder = [];
                const cards = selectors.accountsList.querySelectorAll('.platform-card-container');
                cards.forEach(card => {
                    if (card.dataset.platform) {
                        newOrder.push(card.dataset.platform);
                    }
                });

                // Optimistic UI update already happened via DOM manipulation
                // Now save to backend
                try {
                    await setDoc(doc(db, "config", "platform_order"), { order: newOrder });
                } catch (error) {
                    console.error("Error saving platform order:", error);
                    alert("Error al guardar el orden de las plataformas.");
                }
            };

            const populatePlatformAccountsDropdowns = (platform = null, targetSelect = selectors.platformAccountSelect, includeAccountId = null) => {
                let accountsToDisplay = allPlatformAccounts;
                if (platform && platform !== 'Otro') {
                    accountsToDisplay = allPlatformAccounts.filter(acc => acc.platform === platform);
                }

                // If a specific account MUST be included (e.g., during edit, even if platform doesn't match or to ensure visibility)
                if (includeAccountId) {
                    const includedAccount = allPlatformAccounts.find(a => a.id === includeAccountId);
                    if (includedAccount && !accountsToDisplay.find(a => a.id === includeAccountId)) {
                        accountsToDisplay.push(includedAccount);
                    }
                }

                const createOption = (account) => `<option value="${account.id}">${account.platform} - ${account.email}</option>
        `;
                const options = accountsToDisplay.map(createOption).join('');

                if (targetSelect === selectors.platformAccountSelect) {
                    // Add Sale Form: No "Sin cuenta" option
                    targetSelect.innerHTML = `<option value="">Seleccione una cuenta madre</option>${options}`;
                } else if (targetSelect === selectors.editPlatformAccountSelect) {
                    // Edit Sale Form: No "Sin cuenta" option
                    targetSelect.innerHTML = `<option value="">Seleccione una cuenta madre</option>${options}`;
                } else {
                    // Filter dropdown (always shows all currently)
                    // The filter dropdown logic in applyFiltersAndRender might need this?
                    // No, populatePlatformAccountsDropdowns is mainly for forms.
                    // The main account filter is populated separately below.
                }
            };

            // Separate population for the filter dropdown to always show all
            const populateAccountFilterDropdown = () => {
                 const options = allPlatformAccounts.map(account => `<option value="${account.id}">${account.platform} - ${account.email}</option>`).join('');
                 selectors.accountFilter.innerHTML = `<option value="">Filtrar por cuenta...</option>${options}`;
            };

            const handlePlatformAccountChange = (select, profileSelect) => {
                const accountId = select.value;
                const account = allPlatformAccounts.find(a => a.id === accountId);
                const profileContainer = profileSelect.parentElement;

                // Reset profile dropdown
                profileSelect.innerHTML = '<option value="">Selecciona una cuenta madre primero</option>';
                profileSelect.disabled = true;
                profileSelect.classList.add('bg-gray-200');
                profileContainer.classList.remove('hidden');


                if (account) {
                    if (account.platform === 'Canva') {
                        profileContainer.classList.add('hidden');
                        profileSelect.required = false;
                    } else {
                        profileContainer.classList.remove('hidden');
                        profileSelect.required = true;
                        if (account.profiles && account.profiles.length > 0) {
                            const availableProfiles = account.profiles.filter(p => p.estado === 'Disponible');
                            if (availableProfiles.length > 0) {
                                profileSelect.innerHTML = '<option value="">Selecciona un perfil</option>';
                                availableProfiles.forEach(p => {
                                    profileSelect.innerHTML += `<option value="${p.id}" data-pin="${p.pin || ''}">${p.nombre}</option>`;
                                });
                                profileSelect.disabled = false;
                                profileSelect.classList.remove('bg-gray-200');
                            } else {
                                profileSelect.innerHTML = '<option value="">No hay perfiles disponibles</option>';
                            }
                        } else {
                            profileSelect.innerHTML = '<option value="">Perfiles no configurados</option>';
                        }
                    }
                } else {
                    profileContainer.classList.remove('hidden');
                    profileSelect.required = true;
                }
            };
            const handleEdit = (id) => {
                const sale = allSales.find(s => s.id === id);
                if (!sale) return;
                const f = selectors.editForm;
                f['edit-sale-id'].value = sale.id;
                f['edit-cliente'].value = sale.cliente;

                // Parse Celular
                if (sale.celular) {
                    // Remove +51 prefix for display if present, otherwise show as is
                    f['edit-celular'].value = sale.celular.startsWith('+51') ? sale.celular.slice(3) : sale.celular;
                } else {
                    f['edit-celular'].value = '';
                }

                f['edit-precio'].value = sale.precio;
                f['edit-inicioPlan'].value = sale.inicioPlan;
                f['edit-finPlan'].value = sale.finPlan;

                f['edit-pin'].value = sale.pin || '';
                f['edit-notas'].value = sale.notas || '';
                f['edit-metodoPago'].value = sale.metodoPago || '';

                // Reset status flag (default to current status or ignore if not restoring)
                if (selectors.editSaleStatus) selectors.editSaleStatus.value = '';

                // Platform and Account Logic
                const standardPlatforms = Array.from(f['edit-plataforma'].options).map(o => o.value);
                let currentPlatform = sale.plataforma;
                if (standardPlatforms.includes(sale.plataforma)) {
                    f['edit-plataforma'].value = sale.plataforma;
                } else {
                    f['edit-plataforma'].value = 'Otro';
                    selectors.editOtroPlataformaInput.value = sale.plataforma;
                }

                // Populate Account Dropdown with Filter + Current Included
                populatePlatformAccountsDropdowns(currentPlatform, selectors.editPlatformAccountSelect, sale.accountId);
                f['edit-platform-account'].value = sale.accountId || '';

                // Populate and set the profile dropdown
                const account = allPlatformAccounts.find(a => a.id === sale.accountId);
                selectors.editProfileSelect.innerHTML = '<option value="">Selecciona un perfil</option>';
                if (account && account.profiles) {
                    const currentProfile = account.profiles.find(p => p.id === sale.profileId);
                    const availableProfiles = account.profiles.filter(p => p.estado === 'Disponible');

                    // Add available profiles first
                    availableProfiles.forEach(p => {
                        selectors.editProfileSelect.innerHTML += `<option value="${p.id}" data-pin="${p.pin || ''}">${p.nombre}</option>`;
                    });

                    // Add the currently assigned profile if it's not already in the list (i.e., it's 'Ocupado')
                    if (currentProfile && !availableProfiles.some(p => p.id === currentProfile.id)) {
                        selectors.editProfileSelect.innerHTML += `<option value="${currentProfile.id}" data-pin="${currentProfile.pin || ''}">${currentProfile.nombre}
            (Ocupado)</option>`;
                    }
                    selectors.editProfileSelect.disabled = false;
                    selectors.editProfileSelect.classList.remove('bg-gray-200');
                } else {
                     selectors.editProfileSelect.disabled = true;
                     selectors.editProfileSelect.classList.add('bg-gray-200');
                }
                f['edit-profile-select'].value = sale.profileId || '';

                handlePlatformChange(selectors.editPlataformaSelect, selectors.editOtroPlataformaContainer,
                    selectors.editOtroPlataformaInput);
                openModal();
            };
            const openRenewalModal = (saleId) => {
                const sale = allSales.find(s => s.id === saleId);
                if (!sale) return;

                const modal = document.getElementById('renewal-modal');
                const form = document.getElementById('renewal-form');

                form['renewal-sale-id'].value = sale.id;
                form['renewal-amount'].value = sale.precio.toFixed(2);
                form['renewal-days'].value = 30; // Default a 30 días

                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            };

            const closeRenewalModal = () => {
                const modal = document.getElementById('renewal-modal');
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            };

            const handleArchiveAction = async (id) => {
                const sale = allSales.find(s => s.id === id);
                if (!sale) return;

                try {
                    // Release profile if it exists
                    if (sale.accountId && sale.profileId) {
                        const account = allPlatformAccounts.find(a => a.id === sale.accountId);
                        if (account && account.platform !== 'Canva') {
                            const profileRef = doc(db, "platformAccounts", sale.accountId, "Perfiles", sale.profileId);
                            await updateDoc(profileRef, { estado: 'Disponible', fechaVencimiento: null, clienteId: null });

                            // Update local state for immediate feedback
                            if (account.profiles) {
                                const profile = account.profiles.find(p => p.id === sale.profileId);
                                if (profile) {
                                    profile.estado = 'Disponible';
                                }
                            }
                            renderPlatformAccounts();
                        }
                    }

                    await updateDoc(doc(db, "sales", id), { estado: 'ARCHIVADO' });
                    hideArchiveDeleteModal();
                } catch (e) {
                    console.error("Error archiving sale: ", e);
                    alert('Error al archivar la venta.');
                }
            };

            const handlePermanentDeleteAction = async (id) => {
                const sale = allSales.find(s => s.id === id);
                if (!sale) return;

                try {
                    // Release profile if it exists
                    if (sale.accountId && sale.profileId) {
                        const account = allPlatformAccounts.find(a => a.id === sale.accountId);
                        if (account && account.platform !== 'Canva') {
                            const profileRef = doc(db, "platformAccounts", sale.accountId, "Perfiles", sale.profileId);
                            await updateDoc(profileRef, { estado: 'Disponible', fechaVencimiento: null, clienteId: null });

                            // Update local state
                            if (account.profiles) {
                                const profile = account.profiles.find(p => p.id === sale.profileId);
                                if (profile) {
                                    profile.estado = 'Disponible';
                                }
                            }
                            renderPlatformAccounts();
                        }
                    }

                    await deleteDoc(doc(db, "sales", id));
                    hideArchiveDeleteModal();
                } catch (e) {
                    console.error("Error deleting sale: ", e);
                    alert('Error al eliminar la venta.');
                }
            };
            const openEditAccountModal = () => {
                selectors.editAccountModal.classList.remove('hidden');
                setTimeout(() => {
                    selectors.editAccountModal.classList.remove('opacity-0');
                    selectors.editAccountModal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            };

            const closeEditAccountModal = () => {
                selectors.editAccountModal.classList.add('opacity-0');
                selectors.editAccountModal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => selectors.editAccountModal.classList.add('hidden'), 300);
            };
            const handleEditAccount = (id) => {
                const account = allPlatformAccounts.find(acc => acc.id === id);
                if (!account) return;

                const form = selectors.editAccountForm;
                form['edit-account-id'].value = account.id;

                // Populate platform select
                const platformSelect = document.getElementById('edit-account-platform');
                platformSelect.innerHTML = '';
                const sortedPlatforms = allServices.map(s => s.name).sort();
                if (!sortedPlatforms.includes('Otro')) sortedPlatforms.push('Otro');

                // If current platform is custom/not in list, add it temporarily
                if (!sortedPlatforms.includes(account.platform)) {
                    sortedPlatforms.push(account.platform);
                }

                sortedPlatforms.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = p;
                    platformSelect.appendChild(option);
                });

                form['edit-account-platform'].value = account.platform;
                form['edit-account-email'].value = account.email;
                form['edit-account-enlace'].value = account.enlace || '';
                form['edit-account-fechaPago'].value = account.fechaPago || '';
                form['edit-account-password'].value = ''; // Clear password field for security

                openEditAccountModal();
            };

            const handleManageProfiles = async (accountId) => {
                const account = allPlatformAccounts.find(acc => acc.id === accountId);
                if (!account || account.platform === 'Canva') return;

                selectors.profilesModalAccountEmail.textContent = account.email;
                const profilesRef = collection(db, "platformAccounts", accountId, "Perfiles");
                const profilesSnapshot = await getDocs(profilesRef);

                if (profilesSnapshot.empty) {
                    selectors.profilesContentArea.innerHTML = `
            <div class="text-center p-8">
                <p class="text-gray-600 mb-4">Esta cuenta aún no tiene perfiles configurados.</p>
                <div id="initial-actions" class="flex flex-col gap-3 justify-center items-center">
                    <button id="create-standard-profiles-btn" class="bg-teal-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-teal-700 transition w-full md:w-auto">
                        Crear 5 Perfiles (Estándar)
                    </button>
                    <button id="show-custom-profiles-btn" class="text-teal-600 font-medium hover:text-teal-800 underline transition">
                        Personalizar cantidad
                    </button>
                </div>
                <div id="custom-profiles-form" class="hidden mt-4">
                    <label class="block text-sm text-gray-600 mb-2">Cantidad de perfiles (Máx. 10):</label>
                    <div class="flex gap-2 justify-center">
                         <input type="number" id="custom-profile-qty" min="1" max="10" value="1" class="border border-gray-300 rounded-lg px-3 py-2 w-20 text-center">
                         <button id="create-custom-profiles-btn" class="bg-teal-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-teal-700 transition">
                            Crear
                         </button>
                    </div>
                    <button id="cancel-custom-btn" class="text-sm text-gray-500 mt-2 hover:text-gray-700">Cancelar</button>
                </div>
            </div>
            `;

                    const createProfiles = async (qty, btn) => {
                        btn.disabled = true;
                        btn.textContent = 'Creando...';

                        const newProfiles = await createInitialProfiles(accountId, qty);

                        // Manually update the in-memory state
                        const accountIndex = allPlatformAccounts.findIndex(acc => acc.id === accountId);
                        if (accountIndex !== -1) {
                            allPlatformAccounts[accountIndex].profiles = newProfiles;
                        }

                        // Re-render the main accounts list to show new icons
                        renderPlatformAccounts();

                        // Refresh the modal content
                        await handleManageProfiles(accountId);
                    };

                    document.getElementById('create-standard-profiles-btn').addEventListener('click', (e) => {
                        createProfiles(5, e.currentTarget);
                    });

                    document.getElementById('show-custom-profiles-btn').addEventListener('click', () => {
                        document.getElementById('initial-actions').classList.add('hidden');
                        document.getElementById('custom-profiles-form').classList.remove('hidden');
                    });

                    document.getElementById('cancel-custom-btn').addEventListener('click', () => {
                        document.getElementById('custom-profiles-form').classList.add('hidden');
                        document.getElementById('initial-actions').classList.remove('hidden');
                    });

                    document.getElementById('create-custom-profiles-btn').addEventListener('click', (e) => {
                        const qtyInput = document.getElementById('custom-profile-qty');
                        const qty = parseInt(qtyInput.value);
                        if (isNaN(qty) || qty < 1 || qty > 10) {
                            alert('Por favor ingresa una cantidad válida (1-10).');
                            return;
                        }
                        createProfiles(qty, e.currentTarget);
                    });

                } else {
                    let profilesHtml = '<ul class="space-y-3">';
                    const profiles = profilesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) =>
                        a.nombre.localeCompare(b.nombre));

                    profiles.forEach(profile => {
                        const isAvailable = profile.estado === 'Disponible';
                        const statusColor = isAvailable ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const statusIcon = isAvailable
                            ? `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>`
                            : `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>`;

                        let statusText = profile.estado;
                        if (!isAvailable) {
                            const sale = allSales.find(s => s.id === profile.clienteId);
                            if (sale) {
                                statusText = `Ocupado (${sale.cliente})`;
                            }
                        }

                        profilesHtml += `
                <li class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex flex-col">
                        <span class="font-semibold text-gray-700">${profile.nombre}</span>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-xs text-gray-500 font-mono">PIN: ${profile.pin || '<span class="italic text-gray-400">Sin PIN</span>'}</span>
                            <button class="edit-pin-btn p-1 text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-full transition border border-blue-100 shadow-sm" data-profile-id="${profile.id}" data-current-pin="${profile.pin || ''}" title="Editar PIN">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <span class="px-3 py-1 text-xs font-bold rounded-full ${statusColor} flex items-center gap-1">
                        ${statusIcon}
                        ${statusText}
                    </span>
                </li>
                `;
                    });
                    profilesHtml += '</ul>';
                    selectors.profilesContentArea.innerHTML = profilesHtml;

                    // Add Event Listeners for Edit PIN buttons
                    selectors.profilesContentArea.querySelectorAll('.edit-pin-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const profileId = e.currentTarget.dataset.profileId;
                            const currentPin = e.currentTarget.dataset.currentPin;
                            const newPin = prompt("Ingrese el nuevo PIN para este perfil:", currentPin);

                            if (newPin !== null) {
                                handleEditProfilePin(accountId, profileId, newPin);
                            }
                        });
                    });
                }

                openProfilesModal();
            };

            const handleEditProfilePin = async (accountId, profileId, newPin) => {
                try {
                    const profileRef = doc(db, "platformAccounts", accountId, "Perfiles", profileId);
                    await updateDoc(profileRef, { pin: newPin });

                    // Update local state immediately
                    const account = allPlatformAccounts.find(a => a.id === accountId);
                    if (account && account.profiles) {
                        const profile = account.profiles.find(p => p.id === profileId);
                        if (profile) {
                            profile.pin = newPin;
                        }
                    }

                    // Re-render
                    handleManageProfiles(accountId);

                } catch (error) {
                    console.error("Error updating PIN:", error);
                    alert("Error al actualizar el PIN.");
                }
            };

        const createInitialProfiles = async (accountId, count = 5) => {
            const profilesRef = collection(db, "platformAccounts", accountId, "Perfiles");
            const createdProfiles = [];
            const generatedPins = new Set();

            // Limit count to 10 max
            const safeCount = Math.min(Math.max(1, count), 10);

            for (let i = 1; i <= safeCount; i++) {
                let name = `Perfil ${i}`;
                if (safeCount === 1) {
                    name = "Perfil Único";
                }

                let pin;
                do {
                    pin = Math.floor(1000 + Math.random() * 9000).toString();
                } while (generatedPins.has(pin));
                generatedPins.add(pin);

                const profileDoc = {
                    nombre: name,
                    estado: 'Disponible',
                    fechaVencimiento: null,
                    clienteId: null,
                    pin: pin
                };
                const docRef = await addDoc(profilesRef, profileDoc);
                createdProfiles.push({ id: docRef.id, ...profileDoc });
            } return createdProfiles;
        };

        const handleDeleteSale = (id) => showArchiveDeleteModal(id);

        const toggleMaintenanceModal = () => {
            const modal = selectors.maintenanceModal;
            if (modal.classList.contains('hidden')) {
                renderMaintenanceSales();
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            } else {
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        };

        const renderMaintenanceSales = () => {
            const maintenanceSales = allSales.filter(s => s.estado === 'EN_MANTENIMIENTO')
                .sort((a, b) => a.cliente.localeCompare(b.cliente)); // Sorted by Name

            selectors.maintenanceList.innerHTML = '';
            // Change container layout from grid to stack
            selectors.maintenanceList.className = 'space-y-3';

            if (maintenanceSales.length === 0) {
                selectors.maintenanceList.innerHTML = '<p class="text-gray-500 text-center py-8">No hay clientes en mantenimiento.</p>';
                return;
            }

            maintenanceSales.forEach(sale => {
                const row = document.createElement('div');
                row.className = 'bg-gray-50 p-4 rounded-xl border border-gray-200 flex flex-col md:flex-row md:items-center justify-between gap-4 transition-all hover:shadow-md';

                const remainingDays = sale.diasRestantes !== undefined ? sale.diasRestantes : 0;
                const platformHtml = getPlatformHtml(sale.plataforma);

                row.innerHTML = `
                    <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <div>
                             <h3 class="font-bold text-gray-800 text-lg">${sale.cliente}</h3>
                             <div class="text-sm mt-1">${platformHtml}</div>
                        </div>
                        <div class="flex flex-col">
                             <span class="text-xs text-gray-500 uppercase font-semibold">Días Guardados</span>
                             <span class="font-bold text-gray-800 text-xl">${remainingDays} días</span>
                        </div>
                        <div class="flex flex-col gap-1 min-w-0">
                             <div class="text-sm text-gray-800 font-medium truncate" title="Correo">📧 ${sale.correo || 'N/A'}</div>
                             <div class="text-sm text-gray-600 font-mono" title="Contraseña">🔑 ${sale.contrasena || '********'}</div>
                             ${sale.notas ? `<p class="text-xs text-gray-400 italic mt-1 truncate">"${sale.notas}"</p>` : ''}
                        </div>
                    </div>
                    <div class="flex-shrink-0 w-full md:w-auto pt-4 md:pt-0 border-t md:border-t-0 border-gray-200">
                        <button class="restore-sale-btn w-full md:w-auto px-6 bg-indigo-600 text-white font-semibold py-2.5 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2 shadow-sm" data-id="${sale.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            Restaurar
                        </button>
                    </div>
                `;
                selectors.maintenanceList.appendChild(row);
            });

            selectors.maintenanceList.querySelectorAll('.restore-sale-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleRestoreSale(e.currentTarget.dataset.id));
            });
        };

        const handleRestoreSale = (id) => {
            const sale = allSales.find(s => s.id === id);
            if (!sale) return;

            toggleMaintenanceModal(); // Close maintenance list
            handleEdit(id); // Open edit modal with data

            // Override dates
            const today = dayjs().format('YYYY-MM-DD');
            const remainingDays = sale.diasRestantes !== undefined ? sale.diasRestantes : 0;
            const newEndDate = dayjs().add(remainingDays, 'day').format('YYYY-MM-DD');

            document.getElementById('edit-inicioPlan').value = today;
            document.getElementById('edit-finPlan').value = newEndDate;

            // Reset Profile Selection to force new assignment
            const accountSelect = document.getElementById('edit-platform-account');
            const profileSelect = document.getElementById('edit-profile-select');

            accountSelect.value = "";
            profileSelect.innerHTML = '<option value="">Seleccione cuenta y perfil</option>';
            profileSelect.disabled = true;
            profileSelect.classList.add('bg-gray-200');

            // Set restoration flag
            if (selectors.editSaleStatus) selectors.editSaleStatus.value = 'ACTIVO';

            alert(`Reactivando cliente. Días restantes: ${remainingDays}. \nPor favor asigne una nueva cuenta y perfil.`);
        };

        selectors.closeMaintenanceModalBtn.addEventListener('click', toggleMaintenanceModal);

        const handleMoveToMaintenance = (id) => {
            const sale = allSales.find(s => s.id === id);
            if (!sale) return;

            showConfirmationModal(
                'Mover a Mantenimiento',
                '¿Estás seguro de mover esta venta a mantenimiento? El perfil asociado se liberará y se guardarán los días restantes.',
                async () => {
                    try {
                        // 1. Release profile if exists
                        if (sale.accountId && sale.profileId) {
                            const account = allPlatformAccounts.find(a => a.id === sale.accountId);
                            if (account && account.platform !== 'Canva') {
                                const profileRef = doc(db, "platformAccounts", sale.accountId, "Perfiles", sale.profileId);
                                await updateDoc(profileRef, { estado: 'Disponible', fechaVencimiento: null, clienteId: null });

                                // Update local state for immediate feedback
                                if (account.profiles) {
                                    const profile = account.profiles.find(p => p.id === sale.profileId);
                                    if (profile) {
                                        profile.estado = 'Disponible';
                                        profile.fechaVencimiento = null;
                                        profile.clienteId = null;
                                    }
                                }
                                renderPlatformAccounts();
                            }
                        }

                        // 2. Calculate remaining days
                        const today = dayjs().startOf('day');
                        const end = dayjs(sale.finPlan).startOf('day');
                        const remainingDays = end.diff(today, 'day');

                        // 3. Update sale
                        await updateDoc(doc(db, "sales", id), {
                            estado: 'EN_MANTENIMIENTO',
                            diasRestantes: remainingDays,
                            profileId: null
                        });

                    } catch (error) {
                        console.error("Error al mover a mantenimiento:", error);
                        alert("Error al mover a mantenimiento.");
                    }
                }
            );
        };

        const handleDeleteExpense = (id) => {
            showConfirmationModal(
                'Eliminar Gasto',
                '¿Estás seguro de que quieres eliminar este gasto? Esta acción no se puede deshacer.',
                async () => {
                    try {
                        await deleteDoc(doc(db, "expenses", id));
                    } catch (err) {
                        console.error("Error al eliminar gasto:", err);
                        alert("Error al eliminar el gasto.");
                    }
                }
            );
        };

        window.handleDeleteAccount = async (accountId) => {
            const account = allPlatformAccounts.find(acc => acc.id === accountId);
            if (!account) {
                console.error("Account not found for deletion:", accountId);
                alert("Error: No se encontró la cuenta a eliminar.");
                return;
            }

            // Check if any profile is 'Ocupado'
            if (account.profiles && account.profiles.some(p => p.estado === 'Ocupado')) {
                alert("No se puede eliminar la cuenta porque tiene perfiles en uso. Por favor, finalice o mueva las ventas asociadas antes de continuar.");
                return;
            }

            // If all profiles are available, show confirmation modal
            showConfirmationModal(
                'Eliminar Cuenta',
                '¿Estás seguro de que deseas eliminar esta cuenta? Todos sus perfiles serán borrados y esta acción es irreversible.',
                async () => {
                    try {
                        // 1. Delete all profiles in the subcollection
                        const profilesRef = collection(db, "platformAccounts", accountId, "Perfiles");
                        const profilesSnapshot = await getDocs(profilesRef);
                        const deletePromises = [];
                        profilesSnapshot.forEach((doc) => {
                            deletePromises.push(deleteDoc(doc.ref));
                        });
                        await Promise.all(deletePromises);

                        // 2. Delete the main account document
                        await deleteDoc(doc(db, "platformAccounts", accountId));

                    } catch (error) {
                        console.error("Error al eliminar la cuenta y sus perfiles:", error);
                        alert("Error al eliminar la cuenta. Revisa la consola para más detalles.");
                    }
                }
            );
        };

        onSnapshot(collection(db, "sales"), (snapshot) => {
            allSales = snapshot.docs.map(d => ({
                id: d.id,
                ...d.data()
            }));

            const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');

            if (activeSales.length === 0) {
                selectors.emptyState.classList.remove('hidden');
            } else {
                selectors.emptyState.classList.add('hidden');
            }
            renderPlatformFilters();
            renderAccountPlatformButtons();
            applyFiltersAndRender(activeSales);
            updateFinancialSummary();
            loadDashboardData();
            renderRecentIncome();
            selectors.loadingState.classList.add('hidden');
        }, (e) => {
            console.error("Error al cargar ventas:", e);
            selectors.loadingState.classList.add('hidden');
        });
        onSnapshot(collection(db, "expenses"), (snapshot) => {
            allExpenses = snapshot.docs.map(d => ({
                id: d.id,
                ...d.data()
            })); allExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)); renderExpenses();
            updateFinancialSummary(); loadDashboardData();
        }, (e) => {
            console.error("Error al cargar egresos:", e);
        });

        onSnapshot(doc(db, "config", "platform_order"), (doc) => {
            if (doc.exists()) {
                platformOrder = doc.data().order || [];
                renderPlatformAccounts();
            }
        });

        onSnapshot(collection(db, "platformAccounts"), async (snapshot) => {
            const accountsPromises = snapshot.docs.map(async (accountDoc) => {
                const accountData = { id: accountDoc.id, ...accountDoc.data() };
                const profilesRef = collection(db, "platformAccounts", accountDoc.id, "Perfiles");
                const profilesSnapshot = await getDocs(profilesRef);
                accountData.profiles = profilesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                return accountData;
            });

            allPlatformAccounts = await Promise.all(accountsPromises);

            renderPlatformAccounts();
            renderAccountViewFilters();
            renderAvailableAccounts();
            populatePlatformAccountsDropdowns(selectors.plataformaSelect.value, selectors.platformAccountSelect);
            populateAccountFilterDropdown();
            loadDashboardData();
        }, (e) => { console.error("Error al cargar cuentas:", e); });
        const handleSaveSale = async (e, keepClientData = false) => {
            e.preventDefault();
            const f = selectors.addSaleForm;
            const accountId = f['platform-account'].value;
            const profileId = f['profile-select'].value;
            const plataforma = f.plataforma.value;

            // Capture profile name text before it gets reset
            let profileName = '';
            if (f['profile-select'].selectedIndex !== -1) {
                profileName = f['profile-select'].options[f['profile-select'].selectedIndex].text;
            }

            if (plataforma !== 'Canva' && accountId && !profileId) {
                alert('Por favor, selecciona un perfil para esta cuenta.');
                return;
            }

            // Get account details
            const account = allPlatformAccounts.find(a => a.id === accountId);
            const correo = account ? account.email : '';
            const contrasena = account ? account.password : '';

            // Construct full phone number
            let phoneNumber = f.celular.value.trim();
            if (phoneNumber && !phoneNumber.startsWith('+')) {
                phoneNumber = '+51' + phoneNumber;
            }
            const fullCelular = phoneNumber;

            const newSale = {
                cliente: f.cliente.value,
                celular: fullCelular,
                plataforma: f.plataforma.value === 'Otro' ? selectors.otroPlataformaInput.value : f.plataforma.value,
                precio: parseFloat(f.precio.value),
                inicioPlan: f.inicioPlan.value,
                finPlan: f.finPlan.value,
                correo: correo,
                contrasena: contrasena,
                pin: f.pin.value,
                notas: f.notas.value,
                metodoPago: f.metodoPago.value,
                vendedor: currentSeller,
                accountId,
                profileId,
                createdAt: new Date().toISOString(),
                estado: 'ACTIVO'
            };

            try {
                const docRef = await addDoc(collection(db, "sales"), newSale);

                if (accountId && profileId) {
                    const profileRef = doc(db, "platformAccounts", accountId, "Perfiles", profileId);
                    await updateDoc(profileRef, {
                        estado: 'Ocupado',
                        fechaVencimiento: f.finPlan.value,
                        clienteId: docRef.id
                    });

                    const account = allPlatformAccounts.find(a => a.id === accountId);
                    const profile = account.profiles.find(p => p.id === profileId);
                    if (profile) profile.estado = 'Ocupado';
                    renderPlatformAccounts();
                }

                // Generate message and open modal
                openSuccessSaleModal(newSale, profileName);

                if (keepClientData) {
                    // Keep: cliente, celular, metodoPago, pin, inicioPlan, diasPlan, finPlan
                    // Clear: plataforma, precio, platform-account, profile-select, notas
                    f.plataforma.value = "";
                    selectors.otroPlataformaInput.value = "";
                    f.precio.value = "";
                    f['platform-account'].value = "";
                    f['profile-select'].innerHTML = '<option value="">Selecciona una cuenta madre primero</option>';
                    f['profile-select'].disabled = true;
                    f['profile-select'].classList.add('bg-gray-200');
                    f.notas.value = "";

                    // Reset platform change logic (hides Other input if visible)
                    handlePlatformChange(selectors.plataformaSelect, selectors.otroPlataformaContainer, selectors.otroPlataformaInput);
                } else {
                    f.reset();
                    f.metodoPago.value = ""; // Reiniciar el select
                    handlePlatformChange(selectors.plataformaSelect, selectors.otroPlataformaContainer,
                        selectors.otroPlataformaInput);
                }

            } catch (err) {
                console.error("Error al guardar venta:", err);
                alert("Error al guardar la venta. Revisa la consola (F12).");
            }
        };

        selectors.addSaleForm.addEventListener('submit', (e) => handleSaveSale(e, false));
        document.getElementById('save-and-add-btn').addEventListener('click', (e) => {
            if (selectors.addSaleForm.reportValidity()) {
                handleSaveSale(e, true);
            }
        });

        selectors.editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const f = selectors.editForm;
            const saleId = f['edit-sale-id'].value;
            const originalSale = allSales.find(s => s.id === saleId);

            const newAccountId = f['edit-platform-account'].value;
            const newProfileId = f['edit-profile-select'].value;

            // Check if profile has changed
            if (originalSale.accountId && originalSale.profileId && (originalSale.accountId !== newAccountId ||
                originalSale.profileId !== newProfileId)) {
                // Free up the old profile
                const oldProfileRef = doc(db, "platformAccounts", originalSale.accountId, "Perfiles",
                    originalSale.profileId);
                await updateDoc(oldProfileRef, { estado: 'Disponible', fechaVencimiento: null, clienteId: null });
            }

            // Construct full phone number for edit
            let phoneNumber = f['edit-celular'].value.trim();
            if (phoneNumber && !phoneNumber.startsWith('+')) {
                phoneNumber = '+51' + phoneNumber;
            }
            const fullCelular = phoneNumber;

            // Get account details for edit
            const account = allPlatformAccounts.find(a => a.id === newAccountId);
            const correo = account ? account.email : '';
            const contrasena = account ? account.password : '';

            const updatedSale = {
                cliente: f['edit-cliente'].value,
                celular: fullCelular,
                plataforma: f['edit-plataforma'].value === 'Otro' ? selectors.editOtroPlataformaInput.value :
                    f['edit-plataforma'].value,
                precio: parseFloat(f['edit-precio'].value),
                inicioPlan: f['edit-inicioPlan'].value,
                finPlan: f['edit-finPlan'].value,
                correo: correo,
                contrasena: contrasena,
                pin: f['edit-pin'].value,
                notas: f['edit-notas'].value,
                metodoPago: f['edit-metodoPago'].value,
                accountId: newAccountId,
                profileId: newProfileId
            };

            // Apply status update if flag is set (e.g. Restore)
            if (selectors.editSaleStatus && selectors.editSaleStatus.value === 'ACTIVO') {
                updatedSale.estado = 'ACTIVO';
                updatedSale.diasRestantes = deleteField(); // Remove stored days
            }

            try {
                await updateDoc(doc(db, "sales", saleId), updatedSale);

                // Occupy the new profile
                if (newAccountId && newProfileId) {
                    const newProfileRef = doc(db, "platformAccounts", newAccountId, "Perfiles", newProfileId);
                    await updateDoc(newProfileRef, {
                        estado: 'Ocupado',
                        fechaVencimiento: updatedSale.finPlan,
                        clienteId: saleId
                    });
                }

                // Manually trigger a re-render
                const accountsSnapshot = await getDocs(collection(db, "platformAccounts"));
                const accountsPromises = accountsSnapshot.docs.map(async (accountDoc) => {
                    const accountData = { id: accountDoc.id, ...accountDoc.data() };
                    const profilesRef = collection(db, "platformAccounts", accountDoc.id, "Perfiles");
                    const profilesSnapshot = await getDocs(profilesRef);
                    accountData.profiles = profilesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    return accountData;
                });
                allPlatformAccounts = await Promise.all(accountsPromises);
                renderPlatformAccounts();

                closeModal();
            } catch (err) {
                console.error("Error al actualizar la venta:", err);
                alert("Error al actualizar la venta. Revisa la consola (F12).");
            }
        });
        selectors.addExpenseForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const f =
                selectors.addExpenseForm; const description = f['expense-description'].value; const amount =
                    parseFloat(f['expense-amount'].value); const date = f['expense-date'].value; if (!description || !date
                        || isNaN(amount) || amount <= 0) return; try {
                            await addDoc(collection(db, "expenses"), {
                                description,
                                amount, date
                            }); f.reset(); f['expense-date'].value = dayjs().format('YYYY-MM-DD');
                        } catch (err) {
                            console.error("Error al añadir egreso:", err);
                        }
        });
        selectors.addAccountForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const f =
                selectors.addAccountForm; const newAccount = {
                    platform: f['account-platform'].value, email:
                        f['account-email'].value, password: f['account-password'].value, enlace: f.enlace.value, fechaPago:
                        f.fechaPago.value
                }; try {
                    await addDoc(collection(db, "platformAccounts"), newAccount); f.reset();
                    document.querySelectorAll('#account-platform-buttons button').forEach(b =>
                        b.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600'));
                } catch (err) {
                    console.error("Error al guardar cuenta:", err);
                }
        });
        selectors.searchInput.addEventListener('input', e => {
            currentSearchTerm = e.target.value;
            const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');
            applyFiltersAndRender(activeSales);
        });
        selectors.accountFilter.addEventListener('change', e => {
            activeAccountFilter = e.target.value;
            const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');
            applyFiltersAndRender(activeSales);
        });
        selectors.statusFilter.addEventListener('change', e => {
            activeStatusFilter = e.target.value;
            const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');
            applyFiltersAndRender(activeSales);
        });
        selectors.plataformaSelect.addEventListener('change', () => {
            handlePlatformChange(selectors.plataformaSelect, selectors.otroPlataformaContainer,
                selectors.otroPlataformaInput);
            populatePlatformAccountsDropdowns(selectors.plataformaSelect.value, selectors.platformAccountSelect);
        });
        selectors.editPlataformaSelect.addEventListener('change', () => {
            handlePlatformChange(selectors.editPlataformaSelect, selectors.editOtroPlataformaContainer,
                selectors.editOtroPlataformaInput);
            populatePlatformAccountsDropdowns(selectors.editPlataformaSelect.value, selectors.editPlatformAccountSelect, selectors.editForm['edit-sale-id'].value ? allSales.find(s => s.id === selectors.editForm['edit-sale-id'].value)?.accountId : null);
        });
        selectors.closeModalBtn.addEventListener('click', closeModal);
        selectors.cancelEditBtn.addEventListener('click', closeModal);
        selectors.closeProfilesModalBtn.addEventListener('click', closeProfilesModal);


        const handleRenew = async (saleId) => {
            const sale = allSales.find(s => s.id === saleId);
            if (!sale) return;

            const renewalDays = parseInt(document.getElementById('renewal-days').value);
            const renewalAmount = parseFloat(document.getElementById('renewal-amount').value);

            if (isNaN(renewalDays) || renewalDays <= 0 || isNaN(renewalAmount)) {
                alert('Por favor ingrese valores válidos.');
                return;
            }

            const today = dayjs().startOf('day');
            let newStartDate = today.format('YYYY-MM-DD');

            // Logic: If plan is active (end date in future), add days to current end date.
            // If expired, start from today.
            const currentEndDate = dayjs(sale.finPlan);
            if (currentEndDate.isAfter(today)) {
               newStartDate = currentEndDate.add(1, 'day').format('YYYY-MM-DD');
            }

            const newEndDate = dayjs(newStartDate).add(renewalDays, 'day').format('YYYY-MM-DD');

            try {
                // 1. Create new sale
                const newSale = {
                    ...sale,
                    precio: renewalAmount,
                    inicioPlan: newStartDate,
                    finPlan: newEndDate,
                    createdAt: new Date().toISOString(),
                    estado: 'ACTIVO',
                    metodoPago: 'Falta pagar', // Reset payment status or ask user (assuming 'Falta pagar' for safety)
                    notas: `Renovación de venta anterior. ${sale.notas || ''}`
                };
                delete newSale.id; // Firestore will assign new ID

                const docRef = await addDoc(collection(db, "sales"), newSale);

                // 2. Archive old sale
                await updateDoc(doc(db, "sales", saleId), { estado: 'ARCHIVADO' });

                // 3. Update Profile Expiration (keep it 'Ocupado', but link to new sale)
                if (sale.accountId && sale.profileId) {
                     const account = allPlatformAccounts.find(a => a.id === sale.accountId);
                     if (account && account.platform !== 'Canva') {
                        const profileRef = doc(db, "platformAccounts", sale.accountId, "Perfiles", sale.profileId);
                        await updateDoc(profileRef, {
                            fechaVencimiento: newEndDate,
                            clienteId: docRef.id
                        });

                        // Update local state
                         if (account.profiles) {
                            const profile = account.profiles.find(p => p.id === sale.profileId);
                            if (profile) {
                                profile.fechaVencimiento = newEndDate;
                                profile.clienteId = docRef.id;
                            }
                        }
                        renderPlatformAccounts();
                     }
                }

                closeRenewalModal();
                alert('Renovación exitosa.');
            } catch (e) {
                console.error("Error en renovación:", e);
                alert("Error al renovar la suscripción.");
            }
        };

        document.getElementById('renewal-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const saleId = document.getElementById('renewal-sale-id').value;
            handleRenew(saleId);
        });

        document.getElementById('cancel-renewal-btn').addEventListener('click', closeRenewalModal);
        selectors.platformAccountSelect.addEventListener('change', () =>
            handlePlatformAccountChange(selectors.platformAccountSelect, selectors.profileSelect));
        selectors.editPlatformAccountSelect.addEventListener('change', () =>
            handlePlatformAccountChange(selectors.editPlatformAccountSelect, selectors.editProfileSelect));

        // Auto-fill PIN logic
        const handleProfileChange = (selectElement, pinInputElementId) => {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const pin = selectedOption.getAttribute('data-pin');
            const pinInput = document.getElementById(pinInputElementId);
            if (pin && pinInput) {
                pinInput.value = pin;
            }
        };

        selectors.profileSelect.addEventListener('change', (e) => handleProfileChange(e.target, 'pin'));
        selectors.editProfileSelect.addEventListener('change', (e) => handleProfileChange(e.target, 'edit-pin'));
        selectors.editAccountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = selectors.editAccountForm;
            const id = form['edit-account-id'].value;
            const account = allPlatformAccounts.find(acc => acc.id === id);
            if (!account) return;

            const newPlatform = form['edit-account-platform'].value;
            const updatedData = {
                platform: newPlatform,
                email: form['edit-account-email'].value,
                enlace: form['edit-account-enlace'].value,
                fechaPago: form['edit-account-fechaPago'].value,
            };

            const newPassword = form['edit-account-password'].value;
            if (newPassword) {
                updatedData.password = newPassword;
            }

            try {
                await updateDoc(doc(db, "platformAccounts", id), updatedData);

                // Cascade update if platform changed
                if (newPlatform !== account.platform) {
                    const salesToUpdate = allSales.filter(s => s.accountId === id);
                    const updatePromises = salesToUpdate.map(sale =>
                        updateDoc(doc(db, "sales", sale.id), { plataforma: newPlatform })
                    );
                    await Promise.all(updatePromises);
                }

                closeEditAccountModal();
            } catch (err) {
                console.error("Error al actualizar la cuenta:", err);
                alert("Error al actualizar la cuenta. Revisa la consola (F12).");
            }
        });

        selectors.closeEditAccountModalBtn.addEventListener('click', closeEditAccountModal);
        selectors.cancelEditAccountBtn.addEventListener('click', closeEditAccountModal);
        const diasPlanInput = document.getElementById('diasPlan'); const inicioPlanInput =
            document.getElementById('inicioPlan'); const finPlanInput = document.getElementById('finPlan');
        const editFinPlanInput = document.getElementById('edit-finPlan');

        const calculateEndDate = () => {
            const days = parseInt(diasPlanInput.value, 10);
            const startDate = inicioPlanInput.value;
            if (!isNaN(days) && startDate) {
                const newEndDate = dayjs(startDate).add(days, 'day').format('YYYY-MM-DD');
                finPlanInput.value = newEndDate;
            }
        };

        diasPlanInput.addEventListener('input', calculateEndDate);
        inicioPlanInput.addEventListener('change', calculateEndDate);


        // Set default expense date
        document.getElementById('expense-date').value = dayjs().format('YYYY-MM-DD');


        // Navigation logic
        const navLinks = {
            'nav-dashboard': 'Dashboard',
            'nav-cuentas': 'Cuentas',
            'nav-ventas': 'Ventas',
            'nav-finanzas': 'Finanzas',
            'nav-precios': 'Precios'
        };
        const views = document.querySelectorAll('.view');

        Object.keys(navLinks).forEach(navId => {
            document.getElementById(navId).addEventListener('click', (e) => {
                e.preventDefault();
                const viewId = `${navLinks[navId].toLowerCase()}-view`;

                views.forEach(view => {
                    if (view.id === viewId) {
                        view.classList.remove('hidden');
                    } else {
                        view.classList.add('hidden');
                    }
                });

                // Update active styles for nav links
                document.querySelectorAll('nav a').forEach(link => link.classList.remove('bg-gray-700'));
                document.getElementById(navId).classList.add('bg-gray-700');
            });
        });

        // Set default view
        document.getElementById('nav-dashboard').click();


        // --- Price Calculator Logic ---
        const durations = [1, 3, 6, 12];

        const renderDurationButtons = () => {
            selectors.durationButtons.innerHTML = durations.map(months => `
                    <button class="duration-btn px-4 py-2 rounded-lg font-semibold transition-all ${selectedMonths === months ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                        onclick="setDuration(${months})">
                        ${months} Mes${months > 1 ? 'es' : ''}
                    </button>
                `).join('');
        };

        window.setDuration = (months) => {
            selectedMonths = months;
            renderDurationButtons();
            renderServices();
            updateTicket();
        };

        window.goToSale = (clientName) => {
            document.getElementById('nav-ventas').click();
            if (clientName) {
                selectors.searchInput.value = clientName;
                selectors.searchInput.dispatchEvent(new Event('input'));
            }
        };

        // Helper para contraste de color (YIQ)
        function getContrastYIQ(hexcolor){
            hexcolor = hexcolor.replace("#", "");
            if (hexcolor.length === 3) hexcolor = hexcolor.split('').map(c => c+c).join('');
            var r = parseInt(hexcolor.substr(0,2),16);
            var g = parseInt(hexcolor.substr(2,2),16);
            var b = parseInt(hexcolor.substr(4,2),16);
            var yiq = ((r*299)+(g*587)+(b*114))/1000;
            return (yiq >= 128) ? 'black' : 'white';
        }

        window.updateServiceQuantity = (serviceId, change) => {
            const currentQty = selectedServices.get(serviceId) || 0;
            const newQty = Math.max(0, currentQty + change);
            if (newQty === 0) {
                selectedServices.delete(serviceId);
            } else {
                selectedServices.set(serviceId, newQty);
            }
            renderServices();
            updateTicket();
        };

        const renderServices = () => {
            selectors.servicesGrid.innerHTML = allServices.map(service => {
                const quantity = selectedServices.get(service.id) || 0;
                const isSelected = quantity > 0;
                const price = service.price * selectedMonths;
                const labelHtml = service.label ? `<span class="absolute top-3 left-3 bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full z-20 shadow-sm">${service.label}</span>` : '';

                let cardBgStyle = '';
                if (isSelected) {
                    if (service.bgGradient) {
                        cardBgStyle = `background: ${service.bgGradient};`;
                    } else {
                        cardBgStyle = `background-color: ${service.color};`;
                    }
                }

                const cardStyle = isSelected ? `${cardBgStyle} color: ${getContrastYIQ(service.color)}` : '';
                const textColor = isSelected ? getContrastYIQ(service.color) : '';
                const titleColor = isSelected ? 'inherit' : 'text-gray-800';
                const priceColor = isSelected ? 'inherit' : 'text-indigo-600';
                const subTextColor = isSelected ? 'opacity-80' : 'text-gray-500';

                let deleteBtnHtml = '';
                if (service.isCustom) {
                    deleteBtnHtml = `
                    <div class="absolute bottom-3 right-3 z-20" onclick="event.stopPropagation()">
                         <button onclick="handleDeleteCustomService('${service.id}')"
                            class="w-8 h-8 rounded-full bg-white text-red-600 border border-gray-200 hover:bg-red-50 flex items-center justify-center transition shadow-md" title="Eliminar Plataforma">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                    `;
                }

                let controlsHtml = '';
                if (isSelected) {
                    controlsHtml = `
                    <div class="flex items-center justify-center gap-3 mt-3 w-full" onclick="event.stopPropagation()">
                         <button onclick="updateServiceQuantity('${service.id}', -1)"
                            class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center transition backdrop-blur-sm border border-white/40">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                        </button>
                        <span class="text-xl font-bold w-6 text-center">${quantity}</span>
                        <button onclick="updateServiceQuantity('${service.id}', 1)"
                            class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center transition backdrop-blur-sm border border-white/40">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                    </div>
                    `;
                }

                return `
                    <div class="service-card relative group cursor-pointer transition-all duration-300 transform hover:-translate-y-1 ${isSelected ? 'shadow-xl scale-[1.02]' : 'hover:shadow-lg border border-gray-100'}"
                        style="${cardStyle}"
                        onclick="toggleService('${service.id}')">
                        ${labelHtml}
                        ${deleteBtnHtml}
                        <div class="absolute top-3 right-3 z-10">
                            <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${isSelected ? 'bg-white border-white' : 'border-gray-300 bg-white/80 backdrop-blur-sm'}">
                                ${isSelected ? `<svg class="w-4 h-4" style="color: ${service.color}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>` : ''}
                            </div>
                        </div>
                        <div class="${isSelected ? '' : 'bg-white'} rounded-2xl overflow-hidden h-full flex flex-col">
                            ${isSelected ? '' : `
                            <div class="h-24 relative overflow-hidden flex items-center justify-center" style="background-color: ${service.color}15;">
                                <div class="absolute inset-0 opacity-10 group-hover:opacity-20 transition-opacity" style="background-color: ${service.color};"></div>
                                <span class="text-xl font-black text-center px-2 transform group-hover:scale-110 transition-transform duration-500 drop-shadow-sm" style="color: ${service.color};">${service.name}</span>
                            </div>`}
                            <div class="p-4 flex-grow flex flex-col justify-between ${isSelected ? 'h-full justify-center items-center' : ''}">
                                <div class="w-full">
                                    <h3 class="font-bold mb-1 leading-tight ${titleColor} ${isSelected ? 'text-xl text-center' : ''}">${service.name}</h3>
                                    <div class="flex justify-between items-baseline ${isSelected ? 'flex-col items-center mt-2' : ''}">
                                        <span class="text-xs ${subTextColor}">${selectedMonths} Mes${selectedMonths > 1 ? 'es' : ''}</span>
                                        <span class="text-xl font-bold ${priceColor}">S/${price.toFixed(2)}</span>
                                    </div>
                                    ${controlsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
            }).join('');
        };

        window.toggleService = (serviceId) => {
            const currentQty = selectedServices.get(serviceId) || 0;
            if (currentQty > 0) {
                selectedServices.delete(serviceId); // Toggle off
            } else {
                selectedServices.set(serviceId, 1); // Toggle on (qty 1)
            }
            renderServices();
            updateTicket();
        };

        const updateTicket = () => {
            const items = [];
            let totalRegular = 0;
            let totalCost = 0;
            let totalCount = 0;

            // 1. Calculate Totals
            selectedServices.forEach((qty, id) => {
                const service = allServices.find(s => s.id === id);
                if (service) {
                    const costTotal = service.cost;
                    const costPerProfile = costTotal / service.divider;
                    const costForDuration = costPerProfile * selectedMonths * qty;
                    const priceForDuration = service.price * selectedMonths * qty;

                    totalRegular += priceForDuration;
                    totalCost += costForDuration;
                    totalCount += qty;

                    items.push(`
                            <div class="flex justify-between items-center py-1 border-b border-gray-50 last:border-0">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full mr-2" style="background-color: ${service.color}"></div>
                                    <span class="text-gray-700 text-sm">${service.name} <span class="text-xs text-gray-400">x${qty} (${selectedMonths}m)</span></span>
                                </div>
                                <span class="font-medium text-gray-800">S/${priceForDuration.toFixed(2)}</span>
                            </div>
                        `);
                }
            });

            // 2. Calculate Discount Percentages (Intelligent Algorithm)
            let durationDiscount = 0;
            if (selectedMonths === 2) durationDiscount = 0.10;
            if (selectedMonths === 3) durationDiscount = 0.15;
            if (selectedMonths === 6) durationDiscount = 0.20;
            if (selectedMonths === 12) durationDiscount = 0.25;

            let comboDiscount = 0;
            if (totalCount === 2) comboDiscount = 0.05;
            if (totalCount >= 3) comboDiscount = 0.10;

            const totalDiscountPercent = durationDiscount + comboDiscount;
            let discountAmount = totalRegular * totalDiscountPercent;

            // 3. Safety Floor (Profit Margin Safeguard)
            // Ensure Net Price >= Cost * 1.15 (15% margin)
            const minSafePrice = totalCost * 1.15;
            const proposedPrice = totalRegular - discountAmount;

            if (proposedPrice < minSafePrice) {
                const maxAllowedDiscount = Math.max(0, totalRegular - minSafePrice);
                discountAmount = maxAllowedDiscount;
            }

            const finalPrice = totalRegular - discountAmount;
            const totalProfit = finalPrice - totalCost;

            // 4. Render
            selectors.ticketItems.innerHTML = items.length ? items.join('') : '<p class="text-gray-400 italic text-center py-4">Selecciona servicios para ver el resumen</p>';

            selectors.ticketRegularPrice.textContent = formatCurrency(totalRegular);
            if (discountAmount > 0.01) {
                selectors.ticketRegularPrice.classList.add('line-through', 'text-gray-400');
                selectors.ticketRegularPrice.classList.remove('text-gray-500');
            } else {
                selectors.ticketRegularPrice.classList.remove('line-through', 'text-gray-400');
                selectors.ticketRegularPrice.classList.add('text-gray-500');
            }

            selectors.ticketDiscountAmount.textContent = `-${formatCurrency(discountAmount)}`;
            selectors.ticketFinalPrice.textContent = formatCurrency(finalPrice);
            selectors.ticketProfit.textContent = formatCurrency(totalProfit);

            // Update profit color
            selectors.ticketProfit.className = totalProfit >= 0 ? 'font-medium text-green-600' : 'font-medium text-red-600';
        };

        const toggleConfig = () => {
            selectors.configPanel.classList.toggle('hidden');
            if (!selectors.configPanel.classList.contains('hidden')) {
                renderCostInputs();
            }
        };

        const renderCostInputs = () => {
            selectors.costInputsGrid.innerHTML = allServices.map(service => {
                const unitCost = (service.cost / service.divider).toFixed(2);
                const estimatedProfit = ((service.price * service.divider) - service.cost).toFixed(2);
                const profitColor = estimatedProfit >= 15 ? 'text-green-600' : 'text-orange-500';

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="font-bold text-sm" style="color: ${service.color}">${service.name}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="relative rounded-md shadow-sm max-w-[100px]">
                                <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">S/</span>
                                </div>
                                <input type="number" step="0.1"
                                    value="${service.cost}"
                                    id="cost-${service.id}"
                                    oninput="updateSuggestedPrice('${service.id}', this.value, ${service.divider})"
                                    style="padding-left: 1.75rem;"
                                    class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-7 sm:text-sm border-gray-300 rounded-md py-1">
                            </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm text-gray-500">
                            ${service.divider}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                            S/<span id="unit-cost-${service.id}">${unitCost}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="relative rounded-md shadow-sm max-w-[100px]">
                                <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">S/</span>
                                </div>
                                <input type="number" step="0.1"
                                    value="${service.price}"
                                    id="price-${service.id}"
                                    oninput="updateProfit('${service.id}', ${service.divider})"
                                    style="padding-left: 1.75rem;"
                                    class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-7 sm:text-sm border-gray-300 rounded-md py-1">
                            </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold ${profitColor}" id="profit-container-${service.id}">
                            S/<span id="profit-${service.id}">${estimatedProfit}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        window.updateSuggestedPrice = (id, costVal, divider) => {
            const cost = parseFloat(costVal) || 0;
            const profitMargin = 15; // Ganancia mínima por cuenta

            // 1. Update Unit Cost display
            const unitCost = (cost / divider).toFixed(2);
            const unitCostEl = document.getElementById(`unit-cost-${id}`);
            if(unitCostEl) unitCostEl.textContent = unitCost;

            // 2. Calculate Suggested Price
            const suggested = Math.ceil((cost + profitMargin) / divider);
            const priceInput = document.getElementById(`price-${id}`);
            if (priceInput) {
                priceInput.value = suggested.toFixed(2);
            }

            // 3. Update Profit display
            updateProfit(id, divider);
        };

        window.updateProfit = (id, divider) => {
            const costInput = document.getElementById(`cost-${id}`);
            const priceInput = document.getElementById(`price-${id}`);
            const profitEl = document.getElementById(`profit-${id}`);
            const profitContainer = document.getElementById(`profit-container-${id}`);

            if (costInput && priceInput && profitEl) {
                const cost = parseFloat(costInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;

                const profit = ((price * divider) - cost).toFixed(2);
                profitEl.textContent = profit;

                // Visual feedback for profitability
                if (parseFloat(profit) >= 15) {
                    profitContainer.classList.remove('text-orange-500', 'text-red-600');
                    profitContainer.classList.add('text-green-600');
                } else if (parseFloat(profit) > 0) {
                    profitContainer.classList.remove('text-green-600', 'text-red-600');
                    profitContainer.classList.add('text-orange-500');
                } else {
                    profitContainer.classList.remove('text-green-600', 'text-orange-500');
                    profitContainer.classList.add('text-red-600');
                }
            }
        };

        const saveCosts = async () => {
            const updates = {};
            const saveBtn = selectors.saveCostsBtn;
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Guardando...';
            saveBtn.disabled = true;

            allServices.forEach(service => {
                const costInput = document.getElementById(`cost-${service.id}`);
                const priceInput = document.getElementById(`price-${service.id}`);
                if (costInput && priceInput) {
                    service.cost = parseFloat(costInput.value) || 0;
                    service.price = parseFloat(priceInput.value) || 0;
                    updates[service.id] = { cost: service.cost, price: service.price };
                }
            });

            try {
                await setDoc(doc(db, "config", "service_prices"), updates);
                saveBtn.textContent = '¡Guardado!';
                saveBtn.classList.add('bg-green-600');
            } catch (error) {
                console.error("Error guardando costos:", error);
                saveBtn.textContent = 'Error';
                saveBtn.classList.add('bg-red-600');
            }

            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.classList.remove('bg-green-600', 'bg-red-600');
                saveBtn.disabled = false;
                toggleConfig();
                renderServices();
                updateTicket();
            }, 1500);
        };

        const copyPromo = () => {
            if (selectedServices.size === 0) return;

            const servicesList = Array.from(selectedServices.entries()).map(([id, qty]) => {
                const s = allServices.find(ser => ser.id === id);
                const price = s.price * selectedMonths * qty;
                return `• ${s.name} ${qty > 1 ? `(x${qty})` : ''} (${selectedMonths} Mes${selectedMonths > 1 ? 'es' : ''}): S/${price.toFixed(2)}`;
            }).join('\n');

            const total = selectors.ticketFinalPrice.textContent;
            const text = `🔥 *OFERTA ESPECIAL* 🔥\n\n${servicesList}\n\n💰 *TOTAL: ${total}*\n\n✅ Garantía total\n✅ Soporte 24/7\n\n¡Pide tu cuenta ahora! 🚀`;

            navigator.clipboard.writeText(text).then(() => {
                const btn = selectors.copyPromoBtn;
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>¡Copiado!';
                btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.classList.add('bg-green-500', 'hover:bg-green-600');
                    btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                }, 2000);
            }).catch(err => {
                console.error('Error al copiar:', err);
                alert('No se pudo copiar al portapapeles');
            });
        };

        // Initialize Price Calculator
        renderDurationButtons();
        renderServices();

        selectors.toggleConfigBtn.addEventListener('click', toggleConfig);
        selectors.saveCostsBtn.addEventListener('click', saveCosts);
        selectors.copyPromoBtn.addEventListener('click', copyPromo);

        // --- Custom Services Logic ---
        const toggleAddServiceModal = () => {
            selectors.addCustomServiceModal.classList.toggle('hidden');
            selectors.addCustomServiceModal.classList.toggle('opacity-0');
            selectors.addCustomServiceModal.querySelector('.modal-content').classList.toggle('scale-95');
        };

        selectors.addPlatformBtn.addEventListener('click', toggleAddServiceModal);
        selectors.closeAddServiceModalBtn.addEventListener('click', toggleAddServiceModal);
        selectors.cancelAddServiceBtn.addEventListener('click', toggleAddServiceModal);

        // (Listeners for copy button handled dynamically in openSuccessSaleModal now)
        // Click outside to close
        selectors.successSaleModal.addEventListener('click', (e) => {
            if (e.target === selectors.successSaleModal) {
                closeSuccessSaleModal();
            }
        });

        // Listeners for individual copy buttons in modal
        document.querySelectorAll('.copy-field-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetId = btn.getAttribute('data-target');
                const text = document.getElementById(targetId).textContent;

                navigator.clipboard.writeText(text).then(() => {
                    const icon = btn.querySelector('svg');
                    // Hardcoded original copy icon path to prevent race condition bug
                    const copyIconPath = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>';

                    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
                    btn.classList.add('text-green-500');
                    btn.classList.remove('text-gray-400');

                    setTimeout(() => {
                        icon.innerHTML = copyIconPath;
                        btn.classList.remove('text-green-500');
                        btn.classList.add('text-gray-400');
                    }, 2000);
                });
            });
        });

        selectors.customColorInput.addEventListener('input', (e) => {
            selectors.customColorHex.textContent = e.target.value.toUpperCase();
        });

        const handleAddCustomService = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Guardando...';

            const name = document.getElementById('custom-name').value;
            const color = document.getElementById('custom-color').value;
            const cost = parseFloat(document.getElementById('custom-cost').value);
            const divider = parseInt(document.getElementById('custom-divider').value);
            const price = parseFloat(document.getElementById('custom-price').value);

            if (!name || isNaN(cost) || isNaN(divider) || isNaN(price)) {
                alert('Por favor completa todos los campos correctamente.');
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            const id = 'custom-' + Date.now();
            const newService = {
                id,
                name,
                color,
                cost,
                divider,
                price,
                type: 'monthly',
                isCustom: true
            };

            try {
                // 1. Save Definition to Custom Services Document
                // Use arrayUnion-like approach by reading full array and writing back
                const customServicesDoc = await getDoc(doc(db, "config", "custom_services"));
                let currentCustomServices = [];
                if (customServicesDoc.exists()) {
                    currentCustomServices = customServicesDoc.data().services || [];
                }
                currentCustomServices.push(newService);
                await setDoc(doc(db, "config", "custom_services"), { services: currentCustomServices });

                // 2. Save Initial Costs to Service Prices (optional but good for consistency)
                await setDoc(doc(db, "config", "service_prices"), {
                    [id]: { cost, price }
                }, { merge: true });

                // 3. Update Local State
                allServices.push(newService);

                // Update platformStyles for Accounts view
                platformStyles[newService.name] = {
                    color: 'text-gray-800',
                    bg: newService.color,
                    logo: '',
                    isCustom: true
                };

                // 4. Update UI
                renderServices();
                renderAccountPlatformButtons(); // Refresh account buttons

                if (!selectors.configPanel.classList.contains('hidden')) {
                    renderCostInputs();
                }

                renderPlatformSelects();
                toggleAddServiceModal();
                selectors.addCustomServiceForm.reset();
                selectors.customColorInput.value = '#3b82f6';
                selectors.customColorHex.textContent = '#3B82F6';

            } catch (error) {
                console.error("Error agregando plataforma:", error);
                alert("Hubo un error al guardar la plataforma.");
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        };

        selectors.addCustomServiceForm.addEventListener('submit', handleAddCustomService);

        window.handleDeleteCustomService = (id) => {
            showConfirmationModal(
                'Eliminar Plataforma',
                '¿Estás seguro de que deseas eliminar esta plataforma personalizada? Esta acción no se puede deshacer.',
                async () => {
                    try {
                        // 1. Update Firestore Custom Services
                        const serviceToDelete = allServices.find(s => s.id === id);
                        if (!serviceToDelete) return;

                        const customServicesDoc = await getDoc(doc(db, "config", "custom_services"));
                        if (customServicesDoc.exists()) {
                            let currentCustomServices = customServicesDoc.data().services || [];
                            currentCustomServices = currentCustomServices.filter(s => s.id !== id);
                            await setDoc(doc(db, "config", "custom_services"), { services: currentCustomServices });
                        }

                        // 2. Update Local State
                        allServices = allServices.filter(s => s.id !== id);
                        selectedServices.delete(id); // Deselect if selected

                        // 3. Render
                        renderServices();
                        updateTicket();
                        if (!selectors.configPanel.classList.contains('hidden')) {
                            renderCostInputs();
                        }
                        renderPlatformSelects();

                    } catch (error) {
                        console.error("Error eliminando plataforma:", error);
                        alert("Error al eliminar la plataforma.");
                    }
                }
            );
        };
    }


        onAuthStateChanged(auth, (user) => {
            if (user) {
                const email = user.email;
                if (email === 'renzosamanamud@gmail.com') {
                    currentSeller = 'Renzo';
                } else if (email === 'chariph1007@gmail.com') {
                    currentSeller = 'Charitsa';
                }

                // Start the app immediately to show the UI with skeleton loaders
                startApp();
            } else {
                window.location.href = 'login.html';
            }
        });

        // 3D Tilt Effect Initialization
        function init3DTilt() {
            const cards = document.querySelectorAll('.tilt-card');
            cards.forEach(card => {
                card.addEventListener('mousemove', handleTiltMove);
                card.addEventListener('mouseleave', handleTiltLeave);
            });
        }

        function handleTiltMove(e) {
            const card = e.currentTarget;
            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const maxRotate = 5;
            const rotateX = ((y - centerY) / centerY) * -maxRotate;
            const rotateY = ((x - centerX) / centerX) * maxRotate;
            card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`;
        }

        function handleTiltLeave(e) {
            e.currentTarget.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)';
        }

        // Initialize tilt effect after DOM load (or immediately if inside module and DOM is ready)
        init3DTilt();

        window.startApp = startApp;

        // Toast notification logic
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('loggedin')) {
                const toast = document.createElement('div');
                toast.className = 'toast fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-x-full opacity-0';
                toast.textContent = 'Bienvenido a NineStreaming. Renzo y Charitsa';
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                    toast.classList.add('translate-x-0', 'opacity-100');
                }, 100);

                setTimeout(() => {
                    toast.classList.remove('translate-x-0', 'opacity-100');
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => {
                        toast.remove();
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 500);
                }, 5000);
            }
        });
    </script>

</body>

</html>
