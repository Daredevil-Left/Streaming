<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/es.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .platform-btn img { transition: transform 0.2s ease-in-out; }
        .platform-btn:hover img { transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">

        <header class="mb-8 flex justify-between items-center">
            <div class="text-left">
                <h1 class="text-4xl font-bold text-gray-800">Control de Ventas</h1>
                <p class="text-lg text-gray-500 mt-2">Gestiona tus suscripciones y ventas de forma sencilla.</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="w-48 h-24 sm:w-56 sm:h-28 md:w-64 md:h-32 rounded-lg flex items-center justify-center overflow-hidden">
                    <img src="logo_nuevo.png" alt="Logo" class="max-w-full max-h-full object-contain" onerror="this.replaceWith(document.createElement('div')).textContent='Logo'">
                </div>
                <button id="logout-btn" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Cerrar Sesión</button>
            </div>
        </header>
        
        <div class="lg:flex lg:gap-8">
            <main class="flex-1">
                <div class="bg-white p-6 rounded-2xl shadow-lg mb-8 max-w-5xl mx-auto">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6">Añadir Nueva Venta</h2>
                    <form id="add-sale-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <div><label for="cliente" class="block text-sm font-medium text-gray-600 mb-2">Nombre del Cliente</label><input type="text" id="cliente" name="cliente" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                        <div><label for="plataforma" class="block text-sm font-medium text-gray-600 mb-2">Plataforma</label><select id="plataforma" name="plataforma" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option>Netflix</option> <option>Spotify</option> <option>Disney+</option> <option>HBO Max</option> <option>Amazon Prime Video</option> <option>YouTube Premium</option> <option>Apple Music</option> <option>Apple TV+</option> <option>Crunchyroll</option> <option>Star+</option> <option>Vix+</option> <option>Paramount+</option> <option>MagisTV</option> <option>Otro</option></select></div>
                        <div id="otro-plataforma-container" class="hidden"><label for="otro-plataforma" class="block text-sm font-medium text-gray-600 mb-2">Especificar Plataforma</label><input type="text" id="otro-plataforma" name="otro-plataforma" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="precio" class="block text-sm font-medium text-gray-600 mb-2">Precio Pagado (S/)</label><input type="number" id="precio" name="precio" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                        <div><label for="inicioPlan" class="block text-sm font-medium text-gray-600 mb-2">Inicio del Plan</label><input type="date" id="inicioPlan" name="inicioPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                        <div>
                            <div class="flex items-end gap-2 mb-2">
                                <div class="flex-grow"><label for="diasPlan" class="block text-sm font-medium text-gray-600 mb-2">Nº Días</label><input type="number" id="diasPlan" name="diasPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                                <button type="button" id="calculate-date-btn" class="bg-indigo-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-600 transition h-10">Calcular</button>
                            </div>
                            <div><label for="finPlan" class="block text-sm font-medium text-gray-600 mb-2">Fin del Plan</label><input type="date" id="finPlan" name="finPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                        </div>
                        <div><label for="correo" class="block text-sm font-medium text-gray-600 mb-2">Correo</label><input type="email" id="correo" name="correo" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div class="relative"><label for="contrasena" class="block text-sm font-medium text-gray-600 mb-2">Contraseña</label><input type="password" id="contrasena" name="contrasena" class="w-full px-4 py-2 border border-gray-300 rounded-lg"><button type="button" class="absolute inset-y-0 right-0 top-6 flex items-center px-3 text-gray-500" onclick="togglePasswordVisibility('contrasena', this)"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg></button></div>
                        <div><label for="pin" class="block text-sm font-medium text-gray-600 mb-2">PIN</label><input type="text" id="pin" name="pin" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div class="md:col-span-1 xl:col-span-2"><label for="notas" class="block text-sm font-medium text-gray-600 mb-2">Notas Adicionales</label><input type="text" id="notas" name="notas" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div class="md:col-span-2 lg:col-span-3 xl:col-span-4 text-right self-end"><button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition-transform transform hover:scale-105">Guardar Venta</button></div>
                    </form>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-lg mb-8">
                    <div class="relative flex-grow w-full mb-6"><input type="text" id="search-input" placeholder="Buscar por cliente, plataforma o correo..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"><svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div>
                    <div id="platform-filters" class="flex flex-wrap justify-center gap-3 sm:gap-4"></div>
                </div>

                <div id="sales-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                <div id="loading-state" class="text-center py-10"><p class="text-gray-500">Cargando ventas...</p></div>
                <div id="empty-state" class="hidden text-center py-20 bg-white rounded-2xl shadow-lg"><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg><h3 class="mt-2 text-xl font-medium text-gray-900">No hay ventas registradas</h3><p class="mt-1 text-sm text-gray-500">Comienza añadiendo una nueva venta.</p></div>
            </main>
<aside class="lg:w-1/3 xl:w-1/4 mt-8 lg:mt-0">
    <div class="bg-white p-6 rounded-2xl shadow-lg sticky top-8">
        <h2 class="text-2xl font-semibold text-gray-700 mb-6">Resumen Financiero</h2>
        <div class="space-y-4 mb-6">
            <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg">
                <span class="font-medium text-green-800">Ingresos Totales:</span>
                <span id="total-ingresos" class="font-bold text-xl text-green-900">S/0.00</span>
            </div>
            <div class="flex justify-between items-center p-4 bg-red-50 rounded-lg">
                <span class="font-medium text-red-800">Egresos Totales:</span>
                <span id="total-egresos" class="font-bold text-xl text-red-900">S/0.00</span>
            </div>
            <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg border-t-2 border-blue-200">
                <span class="font-medium text-blue-800">Balance General:</span>
                <span id="balance-total" class="font-bold text-2xl text-blue-900">S/0.00</span>
            </div>
        </div>
        <div class="border-t pt-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Añadir Ingreso Manual</h3>
            <form id="add-income-form" class="space-y-4">
                <div>
                    <label for="income-description" class="block text-sm font-medium text-gray-600 mb-2">Concepto</label>
                    <input type="text" id="income-description" name="income-description" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Ej: Venta directa" required>
                </div>
                <div>
                    <label for="income-amount" class="block text-sm font-medium text-gray-600 mb-2">Monto (S/)</label>
                    <input type="number" id="income-amount" name="income-amount" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Ej: 20.00" required>
                </div>
                <button type="submit" class="w-full bg-green-500 text-white font-semibold py-2 rounded-lg hover:bg-green-600 transition">Añadir Ingreso</button>
            </form>
        </div>
        <div id="incomes-list-container" class="border-t pt-6 mt-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Últimos Ingresos Manuales</h3>
            <div id="incomes-list" class="space-y-2 max-h-48 overflow-y-auto">
                <p class="text-sm text-gray-400">No hay ingresos manuales.</p>
            </div>
        </div>
        <div class="border-t pt-6 mt-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Añadir Egreso</h3>
            <form id="add-expense-form" class="space-y-4">
                <div>
                    <label for="expense-description" class="block text-sm font-medium text-gray-600 mb-2">Descripción</label>
                    <input type="text" id="expense-description" name="expense-description" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Ej: Pago de internet" required>
                </div>
                <div>
                    <label for="expense-amount" class="block text-sm font-medium text-gray-600 mb-2">Monto (S/)</label>
                    <input type="number" id="expense-amount" name="expense-amount" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Ej: 50.00" required>
                </div>
                <button type="submit" class="w-full bg-red-500 text-white font-semibold py-2 rounded-lg hover:bg-red-600 transition">Añadir Gasto</button>
            </form>
        </div>
        <div id="expenses-list-container" class="border-t pt-6 mt-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Últimos Egresos</h3>
            <div id="expenses-list" class="space-y-2 max-h-48 overflow-y-auto">
                <p class="text-sm text-gray-400">No hay egresos registrados.</p>
            </div>
        </div>
    </div>
</aside>
           
        </div>

    </div>

    <script>
        function togglePasswordVisibility(inputId, button) { /* ... tu función no necesita cambios ... */ }
    </script>

<script type="module">
    // Importamos las herramientas de Firebase, AÑADIENDO LAS DE AUTENTICACIÓN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // Tus credenciales
    const firebaseConfig = {
        apiKey: "AIzaSyCaYzhFY6keITDiN2Dn7kyEAnGPDt0hu2A",
        authDomain: "streaming-d0fac.firebaseapp.com",
        projectId: "streaming-d0fac",
        storageBucket: "streaming-d0fac.firebasestorage.app",
        messagingSenderId: "1017661259961",
        appId: "1:1017661259961:web:9303ad97c753fe95379b68"
    };
    
    // Conectamos con los servicios de Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app); // Conectamos con el servicio de autenticación

    
    // =======================================================
    //          GUARDIA DE SEGURIDAD DE LA PÁGINA
    // =======================================================
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // ✅ SI HAY UN USUARIO CONECTADO, MOSTRAMOS LA APP Y EJECUTAMOS TODO
            document.getElementById('app').classList.remove('hidden');

            // --- Lógica del botón de Cerrar Sesión ---
            const logoutButton = document.getElementById('logout-btn');
            logoutButton.addEventListener('click', () => {
                signOut(auth).catch((error) => console.error("Error al cerrar sesión", error));
            });

            // --- AQUÍ COMIENZA TODO TU CÓDIGO ANTERIOR ---
            dayjs.extend(dayjs_plugin_relativeTime);
            dayjs.locale('es');
            const platformStyles = { 'Netflix':{color:'text-red-600',fallback:'bg-red-500'},'Spotify':{color:'text-green-500',fallback:'bg-green-500'},'Disney+':{color:'text-blue-900',fallback:'bg-blue-900'},'HBO Max':{color:'text-purple-600',fallback:'bg-purple-600'},'Amazon Prime Video':{color:'text-blue-400',fallback:'bg-blue-400'},'YouTube Premium':{color:'text-red-500',fallback:'bg-red-500'},'Apple Music':{color:'text-pink-500',fallback:'bg-pink-500'},'Apple TV+':{color:'text-gray-800',fallback:'bg-gray-800'},'Crunchyroll':{color:'text-orange-500',fallback:'bg-orange-500'},'Star+':{color:'text-gray-900',fallback:'bg-gray-900'},'Vix+':{color:'text-yellow-400',fallback:'bg-yellow-400'},'Paramount+':{color:'text-blue-800',fallback:'bg-blue-800'},'MagisTV':{color:'text-blue-500',fallback:'bg-blue-500'},'Otro':{color:'text-gray-500',fallback:'bg-gray-500'}};
            let allSales = []; let allExpenses = []; let allIncomes = []; let activePlatformFilter = 'Todos'; let currentSearchTerm = '';
            const selectors = {addSaleForm:document.getElementById('add-sale-form'),salesList:document.getElementById('sales-list'),searchInput:document.getElementById('search-input'),loadingState:document.getElementById('loading-state'),emptyState:document.getElementById('empty-state'),editModal:document.getElementById('edit-modal'),editForm:document.getElementById('edit-sale-form'),closeModalBtn:document.getElementById('close-modal'),cancelEditBtn:document.getElementById('cancel-edit'),customAlert:document.getElementById('custom-alert'),alertConfirmBtn:document.getElementById('alert-confirm'),alertCancelBtn:document.getElementById('alert-cancel'),plataformaSelect:document.getElementById('plataforma'),otroPlataformaContainer:document.getElementById('otro-plataforma-container'),otroPlataformaInput:document.getElementById('otro-plataforma'),editPlataformaSelect:document.getElementById('edit-plataforma'),editOtroPlataformaContainer:document.getElementById('edit-otro-plataforma-container'),editOtroPlataformaInput:document.getElementById('edit-otro-plataforma'),platformFilters:document.getElementById('platform-filters'),totalIngresos:document.getElementById('total-ingresos'),totalEgresos:document.getElementById('total-egresos'),balanceTotal:document.getElementById('balance-total'),addExpenseForm:document.getElementById('add-expense-form'),expensesList:document.getElementById('expenses-list'),addIncomeForm:document.getElementById('add-income-form'),incomesList:document.getElementById('incomes-list')};
            let confirmCallback = null;
            const formatCurrency = (amount) => `S/${(amount||0).toFixed(2)}`;
            const getPlatformHtml = (platformName) => { const style=platformStyles[platformName]||platformStyles['Otro']; return `<span class="font-bold ${style.color}">${platformName}</span>`};
            const handlePlatformChange = (select, container, input) => { if (select.value==='Otro') { container.classList.remove('hidden'); input.required = true; } else { container.classList.add('hidden'); input.required = false; input.value = ''; }};
            const openModal = () => { selectors.editModal.classList.remove('hidden'); setTimeout(() => { selectors.editModal.classList.remove('opacity-0'); selectors.editModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10); };
            const closeModal = () => { selectors.editModal.classList.add('opacity-0'); selectors.editModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => selectors.editModal.classList.add('hidden'), 300); };
            const showCustomConfirm = (title, message, onConfirm) => { document.getElementById('alert-title').textContent = title; document.getElementById('alert-message').textContent = message; confirmCallback = onConfirm; selectors.customAlert.classList.remove('hidden'); setTimeout(() => { selectors.customAlert.classList.remove('opacity-0'); selectors.customAlert.querySelector('.modal-content').classList.remove('scale-95'); }, 10); };
            const hideCustomConfirm = () => { selectors.customAlert.classList.add('opacity-0'); selectors.customAlert.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => { selectors.customAlert.classList.add('hidden'); confirmCallback = null; }, 300); };
            const updateFinancialSummary = () => { const salesIncome = allSales.reduce((sum, sale) => sum + (sale.precio || 0), 0); const manualIncome = allIncomes.reduce((sum, income) => sum + (income.amount || 0), 0); const totalIngresos = salesIncome + manualIncome; const totalEgresos = allExpenses.reduce((sum, expense) => sum + (expense.amount || 0), 0); const balance = totalIngresos - totalEgresos; selectors.totalIngresos.textContent = formatCurrency(totalIngresos); selectors.totalEgresos.textContent = formatCurrency(totalEgresos); selectors.balanceTotal.textContent = formatCurrency(balance); selectors.balanceTotal.classList.toggle('text-red-900', balance < 0); selectors.balanceTotal.classList.toggle('text-blue-900', balance >= 0); };
            const applyFiltersAndRender = () => { let filteredSales = [...allSales]; if (activePlatformFilter!=='Todos') { filteredSales=filteredSales.filter(sale=>sale.plataforma===activePlatformFilter); } if (currentSearchTerm) { const term=currentSearchTerm.toLowerCase(); filteredSales=filteredSales.filter(sale=>sale.cliente.toLowerCase().includes(term)||sale.plataforma.toLowerCase().includes(term)||(sale.correo&&sale.correo.toLowerCase().includes(term))); } renderSales(filteredSales); };
            const renderPlatformFilters = () => { selectors.platformFilters.innerHTML=''; const platforms=['Todos', ...Object.keys(platformStyles)]; platforms.forEach(platform=>{ const btn=document.createElement('button'); btn.dataset.platform=platform; const activeClasses='border-indigo-500 bg-indigo-50'; const inactiveClasses='border-transparent hover:bg-gray-100'; btn.className=`p-2 rounded-lg border-2 transition-all duration-200 font-semibold ${activePlatformFilter===platform?activeClasses:inactiveClasses}`; if (platform==='Todos') { btn.textContent='Todos'; } else { btn.innerHTML=getPlatformHtml(platform); } btn.addEventListener('click', ()=>{ activePlatformFilter=platform; document.querySelectorAll('#platform-filters button').forEach(b=>{ b.className=`p-2 rounded-lg border-2 transition-all duration-200 font-semibold ${inactiveClasses}`; }); btn.className=`p-2 rounded-lg border-2 transition-all duration-200 font-semibold ${activeClasses}`; applyFiltersAndRender(); }); selectors.platformFilters.appendChild(btn); }); };
            const renderSales = (sales) => { selectors.salesList.innerHTML=''; if (allSales.length===0) { selectors.emptyState.classList.remove('hidden'); return; } selectors.emptyState.classList.add('hidden'); if (sales.length===0) { selectors.salesList.innerHTML=`<p class="text-gray-500 md:col-span-2 xl:col-span-3 text-center">No se encontraron ventas que coincidan.</p>`; return; } sales.forEach(sale=>{ const now=dayjs(); const endDate=dayjs(sale.finPlan); const diffDays=endDate.diff(now, 'day'); let status={text:'Activo',color:'green'}; if (diffDays < 0) status={text:'Vencido',color:'red'}; else if (diffDays<=7) status={text:'Próximo a Vencer',color:'yellow'}; const card=document.createElement('div'); card.className=`bg-white rounded-2xl shadow-lg p-5 flex flex-col justify-between border-l-4 border-${status.color}-500 transition-transform transform hover:-translate-y-1`; card.innerHTML=`<div><div class="flex justify-between items-start"><div class="flex items-center gap-3"><h3 class="text-lg font-bold text-gray-800">${sale.cliente}</h3></div><span class="text-xs font-semibold py-1 px-2 uppercase rounded-full text-${status.color}-600 bg-${status.color}-200">${status.text}</span></div><div class="my-4 border-t border-gray-100"></div><div class="space-y-2 text-sm text-gray-700"><div class="flex justify-between"><span class="font-medium text-gray-500">Plataforma:</span>${getPlatformHtml(sale.plataforma)}</div><div class="flex justify-between"><span class="font-medium text-gray-500">Precio Pagado:</span><span class="font-bold text-gray-800">${formatCurrency(sale.precio)}</span></div><div class="flex justify-between"><span class="font-medium text-gray-500">Vence:</span><span>${endDate.format('DD/MM/YYYY')} (${endDate.fromNow()})</span></div></div>${sale.notas ? `<p class="mt-3 text-xs text-gray-500 bg-gray-50 p-2 rounded-lg">Nota: ${sale.notas}</p>` : ''}</div><div class="flex justify-end gap-3 mt-5"><button class="edit-btn text-sm font-medium text-indigo-600 hover:text-indigo-800" data-id="${sale.id}">Editar</button><button class="delete-btn text-sm font-medium text-red-600 hover:text-red-800" data-id="${sale.id}">Eliminar</button></div>`; selectors.salesList.appendChild(card); }); selectors.salesList.querySelectorAll('.edit-btn').forEach(b=>b.addEventListener('click', e=>handleEdit(e.currentTarget.dataset.id))); selectors.salesList.querySelectorAll('.delete-btn').forEach(b=>b.addEventListener('click', e=>handleDeleteSale(e.currentTarget.dataset.id))); };
            const renderExpenses = () => { selectors.expensesList.innerHTML=''; if (allExpenses.length===0) { selectors.expensesList.innerHTML='<p class="text-sm text-gray-400">No hay egresos registrados.</p>'; return; } allExpenses.forEach(expense=>{ const item=document.createElement('div'); item.className='flex justify-between items-center text-sm p-2 rounded-md hover:bg-gray-50'; item.innerHTML=`<div class="flex-1 truncate pr-2"><p class="text-gray-700">${expense.description}</p></div><div class="flex items-center gap-2"><span class="font-semibold text-red-600">${formatCurrency(expense.amount)}</span><button class="delete-expense-btn text-gray-400 hover:text-red-600" data-id="${expense.id}"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button></div>`; selectors.expensesList.appendChild(item); }); selectors.expensesList.querySelectorAll('.delete-expense-btn').forEach(b=>b.addEventListener('click', e=>handleDeleteExpense(e.currentTarget.dataset.id))); };
            const renderIncomes = () => { selectors.incomesList.innerHTML=''; if (allIncomes.length===0) { selectors.incomesList.innerHTML='<p class="text-sm text-gray-400">No hay ingresos manuales.</p>'; return; } allIncomes.forEach(income=>{ const item=document.createElement('div'); item.className='flex justify-between items-center text-sm p-2 rounded-md hover:bg-gray-50'; item.innerHTML=`<div class="flex-1 truncate pr-2"><p class="text-gray-700">${income.description}</p></div><div class="flex items-center gap-2"><span class="font-semibold text-green-600">${formatCurrency(income.amount)}</span><button class="delete-income-btn text-gray-400 hover:text-red-600" data-id="${income.id}"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button></div>`; selectors.incomesList.appendChild(item); }); selectors.incomesList.querySelectorAll('.delete-income-btn').forEach(b=>b.addEventListener('click', e=>handleDeleteIncome(e.currentTarget.dataset.id))); };
            const handleEdit = (id) => { const sale = allSales.find(s => s.id === id); if(!sale) return; const f = selectors.editForm; f['edit-sale-id'].value = sale.id; f['edit-cliente'].value = sale.cliente; f['edit-precio'].value = sale.precio; f['edit-inicioPlan'].value = sale.inicioPlan; f['edit-finPlan'].value = sale.finPlan; f['edit-correo'].value = sale.correo || ''; f['edit-contrasena'].value = sale.contrasena || ''; f['edit-pin'].value = sale.pin || ''; f['edit-notas'].value = sale.notas || ''; const standardPlatforms = Array.from(f['edit-plataforma'].options).map(o => o.value); if (standardPlatforms.includes(sale.plataforma)) { f['edit-plataforma'].value = sale.plataforma; } else { f['edit-plataforma'].value = 'Otro'; selectors.editOtroPlataformaInput.value = sale.plataforma; } handlePlatformChange(selectors.editPlataformaSelect, selectors.editOtroPlataformaContainer, selectors.editOtroPlataformaInput); openModal(); };
            const handleDeleteSale = (id) => showCustomConfirm('Eliminar Venta', '¿Estás seguro? No se puede deshacer.', async () => { try { await deleteDoc(doc(db, "sales", id)); } catch (e) { console.error(e); } });
            const handleDeleteExpense = (id) => showCustomConfirm('Eliminar Egreso', '¿Estás seguro de eliminar este gasto?', async () => { try { await deleteDoc(doc(db, "expenses", id)); } catch (e) { console.error(e); } });
            const handleDeleteIncome = (id) => showCustomConfirm('Eliminar Ingreso', '¿Estás seguro de eliminar este ingreso?', async () => { try { await deleteDoc(doc(db, "incomes", id)); } catch (e) { console.error(e); } });
            onSnapshot(collection(db, "sales"), (snapshot) => { allSales = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); allSales.sort((a, b) => new Date(a.finPlan) - new Date(b.finPlan)); selectors.loadingState.classList.add('hidden'); if (allSales.length === 0) selectors.emptyState.classList.remove('hidden'); else selectors.emptyState.classList.add('hidden'); renderPlatformFilters(); applyFiltersAndRender(); updateFinancialSummary(); }, (e) => { console.error("Error al cargar ventas:", e); });
            onSnapshot(collection(db, "expenses"), (snapshot) => { allExpenses = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); allExpenses.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); renderExpenses(); updateFinancialSummary(); }, (e) => { console.error("Error al cargar egresos:", e); });
            onSnapshot(collection(db, "incomes"), (snapshot) => { allIncomes = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); allIncomes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); renderIncomes(); updateFinancialSummary(); }, (e) => { console.error("Error al cargar ingresos:", e); });
            selectors.addSaleForm.addEventListener('submit', async (e) => { e.preventDefault(); const f = selectors.addSaleForm; const newSale = { cliente: f.cliente.value, plataforma: f.plataforma.value === 'Otro' ? selectors.otroPlataformaInput.value : f.plataforma.value, precio: parseFloat(f.precio.value), inicioPlan: f.inicioPlan.value, finPlan: f.finPlan.value, correo: f.correo.value, contrasena: f.contrasena.value, pin: f.pin.value, notas: f.notas.value, createdAt: new Date().toISOString() }; try { await addDoc(collection(db, "sales"), newSale); f.reset(); handlePlatformChange(selectors.plataformaSelect, selectors.otroPlataformaContainer, selectors.otroPlataformaInput); } catch (err) { console.error("Error al guardar venta:", err); alert("Error al guardar la venta. Revisa la consola (F12).") } });
            selectors.editForm.addEventListener('submit', async (e) => { e.preventDefault(); const f = selectors.editForm; const id = f['edit-sale-id'].value; const updated = { cliente: f['edit-cliente'].value, plataforma: f['edit-plataforma'].value === 'Otro' ? selectors.editOtroPlataformaInput.value : f['edit-plataforma'].value, precio: parseFloat(f['edit-precio'].value), inicioPlan: f['edit-inicioPlan'].value, finPlan: f['edit-finPlan'].value, correo: f['edit-correo'].value, contrasena: f['edit-contrasena'].value, pin: f['edit-pin'].value, notas: f['edit-notas'].value, }; try { await updateDoc(doc(db, "sales", id), updated); closeModal(); } catch (err) { console.error(err); } });
            selectors.addExpenseForm.addEventListener('submit', async (e) => { e.preventDefault(); const f = selectors.addExpenseForm; const description = f['expense-description'].value; const amount = parseFloat(f['expense-amount'].value); if (!description || isNaN(amount) || amount <= 0) return; try { await addDoc(collection(db, "expenses"), { description, amount, createdAt: new Date().toISOString() }); f.reset(); } catch (err) { console.error("Error al añadir egreso:", err); } });
            selectors.addIncomeForm.addEventListener('submit', async (e) => { e.preventDefault(); const f = selectors.addIncomeForm; const description = f['income-description'].value; const amount = parseFloat(f['income-amount'].value); if (!description || isNaN(amount) || amount <= 0) return; try { await addDoc(collection(db, "incomes"), { description, amount, createdAt: new Date().toISOString() }); f.reset(); } catch (err) { console.error("Error al añadir ingreso:", err); } });
            selectors.searchInput.addEventListener('input', e => { currentSearchTerm = e.target.value; applyFiltersAndRender(); });
            selectors.plataformaSelect.addEventListener('change', () => handlePlatformChange(selectors.plataformaSelect, selectors.otroPlataformaContainer, selectors.otroPlataformaInput));
            selectors.editPlataformaSelect.addEventListener('change', () => handlePlatformChange(selectors.editPlataformaSelect, selectors.editOtroPlataformaContainer, selectors.editOtroPlataformaInput));
            selectors.closeModalBtn.addEventListener('click', closeModal);
            selectors.cancelEditBtn.addEventListener('click', closeModal);
            selectors.alertConfirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideCustomConfirm(); });
            selectors.alertCancelBtn.addEventListener('click', hideCustomConfirm);
            const diasPlanInput = document.getElementById('diasPlan'); const inicioPlanInput = document.getElementById('inicioPlan'); const finPlanInput = document.getElementById('finPlan'); const calculateDateBtn = document.getElementById('calculate-date-btn');
            const editDiasPlanInput = document.getElementById('edit-diasPlan'); const editInicioPlanInput = document.getElementById('edit-inicioPlan'); const editFinPlanInput = document.getElementById('edit-finPlan'); const editCalculateDateBtn = document.getElementById('edit-calculate-date-btn');
            const calculateEndDate = (diasInput, inicioInput, finInput) => { const dias = parseInt(diasInput.value, 10); const inicio = inicioInput.value; if (!isNaN(dias) && inicio) { const fin = dayjs(inicio).add(dias, 'day').format('YYYY-MM-DD'); finInput.value = fin; } };
            diasPlanInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); calculateEndDate(diasPlanInput, inicioPlanInput, finPlanInput); } });
            calculateDateBtn.addEventListener('click', () => calculateEndDate(diasPlanInput, inicioPlanInput, finPlanInput));
            inicioPlanInput.addEventListener('change', () => calculateEndDate(diasPlanInput, inicioPlanInput, finPlanInput));
            editDiasPlanInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); calculateEndDate(editDiasPlanInput, editInicioPlanInput, editFinPlanInput); } });
            editCalculateDateBtn.addEventListener('click', () => calculateEndDate(editDiasPlanInput, editInicioPlanInput, editFinPlanInput));
            editInicioPlanInput.addEventListener('change', () => calculateEndDate(editDiasPlanInput, editInicioPlanInput, editFinPlanInput));

        } else {
            // ❌ SI NO HAY NADIE CONECTADO, LO EXPULSAMOS A LA PÁGINA DE LOGIN
            window.location.href = 'login.html';
        }
    });
</script>

</body>
</html>