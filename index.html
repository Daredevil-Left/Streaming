<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo_nuevo.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/es.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .platform-btn img { transition: transform 0.2s ease-in-out; }
        .platform-btn:hover img { transform: scale(1.1); }
        .sidebar-text {
            display: none; /* Oculto por defecto */
            transition: opacity 0.3s ease-in-out;
            white-space: nowrap;
            opacity: 0;
        }
        #sidebar:hover .sidebar-text {
            display: inline-block; /* Mostrar en hover */
            opacity: 1;
        }
        /* Nuevo: Centrar íconos cuando el sidebar está colapsado */
        #sidebar:not(:hover) nav a, #sidebar:not(:hover) #logout-btn {
            justify-content: center;
        }
        .toast {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="flex h-screen bg-gray-100 hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="w-16 hover:w-64 bg-gray-800 text-white flex flex-col transition-all duration-300 ease-in-out overflow-hidden">
            <div class="flex items-center justify-center h-20 border-b border-gray-700">
                <img src="logo_nuevo.png" alt="Logo" class="h-10 w-10 object-contain">
            </div>
            <nav class="flex-1 px-2 py-4 space-y-2">
                <a href="#" id="nav-dashboard" class="flex items-center py-2.5 px-2 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span class="ml-4 sidebar-text">Dashboard</span>
                </a>
                <a href="#" id="nav-cuentas" class="flex items-center py-2.5 px-2 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <span class="ml-4 sidebar-text">Cuentas</span>
                </a>
                <a href="#" id="nav-ventas" class="flex items-center py-2.5 px-2 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span class="ml-4 sidebar-text">Ventas</span>
                </a>
                <a href="#" id="nav-finanzas" class="flex items-center py-2.5 px-2 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
                    <span class="ml-4 sidebar-text">Finanzas</span>
                </a>
            </nav>
            <div class="px-2 py-4">
                <button id="logout-btn" class="w-full flex items-center py-2.5 px-2 rounded-md bg-red-500 hover:bg-red-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span class="ml-4 sidebar-text">Cerrar Sesión</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-md">
                <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                    <h1 id="main-header" class="text-2xl font-bold text-gray-800">Cuentas</h1>
                </div>
            </header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 md:p-8">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view hidden">
                    <!-- KPI Widgets -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center">
                            <div class="bg-green-100 p-4 rounded-full">
                                <!-- Icono Sol -->
                                <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-sm font-medium text-gray-500">Ventas de Hoy</h3>
                                <p id="kpi-sales-today" class="text-2xl font-bold text-gray-800">S/0.00</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center">
                            <div class="bg-green-100 p-4 rounded-full">
                                <!-- Icono Billete -->
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-sm font-medium text-gray-500">Ventas del Mes</h3>
                                <p id="kpi-sales-month" class="text-2xl font-bold text-gray-800">S/0.00</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center">
                            <div class="bg-blue-100 p-4 rounded-full">
                                <!-- Icono Usuario -->
                                <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.978 5.978 0 0112 13a5.979 5.979 0 013 1.003m-3-1.003A4.002 4.002 0 0112 6.354a4.002 4.002 0 013 4.646m-3-4.646a4 4 0 010 5.292m0 0a4 4 0 01-3 1.003m3-1.003a4 4 0 013-1.003m0 0A5.978 5.978 0 0012 13a5.979 5.979 0 00-3 1.003m7.5 0C19.072 16.59 16.32 18 13.5 18c-2.82 0-5.572-1.41-7.5-3.997"></path></svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-sm font-medium text-gray-500">Clientes Activos</h3>
                                <p id="kpi-active-clients" class="text-2xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Alerts and Quick Access -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Próximos Vencimientos (Siguientes 5 días)</h3>
                            <div id="alerts-section" class="space-y-3">
                                <!-- Alertas se cargarán aquí -->
                                <p class="text-gray-500">No hay vencimientos próximos.</p>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Accesos Rápidos</h3>
                                <div class="flex flex-col space-y-3">
                                    <button id="quick-add-sale" class="w-full flex items-center justify-center bg-blue-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-blue-700 transition">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        Añadir Nueva Venta
                                    </button>
                                    <button id="quick-add-expense" class="w-full flex items-center justify-center bg-red-500 text-white font-semibold px-4 py-3 rounded-lg hover:bg-red-600 transition">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"></path></svg>
                                        Añadir Egreso
                                    </button>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Resumen Financiero</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center"><span class="font-medium text-green-700">Ingresos:</span><span id="summary-ingresos" class="font-bold text-lg text-green-800">S/0.00</span></div>
                                    <div class="flex justify-between items-center"><span class="font-medium text-red-700">Egresos:</span><span id="summary-egresos" class="font-bold text-lg text-red-800">S/0.00</span></div>
                                    <div class="border-t pt-3 mt-2 flex justify-between items-center"><span class="font-bold text-blue-800">Balance:</span><span id="summary-balance" class="font-bold text-xl text-blue-900">S/0.00</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cuentas View -->
                <div id="cuentas-view" class="view">
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg mb-8 max-w-5xl mx-auto">
                        <div class="flex justify-between items-center cursor-pointer" id="toggle-mother-accounts-section">
                            <h2 class="text-xl md:text-2xl font-semibold text-gray-700">Añadir Nueva Cuenta Madre</h2>
                            <svg id="toggle-mother-accounts-icon" class="w-6 h-6 transition-transform transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <div id="collapsible-mother-accounts-content" class="hidden mt-6">
                            <form id="add-mother-account-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-600 mb-2">Plataforma</label>
                                    <div id="mother-account-platform-buttons" class="flex flex-wrap gap-2"></div>
                                    <input type="hidden" id="mother-account-platform" name="mother-account-platform" required>
                                </div>
                                <div>
                                    <label for="mother-account-email" class="block text-sm font-medium text-gray-600 mb-2">Correo</label>
                                    <input type="email" id="mother-account-email" name="mother-account-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                </div>
                                <div class="relative">
                                    <label for="mother-account-password" class="block text-sm font-medium text-gray-600 mb-2">Contraseña</label>
                                    <input type="password" id="mother-account-password" name="mother-account-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                    <button type="button" class="absolute inset-y-0 right-0 top-6 flex items-center px-3 text-gray-500" onclick="togglePasswordVisibility('mother-account-password', this)">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                    </button>
                                </div>
                                <div>
                                     <label for="mother-account-payment-date" class="block text-sm font-medium text-gray-600 mb-2">Fecha de Pago Propia</label>
                                     <input type="date" id="mother-account-payment-date" name="mother-account-payment-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div class="md:col-span-2 text-right">
                                    <button type="submit" class="bg-blue-600 w-full md:w-auto text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 transition">Añadir Cuenta Madre</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg max-w-5xl mx-auto">
                        <h2 class="text-xl md:text-2xl font-semibold text-gray-700 mb-4">Inventario de Cuentas</h2>
                        <div id="mother-accounts-list" class="space-y-4">
                            <!-- Las cuentas madre se renderizarán aquí -->
                        </div>
                    </div>
                </div>

                <!-- Ventas View -->
                <div id="ventas-view" class="view hidden">
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg mb-8 max-w-5xl mx-auto">
                        <h2 class="text-xl md:text-2xl font-semibold text-gray-700 mb-6">Añadir Nueva Venta</h2>
                        <form id="add-sale-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            <div><label for="cliente" class="block text-sm font-medium text-gray-600 mb-2">Nombre del Cliente</label><input type="text" id="cliente" name="cliente" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            <div><label for="plataforma" class="block text-sm font-medium text-gray-600 mb-2">Plataforma</label><select id="plataforma" name="plataforma" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option>Netflix</option> <option>Spotify</option> <option>Disney+</option> <option>HBO Max</option> <option>Amazon Prime Video</option> <option>YouTube Premium</option> <option>Apple Music</option> <option>Apple TV+</option> <option>Crunchyroll</option> <option>Canva</option> <option>IPTV Premium</option> <option>Vix+</option> <option>Paramount+</option> <option>Otro</option></select></div>
                            <div id="otro-plataforma-container" class="hidden"><label for="otro-plataforma" class="block text-sm font-medium text-gray-600 mb-2">Especificar Plataforma</label><input type="text" id="otro-plataforma" name="otro-plataforma" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                            <div><label for="precio" class="block text-sm font-medium text-gray-600 mb-2">Precio Pagado (S/)</label><input type="number" id="precio" name="precio" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            <div><label for="inicioPlan" class="block text-sm font-medium text-gray-600 mb-2">Inicio del Plan</label><input type="date" id="inicioPlan" name="inicioPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            <div>
                                <div class="flex items-end gap-2">
                                    <div class="flex-grow"><label for="diasPlan" class="block text-sm font-medium text-gray-600 mb-2">Nº Días</label><input type="number" id="diasPlan" name="diasPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                                    <button type="button" id="calculate-date-btn" class="bg-indigo-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-600 transition h-10">Calcular</button>
                                </div>
                                <div class="mt-2"><label for="finPlan" class="block text-sm font-medium text-gray-600 mb-2">Fin del Plan</label><input type="date" id="finPlan" name="finPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            </div>
                            <div>
                                <label for="platform-account" class="block text-sm font-medium text-gray-600 mb-2">Cuenta de Plataforma</label>
                                <select id="platform-account" name="platform-account" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="">Sin cuenta / Ingresar manualmente</option>
                                </select>
                            </div>
                            <div class="manual-credentials">
                                <label for="correo" class="block text-sm font-medium text-gray-600 mb-2">Correo</label>
                                <input type="email" id="correo" name="correo" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="manual-credentials relative">
                                <label for="contrasena" class="block text-sm font-medium text-gray-600 mb-2">Contraseña</label>
                                <input type="password" id="contrasena" name="contrasena" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <button type="button" class="absolute inset-y-0 right-0 top-6 flex items-center px-3 text-gray-500" onclick="togglePasswordVisibility('contrasena', this)">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                </button>
                            </div>
                            <div><label for="pin" class="block text-sm font-medium text-gray-600 mb-2">PIN</label><input type="text" id="pin" name="pin" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                            <div class="md:col-span-1 xl:col-span-2"><label for="notas" class="block text-sm font-medium text-gray-600 mb-2">Notas Adicionales</label><input type="text" id="notas" name="notas" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                            <div class="md:col-span-2 lg:col-span-3 xl:col-span-4 text-right self-end"><button type="submit" class="bg-indigo-600 w-full md:w-auto text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition-transform transform hover:scale-105">Guardar Venta</button></div>
                        </form>
                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-lg mb-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="relative flex-grow w-full md:col-span-1"><input type="text" id="search-input" placeholder="Buscar por cliente, plataforma o correo..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"><svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div>
                            <div>
                                <select id="account-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="">Filtrar por cuenta...</option>
                                </select>
                            </div>
                            <div>
                                <select id="status-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                    <option value="">Filtrar por estado...</option>
                                    <option value="Activo">Activo</option>
                                    <option value="Próximo a Vencer">Próximo a Vencer</option>
                                    <option value="Vence hoy">Vence hoy</option>
                                    <option value="Vencido">Vencido</option>
                                </select>
                            </div>
                        </div>
                        <div id="platform-filters" class="flex flex-wrap justify-center gap-3 sm:gap-4"></div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-4">
                        <div class="hidden md:grid grid-cols-7 gap-4 font-semibold text-gray-600 border-b pb-3 mb-3 text-sm">
                            <div class="col-span-2">Cliente</div>
                            <div>Plataforma</div>
                            <div>Vencimiento</div>
                            <div>Estado</div>
                            <div>Precio</div>
                            <div class="text-right">Acciones</div>
                        </div>
                        <div id="sales-list" class="space-y-2"></div>
                    </div>
                    <div id="loading-state" class="text-center py-10"><p class="text-gray-500">Cargando ventas...</p></div>
                    <div id="empty-state" class="hidden text-center py-20 bg-white rounded-2xl shadow-lg"><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg><h3 class="mt-2 text-xl font-medium text-gray-900">No hay ventas registradas</h3><p class="mt-1 text-sm text-gray-500">Comienza añadiendo una nueva venta.</p></div>
                </div>

                <!-- Finanzas View -->
                <div id="finanzas-view" class="view hidden">
                     <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl md:text-2xl font-semibold text-gray-700 mb-6">Resumen Financiero</h2>
                        <div class="space-y-4 mb-6">
                            <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg"><span class="font-medium text-green-800">Ingresos Totales:</span><span id="total-ingresos" class="font-bold text-lg md:text-xl text-green-900">S/0.00</span></div>
                            <div class="flex justify-between items-center p-4 bg-red-50 rounded-lg"><span class="font-medium text-red-800">Egresos Totales:</span><span id="total-egresos" class="font-bold text-lg md:text-xl text-red-900">S/0.00</span></div>
                            <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg border-t-2 border-blue-200"><span class="font-medium text-blue-800">Balance General:</span><span id="balance-total" class="font-bold text-xl md:text-2xl text-blue-900">S/0.00</span></div>
                        </div>
                        <div class="border-t pt-6 mt-6">
                            <h3 class="text-lg md:text-xl font-semibold text-gray-700 mb-4">Añadir Egreso</h3>
                            <form id="add-expense-form" class="space-y-4">
                                <div><label for="expense-description" class="block text-sm font-medium text-gray-600 mb-2">Descripción</label><input type="text" id="expense-description" name="expense-description" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Ej: Pago de internet" required></div>
                                <div><label for="expense-amount" class="block text-sm font-medium text-gray-600 mb-2">Monto (S/)</label><input type="number" id="expense-amount" name="expense-amount" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Ej: 50.00" required></div>
                                <div><label for="expense-date" class="block text-sm font-medium text-gray-600 mb-2">Fecha</label><input type="date" id="expense-date" name="expense-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                                <button type="submit" class="w-full bg-red-500 text-white font-semibold py-2 rounded-lg hover:bg-red-600 transition">Añadir Gasto</button>
                            </form>
                        </div>
                        <div id="expenses-list-container" class="border-t pt-6 mt-6">
                            <h3 class="text-lg md:text-xl font-semibold text-gray-700 mb-4">Últimos Egresos</h3>
                            <div id="expenses-list" class="space-y-2 max-h-48 overflow-y-auto"><p class="text-sm text-gray-400">No hay egresos registrados.</p></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 text-center">
            <h2 id="confirmation-title" class="text-2xl font-bold text-gray-800 mb-4">Confirmar Acción</h2>
            <p id="confirmation-message" class="text-gray-600 mb-8">¿Estás seguro de que quieres continuar?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-confirmation-btn" class="bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-300 transition w-full md:w-auto">
                    Cancelar
                </button>
                <button id="confirm-action-btn" class="bg-red-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-red-700 transition w-full md:w-auto">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-4xl rounded-2xl shadow-2xl p-6 transform scale-95">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-semibold text-gray-700">Editar Venta</h2><button id="close-modal" class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div>
            <form id="edit-sale-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <input type="hidden" id="edit-sale-id" name="edit-sale-id">
                <div><label for="edit-cliente" class="block text-sm font-medium text-gray-600 mb-2">Nombre del Cliente</label><input type="text" id="edit-cliente" name="edit-cliente" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                <div><label for="edit-plataforma" class="block text-sm font-medium text-gray-600 mb-2">Plataforma</label><select id="edit-plataforma" name="edit-plataforma" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option>Netflix</option><option>Spotify</option><option>Disney+</option><option>HBO Max</option><option>Amazon Prime Video</option><option>YouTube Premium</option><option>Apple Music</option><option>Apple TV+</option><option>Crunchyroll</option><option>Canva</option><option>IPTV Premium</option><option>Vix+</option><option>Paramount+</option><option>Otro</option></select></div>
                <div id="edit-otro-plataforma-container" class="hidden"><label for="edit-otro-plataforma" class="block text-sm font-medium text-gray-600 mb-2">Especificar Plataforma</label><input type="text" id="edit-otro-plataforma" name="edit-otro-plataforma" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                <div><label for="edit-precio" class="block text-sm font-medium text-gray-600 mb-2">Precio Pagado (S/)</label><input type="number" id="edit-precio" name="edit-precio" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                <div><label for="edit-inicioPlan" class="block text-sm font-medium text-gray-600 mb-2">Inicio del Plan</label><input type="date" id="edit-inicioPlan" name="edit-inicioPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                <div>
                    <label for="edit-finPlan" class="block text-sm font-medium text-gray-600 mb-2">Fin del Plan</label>
                    <input type="date" id="edit-finPlan" name="edit-finPlan" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" required>
                </div>
                <div>
                    <label for="edit-platform-account" class="block text-sm font-medium text-gray-600 mb-2">Cuenta de Plataforma</label>
                    <select id="edit-platform-account" name="edit-platform-account" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                        <option value="">Sin cuenta / Ingresar manualmente</option>
                    </select>
                </div>
                <div class="edit-manual-credentials">
                    <label for="edit-correo" class="block text-sm font-medium text-gray-600 mb-2">Correo</label>
                    <input type="email" id="edit-correo" name="edit-correo" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <div class="edit-manual-credentials relative">
                    <label for="edit-contrasena" class="block text-sm font-medium text-gray-600 mb-2">Contraseña</label>
                    <input type="password" id="edit-contrasena" name="edit-contrasena" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <button type="button" class="absolute inset-y-0 right-0 top-6 flex items-center px-3 text-gray-500" onclick="togglePasswordVisibility('edit-contrasena', this)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    </button>
                </div>
                <div><label for="edit-pin" class="block text-sm font-medium text-gray-600 mb-2">PIN</label><input type="text" id="edit-pin" name="edit-pin" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                <div class="lg:col-span-2 md:col-span-2"><label for="edit-notas" class="block text-sm font-medium text-gray-600 mb-2">Notas Adicionales</label><input type="text" id="edit-notas" name="edit-notas" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                <div class="lg:col-span-3 md:col-span-2 flex justify-end gap-4 mt-4"><button type="button" id="cancel-edit" class="bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-300 transition">Cancelar</button><button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700">Guardar Cambios</button></div>
            </form>
        </div>
    </div>

    <!-- Edit Mother Account Modal -->
    <div id="edit-mother-account-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 transform scale-95">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">Editar Cuenta Madre</h2>
                <button id="close-edit-mother-account-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <form id="edit-mother-account-form">
                <input type="hidden" id="edit-mother-account-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-mother-account-email" class="block text-sm font-medium text-gray-600 mb-2">Correo</label>
                        <input type="email" id="edit-mother-account-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="edit-mother-account-password" class="block text-sm font-medium text-gray-600 mb-2">Contraseña</label>
                        <input type="password" id="edit-mother-account-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="edit-mother-account-payment-date" class="block text-sm font-medium text-gray-600 mb-2">Fecha de Pago Propia</label>
                        <input type="date" id="edit-mother-account-payment-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-edit-mother-account-btn" class="bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    <div id="archive-delete-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-lg rounded-2xl shadow-2xl p-8 transform scale-95 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">¿Qué deseas hacer con esta venta?</h2>
            <p class="text-gray-600 mb-8">Elige una opción según si la venta se concretó o fue un error.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Archivar</h3>
                    <p class="text-sm text-gray-500 mb-6">La venta fue real y el dinero se recibió, pero la suscripción ya terminó. La venta desaparecerá de la lista principal pero se contará en el resumen financiero.</p>
                    <button id="archive-btn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition">
                        Archivar Venta
                    </button>
                </div>

                <div class="border border-red-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                    <h3 class="text-xl font-semibold text-red-700 mb-2">Eliminar Permanentemente</h3>
                    <p class="text-sm text-gray-500 mb-6">Solo si registraste esta venta por error y nunca recibiste el dinero. Se borrará para siempre y no se contará en el resumen financiero.</p>
                    <button id="delete-permanently-btn" class="w-full bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700 transition">
                        Eliminar Permanentemente
                    </button>
                </div>
            </div>

            <div class="mt-8">
                <button id="cancel-action-btn" class="text-gray-500 hover:text-gray-700 font-medium">Cancelar</button>
            </div>
        </div>
    </div>
    <div id="renewal-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">Renovar Suscripción</h2>
            <form id="renewal-form">
                <input type="hidden" id="renewal-sale-id">
                <div class="space-y-4">
                    <div>
                        <label for="renewal-days" class="block text-sm font-medium text-gray-600 mb-2">Días a renovar</label>
                        <input type="number" id="renewal-days" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="renewal-amount" class="block text-sm font-medium text-gray-600 mb-2">Monto de renovación (S/)</label>
                        <input type="number" id="renewal-amount" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-renewal-btn" class="bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-green-700 transition">Confirmar Renovación</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function togglePasswordVisibility(inputId, button) { const input = document.getElementById(inputId), icon = button.querySelector('svg'); if (input.type === "password") { input.type = "text"; icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .946-3.11 3.563-5.522 6.837-6.141M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.581 10.41A7.48 7.48 0 0119.542 12c-1.274 4.057-5.064 7-9.542 7a10.046 10.046 0 01-3.132-.475M2.458 12c.946-3.11 3.563-5.522 6.837-6.141m1.581 2.318A4.5 4.5 0 0115 12a4.5 4.5 0 01-1.07 2.828M5 5l14 14" />`; } else { input.type = "password"; icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />`; } }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { firebaseConfig } from './firebase-config.js';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('logout-btn').addEventListener('click', () => { signOut(auth).catch((error) => console.error("Error al cerrar sesión", error)); });

                dayjs.extend(dayjs_plugin_relativeTime);
                dayjs.locale('es');
                const platformStyles = { 'Netflix':{color:'text-red-600',fallback:'bg-red-500'},'Spotify':{color:'text-green-500',fallback:'bg-green-500'},'Disney+':{color:'text-blue-900',fallback:'bg-blue-900'},'HBO Max':{color:'text-purple-600',fallback:'bg-purple-600'},'Amazon Prime Video':{color:'text-blue-400',fallback:'bg-blue-400'},'YouTube Premium':{color:'text-red-500',fallback:'bg-red-500'},'Apple Music':{color:'text-pink-500',fallback:'bg-pink-500'},'Apple TV+':{color:'text-gray-800',fallback:'bg-gray-800'},'Crunchyroll':{color:'text-orange-500',fallback:'bg-orange-500'},'Canva':{color:'text-purple-500',fallback:'bg-purple-500'},'IPTV Premium':{color:'text-teal-500',fallback:'bg-teal-500'},'Vix+':{color:'text-yellow-400',fallback:'bg-yellow-400'},'Paramount+':{color:'text-blue-800',fallback:'bg-blue-800'},'Otro':{color:'text-gray-500',fallback:'bg-gray-500'}};
                let allSales = [], allExpenses = [], allMotherAccounts = [], activePlatformFilter = 'Todos', currentSearchTerm = '', activeAccountFilter = '', activeStatusFilter = '';
                const selectors = {
                    addSaleForm: document.getElementById('add-sale-form'),
                    salesList: document.getElementById('sales-list'),
                    searchInput: document.getElementById('search-input'),
                    loadingState: document.getElementById('loading-state'),
                    emptyState: document.getElementById('empty-state'),
                    editModal: document.getElementById('edit-modal'),
                    editForm: document.getElementById('edit-sale-form'),
                    closeModalBtn: document.getElementById('close-modal'),
                    cancelEditBtn: document.getElementById('cancel-edit'),
                    plataformaSelect: document.getElementById('plataforma'),
                    otroPlataformaContainer: document.getElementById('otro-plataforma-container'),
                    otroPlataformaInput: document.getElementById('otro-plataforma'),
                    editPlataformaSelect: document.getElementById('edit-plataforma'),
                    editOtroPlataformaContainer: document.getElementById('edit-otro-plataforma-container'),
                    editOtroPlataformaInput: document.getElementById('edit-otro-plataforma'),
                    platformFilters: document.getElementById('platform-filters'),
                    totalIngresos: document.getElementById('total-ingresos'),
                    totalEgresos: document.getElementById('total-egresos'),
                    balanceTotal: document.getElementById('balance-total'),
                    addExpenseForm: document.getElementById('add-expense-form'),
                    expensesList: document.getElementById('expenses-list'),
                    addMotherAccountForm: document.getElementById('add-mother-account-form'),
                    motherAccountsList: document.getElementById('mother-accounts-list'),
                    platformAccountSelect: document.getElementById('platform-account'),
                    editPlatformAccountSelect: document.getElementById('edit-platform-account'),
                    accountFilter: document.getElementById('account-filter'),
                    statusFilter: document.getElementById('status-filter'),
                    motherAccountPlatformButtons: document.getElementById('mother-account-platform-buttons'),
                    kpiSalesToday: document.getElementById('kpi-sales-today'),
                    kpiSalesMonth: document.getElementById('kpi-sales-month'),
                    kpiActiveClients: document.getElementById('kpi-active-clients'),
                    alertsSection: document.getElementById('alerts-section'),
                    summaryIngresos: document.getElementById('summary-ingresos'),
                    summaryEgresos: document.getElementById('summary-egresos'),
                    summaryBalance: document.getElementById('summary-balance'),
                };
                const getSaleStatus = (finPlan) => { const today = dayjs().startOf('day'); const expirationDate = dayjs(finPlan).startOf('day'); const diffDays = expirationDate.diff(today, 'day'); if (diffDays < 0) return 'Vencido'; if (diffDays === 0) return 'Vence hoy'; if (diffDays <= 7) return 'Próximo a Vencer'; return 'Activo'; };
                const formatCurrency = (amount) => `S/${(amount||0).toFixed(2)}`;
                const getPlatformHtml = (platformName) => { const style=platformStyles[platformName]||platformStyles['Otro']; return `<span class="font-bold ${style.color}">${platformName}</span>`};
                const handlePlatformChange = (select, container, input) => { if (select.value==='Otro') { container.classList.remove('hidden'); input.required = true; } else { container.classList.add('hidden'); input.required = false; input.value = ''; }};
                const openModal = () => { selectors.editModal.classList.remove('hidden'); setTimeout(() => { selectors.editModal.classList.remove('opacity-0'); selectors.editModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10); };
                const closeModal = () => { selectors.editModal.classList.add('opacity-0'); selectors.editModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => selectors.editModal.classList.add('hidden'), 300); };

                const showConfirmationModal = (title, message, onConfirm) => {
                    const modal = document.getElementById('confirmation-modal');
                    document.getElementById('confirmation-title').textContent = title;
                    document.getElementById('confirmation-message').textContent = message;
                    const confirmBtn = document.getElementById('confirm-action-btn');
                    const cancelBtn = document.getElementById('cancel-confirmation-btn');
                    const confirmHandler = () => { onConfirm(); hideConfirmationModal(); };
                    const cancelHandler = () => { hideConfirmationModal(); };
                    confirmBtn.onclick = confirmHandler;
                    cancelBtn.onclick = cancelHandler;
                    modal.classList.remove('hidden');
                    setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
                };

                const hideConfirmationModal = () => {
                    const modal = document.getElementById('confirmation-modal');
                    modal.classList.add('opacity-0');
                    modal.querySelector('.modal-content').classList.add('scale-95');
                    setTimeout(() => { modal.classList.add('hidden'); document.getElementById('confirm-action-btn').onclick = null; document.getElementById('cancel-confirmation-btn').onclick = null; }, 300);
                };

                const showArchiveDeleteModal = (saleId) => {
                    const modal = document.getElementById('archive-delete-modal');
                    const archiveBtn = document.getElementById('archive-btn');
                    const deleteBtn = document.getElementById('delete-permanently-btn');
                    const cancelBtn = document.getElementById('cancel-action-btn');
                    const archiveHandler = () => handleArchiveAction(saleId);
                    const deleteHandler = () => handlePermanentDeleteAction(saleId);
                    const cancelHandler = () => hideArchiveDeleteModal();
                    archiveBtn.onclick = archiveHandler;
                    deleteBtn.onclick = deleteHandler;
                    cancelBtn.onclick = cancelHandler;
                    modal.classList.remove('hidden');
                    setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
                };

                const hideArchiveDeleteModal = () => {
                    const modal = document.getElementById('archive-delete-modal');
                    modal.classList.add('opacity-0');
                    modal.querySelector('.modal-content').classList.add('scale-95');
                    setTimeout(() => { modal.classList.add('hidden'); document.getElementById('archive-btn').onclick = null; document.getElementById('delete-permanently-btn').onclick = null; document.getElementById('cancel-action-btn').onclick = null; }, 300);
                };
                const updateFinancialSummary = () => { const salesIncome = allSales.reduce((sum, sale) => sum + (sale.precio || 0), 0); const totalIngresos = salesIncome; const totalEgresos = allExpenses.reduce((sum, expense) => sum + (expense.amount || 0), 0); const balance = totalIngresos - totalEgresos; selectors.totalIngresos.textContent = formatCurrency(totalIngresos); selectors.totalEgresos.textContent = formatCurrency(totalEgresos); selectors.balanceTotal.textContent = formatCurrency(balance); selectors.balanceTotal.classList.toggle('text-red-900', balance < 0); selectors.balanceTotal.classList.toggle('text-blue-900', balance >= 0); };

                const loadDashboardData = () => {
                    const today = dayjs().startOf('day');
                    const startOfMonth = dayjs().startOf('month');
                    const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');
                    const salesToday = allSales.filter(sale => dayjs(sale.inicioPlan).isSame(today, 'day')).reduce((sum, sale) => sum + sale.precio, 0);
                    selectors.kpiSalesToday.textContent = formatCurrency(salesToday);
                    const salesMonth = allSales.filter(sale => dayjs(sale.inicioPlan).isAfter(startOfMonth) || dayjs(sale.inicioPlan).isSame(startOfMonth)).reduce((sum, sale) => sum + sale.precio, 0);
                    selectors.kpiSalesMonth.textContent = formatCurrency(salesMonth);
                    const activeClients = activeSales.length;
                    selectors.kpiActiveClients.textContent = activeClients;
                    const upcomingExpirations = activeSales.filter(sale => { const expirationDate = dayjs(sale.finPlan).startOf('day'); const diffDays = expirationDate.diff(today, 'day'); return diffDays >= 0 && diffDays <= 5; }).sort((a, b) => new Date(a.finPlan) - new Date(b.finPlan));
                    selectors.alertsSection.innerHTML = '';
                    if (upcomingExpirations.length > 0) {
                        upcomingExpirations.forEach(sale => {
                            const alertEl = document.createElement('div');
                            alertEl.className = 'flex justify-between items-center p-3 bg-yellow-50 rounded-lg';
                            alertEl.innerHTML = `<div><p class="font-semibold text-yellow-800">${sale.cliente}</p><p class="text-sm text-yellow-600">${getPlatformHtml(sale.plataforma)}</p></div><div class="text-right"><p class="font-bold text-sm text-yellow-900">Vence en ${dayjs(sale.finPlan).fromNow(true)}</p><p class="text-xs text-yellow-700">${dayjs(sale.finPlan).format('DD MMM')}</p></div>`;
                            selectors.alertsSection.appendChild(alertEl);
                        });
                    } else {
                        selectors.alertsSection.innerHTML = '<p class="text-gray-500">No hay vencimientos próximos.</p>';
                    }
                    const totalIngresos = allSales.reduce((sum, sale) => sum + (sale.precio || 0), 0);
                    const totalEgresos = allExpenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
                    const balance = totalIngresos - totalEgresos;
                    selectors.summaryIngresos.textContent = formatCurrency(totalIngresos);
                    selectors.summaryEgresos.textContent = formatCurrency(totalEgresos);
                    selectors.summaryBalance.textContent = formatCurrency(balance);
                    selectors.summaryBalance.classList.toggle('text-red-900', balance < 0);
                    selectors.summaryBalance.classList.toggle('text-blue-900', balance >= 0);
                };

                const applyFiltersAndRender = (salesToRender) => {
                    let filteredSales = [...salesToRender];
                    if (activePlatformFilter !== 'Todos') { filteredSales = filteredSales.filter(sale => sale.plataforma === activePlatformFilter); }
                    if (currentSearchTerm) { const term = currentSearchTerm.toLowerCase(); filteredSales = filteredSales.filter(sale => sale.cliente.toLowerCase().includes(term) || sale.plataforma.toLowerCase().includes(term) || (sale.correo && sale.correo.toLowerCase().includes(term))); }
                    if (activeAccountFilter) { const account = allMotherAccounts.find(a => a.id === activeAccountFilter); if (account) { filteredSales = filteredSales.filter(sale => sale.correo === account.email && sale.contrasena === account.password); } }
                    if (activeStatusFilter) { filteredSales = filteredSales.filter(sale => getSaleStatus(sale.finPlan) === activeStatusFilter); }
                    renderSales(filteredSales);
                };
                const renderPlatformFilters = () => {
                    selectors.platformFilters.innerHTML = '';
                    const platforms = ['Todos', ...Object.keys(platformStyles)];
                    platforms.forEach(platform => {
                        const btn = document.createElement('button');
                        btn.dataset.platform = platform;
                        const activeClasses = 'border-indigo-500 bg-indigo-50';
                        const inactiveClasses = 'border-transparent hover:bg-gray-100';
                        btn.className = `p-2 rounded-lg border-2 transition-all duration-200 font-semibold ${activePlatformFilter === platform ? activeClasses : inactiveClasses}`;
                        if (platform === 'Todos') { btn.textContent = 'Todos'; } else { btn.innerHTML = getPlatformHtml(platform); }
                        btn.addEventListener('click', () => {
                            activePlatformFilter = platform;
                            document.querySelectorAll('#platform-filters button').forEach(b => { b.className = `p-2 rounded-lg border-2 transition-all duration-200 font-semibold ${inactiveClasses}`; });
                            btn.className = `p-2 rounded-lg border-2 transition-all duration-200 font-semibold ${activeClasses}`;
                            const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');
                            applyFiltersAndRender(activeSales);
                        });
                        selectors.platformFilters.appendChild(btn);
                    });
                };
                const renderMotherAccountPlatformButtons = () => {
                    const platformNames = Object.keys(platformStyles).filter(p => p !== 'Otro');
                    selectors.motherAccountPlatformButtons.innerHTML = '';
                    platformNames.forEach(name => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.textContent = name;
                        btn.dataset.platformName = name;
                        btn.className = 'px-3 py-1.5 border border-gray-300 rounded-md text-sm font-medium hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500';
                        btn.addEventListener('click', () => {
                            selectors.addMotherAccountForm['mother-account-platform'].value = name;
                            document.querySelectorAll('#mother-account-platform-buttons button').forEach(b => b.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600'));
                            btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                        });
                        selectors.motherAccountPlatformButtons.appendChild(btn);
                    });
                };

                const renderSales = (sales) => {
                    selectors.salesList.innerHTML = '';
                    const parentContainer = selectors.salesList.closest('.bg-white');
                    if (allSales.filter(s => s.estado !== 'ARCHIVADO').length === 0) { selectors.emptyState.classList.remove('hidden'); parentContainer.classList.add('hidden'); return; }
                    selectors.emptyState.classList.add('hidden');
                    parentContainer.classList.remove('hidden');
                    if (sales.length === 0) { selectors.salesList.innerHTML = `<p class="text-gray-500 text-center col-span-7 py-4">No se encontraron ventas que coincidan.</p>`; return; }
                    sales.forEach(sale => {
                        const statusText = getSaleStatus(sale.finPlan);
                        const statusInfo = { 'Vencido': { color: 'orange' }, 'Vence hoy': { color: 'red' }, 'Próximo a Vencer': { color: 'yellow' }, 'Activo': { color: 'green' } }[statusText];
                        const endDateForDisplay = dayjs(sale.finPlan);
                        const endDateForRelative = dayjs(sale.finPlan).endOf('day');
                        const row = document.createElement('div');
                        row.className = `grid grid-cols-2 md:grid-cols-7 gap-4 items-center p-3 rounded-lg hover:bg-gray-50 transition-colors duration-200 border-b text-sm`;
                        row.innerHTML = `<div class="col-span-2 font-semibold text-gray-800">${sale.cliente}<div class="font-normal text-xs text-gray-500 md:hidden mt-1">${getPlatformHtml(sale.plataforma)} &middot; Vence: ${endDateForDisplay.format('DD/MM/YYYY')}</div></div><div class="hidden md:block">${getPlatformHtml(sale.plataforma)}</div><div class="hidden md:block">${endDateForDisplay.format('DD/MM/YYYY')} <span class="text-xs text-gray-500">(${endDateForRelative.fromNow()})</span></div><div class="hidden md:block"><span class="text-xs font-semibold py-1 px-2 uppercase rounded-full text-${statusInfo.color}-600 bg-${statusInfo.color}-100">${statusText}</span></div><div class="hidden md:block font-bold text-gray-800">${formatCurrency(sale.precio)}</div><div class="flex justify-end gap-3 items-center"><button class="edit-btn p-1 text-indigo-600 hover:text-indigo-800 hover:bg-indigo-100 rounded-full transition" data-id="${sale.id}" title="Editar"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button><button class="renew-btn p-1 text-green-600 hover:text-green-800 hover:bg-green-100 rounded-full transition" data-id="${sale.id}" title="Renovar"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5"></path></svg></button><button class="delete-btn p-1 text-red-600 hover:text-red-800 hover:bg-red-100 rounded-full transition" data-id="${sale.id}" title="Eliminar"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div><div class="md:hidden col-span-2 mt-2 pt-2 border-t flex justify-between items-center text-xs"><span class="font-semibold py-1 px-2 uppercase rounded-full text-${statusInfo.color}-600 bg-${statusInfo.color}-100">${statusText}</span><span class="font-bold text-gray-800 text-base">${formatCurrency(sale.precio)}</span></div>`;
                        selectors.salesList.appendChild(row);
                    });
                    selectors.salesList.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', e => handleEdit(e.currentTarget.dataset.id)));
                    selectors.salesList.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', e => handleDeleteSale(e.currentTarget.dataset.id)));
                    selectors.salesList.querySelectorAll('.renew-btn').forEach(b => b.addEventListener('click', e => openRenewalModal(e.currentTarget.dataset.id)));
                };
                const renderExpenses = () => { selectors.expensesList.innerHTML = ''; if (allExpenses.length === 0) { selectors.expensesList.innerHTML = '<p class="text-sm text-gray-400">No hay egresos registrados.</p>'; return; } allExpenses.forEach(expense => { const item = document.createElement('div'); item.className = 'flex justify-between items-center text-sm p-2 rounded-md hover:bg-gray-50'; item.innerHTML = `<div class="flex-1 truncate pr-2"><p class="text-gray-700">${expense.description}</p><p class="text-xs text-gray-500">${dayjs(expense.date).format('DD/MM/YYYY')}</p></div><div class="flex items-center gap-2"><span class="font-semibold text-red-600">${formatCurrency(expense.amount)}</span><button class="delete-expense-btn text-gray-400 hover:text-red-600" data-id="${expense.id}"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button></div>`; selectors.expensesList.appendChild(item); }); selectors.expensesList.querySelectorAll('.delete-expense-btn').forEach(b => b.addEventListener('click', e => handleDeleteExpense(e.currentTarget.dataset.id))); };

                const renderMotherAccounts = () => {
                    selectors.motherAccountsList.innerHTML = '';
                    if (allMotherAccounts.length === 0) { selectors.motherAccountsList.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">No hay cuentas madre registradas.</p>'; return; }
                    allMotherAccounts.forEach(account => {
                        const accountEl = document.createElement('div');
                        accountEl.className = 'border rounded-lg overflow-hidden mb-2';
                        accountEl.dataset.accountId = account.id;
                        accountEl.innerHTML = `
                            <div class="mother-account-header flex items-center justify-between p-3 bg-gray-50 cursor-pointer hover:bg-gray-100" data-id="${account.id}">
                                <div class="flex items-center gap-3 flex-grow">
                                    <svg class="accordion-icon w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                    <span class="font-bold text-indigo-600">${account.platform}</span>
                                    <span class="text-gray-700">${account.email}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-500 hidden md:inline">${account.fecha_pago_propia ? 'Pago: ' + dayjs(account.fecha_pago_propia).format('DD/MM/YY') : ''}</span>
                                    <div class="relative">
                                        <button class="menu-btn p-1 text-gray-500 hover:text-gray-700 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500" data-id="${account.id}">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>
                                        </button>
                                        <div class="menu-dropdown hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border">
                                            <a href="#" class="add-profile-menu-btn block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Añadir Perfil</a>
                                            <a href="#" class="edit-mother-account-menu-btn block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Editar Cuenta</a>
                                            <a href="#" class="delete-mother-account-menu-btn block px-4 py-2 text-sm text-red-600 hover:bg-red-50">Eliminar Cuenta</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="profiles-container hidden p-4 bg-white border-t"></div>`;
                        selectors.motherAccountsList.appendChild(accountEl);
                    });
                };
                const loadProfilesForAccount = async (motherAccountId) => {
                    const container = document.querySelector(`[data-account-id="${motherAccountId}"] .profiles-container`);
                    if (!container) return;
                    container.innerHTML = '<p class="text-center text-gray-500">Cargando perfiles...</p>';
                    const profilesRef = collection(db, "CuentasMadre", motherAccountId, "Perfiles");
                    onSnapshot(profilesRef, (snapshot) => {
                        const profiles = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        renderProfiles(motherAccountId, profiles, container);
                    }, error => {
                        console.error("Error loading profiles:", error);
                        container.innerHTML = '<p class="text-center text-red-500">Error al cargar perfiles.</p>';
                    });
                };
                const renderProfiles = (motherAccountId, profiles, container) => {
                    const statusColors = { 'Disponible': 'green', 'Ocupado': 'red', 'Mantenimiento': 'orange' };
                    container.innerHTML = `
                        <div class="mb-4">
                            <button class="add-profile-btn bg-green-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-600 transition text-sm" data-mother-id="${motherAccountId}">+ Añadir Nuevo Perfil</button>
                        </div>
                        <div class="profile-form-container mb-4"></div>
                        <div class="profiles-list space-y-2">
                            ${profiles.length > 0 ? profiles.map(p => `
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-center p-2 rounded-md hover:bg-gray-50" data-profile-id="${p.id}">
                                    <div class="font-semibold text-gray-800">${p.nombre_perfil}</div>
                                    <div class="text-gray-600">${p.pin}</div>
                                    <div><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${statusColors[p.estado]}-100 text-${statusColors[p.estado]}-800"><svg class="w-2 h-2 mr-1.5 text-${statusColors[p.estado]}-500" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3" /></svg>${p.estado}</span></div>
                                    <div class="flex justify-end gap-2">
                                        <button class="edit-profile-btn p-1 text-indigo-600 hover:text-indigo-800" data-mother-id="${motherAccountId}" data-profile-id="${p.id}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg></button>
                                        <button class="delete-profile-btn p-1 text-red-600 hover:text-red-800" data-mother-id="${motherAccountId}" data-profile-id="${p.id}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-sm text-gray-500">Aún no hay perfiles. ¡Añade el primero!</p>'}
                        </div>`;
                };
                 const getProfileFormHTML = (motherId, profile = {}) => {
                    const isEditing = !!profile.id;
                    return `
                        <form class="profile-form bg-gray-50 p-4 rounded-lg border" data-mother-id="${motherId}" ${isEditing ? `data-profile-id="${profile.id}"` : ''}>
                            <h4 class="text-lg font-bold mb-3">${isEditing ? 'Editar Perfil' : 'Añadir Perfil'}</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Nombre Perfil</label><input type="text" name="nombre_perfil" value="${profile.nombre_perfil || ''}" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">PIN</label><input type="text" name="pin" value="${profile.pin || ''}" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Estado</label><select name="estado" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm"><option value="Disponible" ${profile.estado === 'Disponible' ? 'selected' : ''}>Disponible</option><option value="Ocupado" ${profile.estado === 'Ocupado' ? 'selected' : ''}>Ocupado</option><option value="Mantenimiento" ${profile.estado === 'Mantenimiento' ? 'selected' : ''}>Mantenimiento</option></select></div>
                            </div>
                            <div class="flex justify-end gap-2 mt-4">
                                <button type="button" class="cancel-profile-form-btn px-3 py-1.5 border border-gray-300 rounded-md text-sm font-medium hover:bg-gray-100">Cancelar</button>
                                <button type="submit" class="px-3 py-1.5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ${isEditing ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-green-600 hover:bg-green-700'}">${isEditing ? 'Guardar Cambios' : 'Añadir Perfil'}</button>
                            </div>
                        </form>
                    `;
                };
                const handleAddProfile = async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const motherId = form.dataset.motherId;
                    const newProfile = {
                        nombre_perfil: form.nombre_perfil.value,
                        pin: form.pin.value,
                        estado: form.estado.value,
                        fecha_vencimiento_cliente: null
                    };
                    try {
                        await addDoc(collection(db, "CuentasMadre", motherId, "Perfiles"), newProfile);
                        form.parentElement.innerHTML = '';
                    } catch (error) { console.error("Error adding profile:", error); }
                };
                const handleUpdateProfile = async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const motherId = form.dataset.motherId;
                    const profileId = form.dataset.profileId;
                    const updatedData = {
                        nombre_perfil: form.nombre_perfil.value,
                        pin: form.pin.value,
                        estado: form.estado.value
                    };
                    try {
                        await updateDoc(doc(db, "CuentasMadre", motherId, "Perfiles", profileId), updatedData);
                        form.parentElement.innerHTML = '';
                    } catch (error) { console.error("Error updating profile:", error); }
                };
                const handleDeleteProfile = (motherId, profileId) => {
                    showConfirmationModal(
                        'Eliminar Perfil',
                        '¿Estás seguro de que quieres eliminar este perfil?',
                        () => deleteDoc(doc(db, "CuentasMadre", motherId, "Perfiles", profileId)).catch(e => console.error(e))
                    );
                };

                const populatePlatformAccountsDropdowns = (platform = null) => {
                    let accountsToDisplay = allMotherAccounts;
                    if (platform && platform !== 'Otro') { accountsToDisplay = allMotherAccounts.filter(acc => acc.platform === platform); }
                    const createOption = (account) => `<option value="${account.id}">${account.platform} - ${account.email}</option>`;
                    const options = accountsToDisplay.map(createOption).join('');
                    selectors.platformAccountSelect.innerHTML = `<option value="">Sin cuenta / Ingresar manualmente</option>${options}`;
                    const allOptions = allMotherAccounts.map(createOption).join('');
                    selectors.editPlatformAccountSelect.innerHTML = `<option value="">Sin cuenta / Ingresar manualmente</option>${allOptions}`;
                    selectors.accountFilter.innerHTML = `<option value="">Filtrar por cuenta...</option>${allOptions}`;
                };

                const handlePlatformAccountChange = (select, emailInput, passwordInput, credentialsContainer) => {
                    const accountId = select.value;
                    const account = allMotherAccounts.find(a => a.id === accountId);
                    if (account) {
                        emailInput.value = account.email;
                        passwordInput.value = account.password;
                        credentialsContainer.forEach(el => el.classList.add('hidden'));
                    } else {
                        emailInput.value = '';
                        passwordInput.value = '';
                        credentialsContainer.forEach(el => el.classList.remove('hidden'));
                    }
                };
                const handleEdit = (id) => { const sale = allSales.find(s => s.id === id); if(!sale) return; const f = selectors.editForm; f['edit-sale-id'].value = sale.id; f['edit-cliente'].value = sale.cliente; f['edit-precio'].value = sale.precio; f['edit-inicioPlan'].value = sale.inicioPlan; f['edit-finPlan'].value = sale.finPlan; f['edit-correo'].value = sale.correo || ''; f['edit-contrasena'].value = sale.contrasena || ''; f['edit-pin'].value = sale.pin || ''; f['edit-notas'].value = sale.notas || ''; const standardPlatforms = Array.from(f['edit-plataforma'].options).map(o => o.value); if (standardPlatforms.includes(sale.plataforma)) { f['edit-plataforma'].value = sale.plataforma; } else { f['edit-plataforma'].value = 'Otro'; selectors.editOtroPlataformaInput.value = sale.plataforma; } handlePlatformChange(selectors.editPlataformaSelect, selectors.editOtroPlataformaContainer, selectors.editOtroPlataformaInput); openModal(); };
                const openRenewalModal = (saleId) => {
                    const sale = allSales.find(s => s.id === saleId); if (!sale) return;
                    const modal = document.getElementById('renewal-modal');
                    const form = document.getElementById('renewal-form');
                    form['renewal-sale-id'].value = sale.id; form['renewal-amount'].value = sale.precio.toFixed(2); form['renewal-days'].value = 30;
                    modal.classList.remove('hidden');
                    setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
                };

                const closeRenewalModal = () => {
                    const modal = document.getElementById('renewal-modal');
                    modal.classList.add('opacity-0');
                    modal.querySelector('.modal-content').classList.add('scale-95');
                    setTimeout(() => { modal.classList.add('hidden'); document.getElementById('renewal-form').reset(); }, 300);
                };

                const handleRenew = async (id) => {
                    const originalSale = allSales.find(s => s.id === id); if (!originalSale) { alert('Error: No se encontró la venta original.'); return; }
                    await updateDoc(doc(db, "sales", id), { estado: 'ARCHIVADO' });
                    const renewalDays = parseInt(document.getElementById('renewal-days').value, 10);
                    const renewalAmount = parseFloat(document.getElementById('renewal-amount').value);
                    if (isNaN(renewalDays) || isNaN(renewalAmount) || renewalDays <= 0) { alert('Por favor, ingresa un número de días y un monto válidos.'); return; }
                    const today = dayjs(); const currentEndDate = dayjs(originalSale.finPlan);
                    let newEndDate;
                    if (currentEndDate.isAfter(today)) { newEndDate = currentEndDate.add(renewalDays, 'day'); } else { newEndDate = today.add(renewalDays, 'day'); }
                    const newSale = { ...originalSale, precio: renewalAmount, inicioPlan: dayjs().format('YYYY-MM-DD'), finPlan: newEndDate.format('YYYY-MM-DD'), estado: 'ACTIVO', createdAt: new Date().toISOString() };
                    delete newSale.id;
                    try { await addDoc(collection(db, "sales"), newSale); closeRenewalModal(); } catch (error) { console.error("Error al crear la nueva venta de renovación:", error); await updateDoc(doc(db, "sales", id), { estado: 'ACTIVO' }); alert('Hubo un error al procesar la renovación.'); }
                };
                const handlePermanentDeleteAction = async (id) => { try { await deleteDoc(doc(db, "sales", id)); hideArchiveDeleteModal(); } catch (e) { console.error("Error deleting sale: ", e); alert('Error al eliminar la venta.'); hideArchiveDeleteModal(); } };
                const handleArchiveAction = async (id) => { try { await updateDoc(doc(db, "sales", id), { estado: 'ARCHIVADO' }); hideArchiveDeleteModal(); } catch (e) { console.error("Error archiving sale: ", e); alert('Error al archivar la venta.'); hideArchiveDeleteModal(); } };
                const handleDeleteSale = (id) => showArchiveDeleteModal(id);
                const handleDeleteExpense = (id) => { showConfirmationModal('Eliminar Gasto', '¿Estás seguro de que quieres eliminar este gasto? Esta acción no se puede deshacer.', () => { deleteDoc(doc(db, "expenses", id)).catch(e => console.error(e)); }); };
                const handleDeleteMotherAccount = (id) => {
                    showConfirmationModal('Eliminar Cuenta Madre', '¿Seguro? Se eliminarán también todos sus perfiles. Esta acción es irreversible.', async () => {
                        const profilesRef = collection(db, "CuentasMadre", id, "Perfiles");
                        const profilesSnapshot = await getDocs(profilesRef);
                        const batch = writeBatch(db);
                        profilesSnapshot.forEach(doc => batch.delete(doc.ref));
                        batch.delete(doc(db, "CuentasMadre", id));
                        await batch.commit().catch(e => console.error(e));
                    });
                };

                onSnapshot(collection(db, "sales"), (snapshot) => {
                    allSales = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO');
                    activeSales.sort((a, b) => new Date(a.finPlan) - new Date(b.finPlan));
                    selectors.loadingState.classList.add('hidden');
                    if (activeSales.length === 0 && allSales.length > 0) { selectors.emptyState.classList.remove('hidden'); } else if(allSales.length > 0) { selectors.emptyState.classList.add('hidden'); }
                    renderPlatformFilters();
                    applyFiltersAndRender(activeSales);
                    updateFinancialSummary();
                    loadDashboardData();
                }, (e) => { console.error("Error al cargar ventas:", e); });

                onSnapshot(collection(db, "expenses"), (snapshot) => { allExpenses = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); allExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)); renderExpenses(); updateFinancialSummary(); loadDashboardData(); }, (e) => { console.error("Error al cargar egresos:", e); });
                onSnapshot(collection(db, "CuentasMadre"), (snapshot) => { allMotherAccounts = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); renderMotherAccounts(); populatePlatformAccountsDropdowns(); }, (e) => { console.error("Error al cargar cuentas madre:", e); });

                selectors.addSaleForm.addEventListener('submit', async (e) => { e.preventDefault(); const f = selectors.addSaleForm; const newSale = { cliente: f.cliente.value, plataforma: f.plataforma.value === 'Otro' ? selectors.otroPlataformaInput.value : f.plataforma.value, precio: parseFloat(f.precio.value), inicioPlan: f.inicioPlan.value, finPlan: f.finPlan.value, correo: f.correo.value, contrasena: f.contrasena.value, pin: f.pin.value, notas: f.notas.value, createdAt: new Date().toISOString(), estado: 'ACTIVO' }; try { await addDoc(collection(db, "sales"), newSale); f.reset(); handlePlatformChange(selectors.plataformaSelect, selectors.otroPlataformaContainer, selectors.otroPlataformaInput); } catch (err) { console.error("Error al guardar venta:", err); alert("Error al guardar la venta.") } });
                selectors.editForm.addEventListener('submit', async (e) => { e.preventDefault(); const f = selectors.editForm; const id = f['edit-sale-id'].value; const updated = { cliente: f['edit-cliente'].value, plataforma: f['edit-plataforma'].value === 'Otro' ? selectors.editOtroPlataformaInput.value : f['edit-plataforma'].value, precio: parseFloat(f['edit-precio'].value), inicioPlan: f['edit-inicioPlan'].value, finPlan: f['edit-finPlan'].value, correo: f['edit-correo'].value, contrasena: f['edit-contrasena'].value, pin: f['edit-pin'].value, notas: f['edit-notas'].value, }; try { await updateDoc(doc(db, "sales", id), updated); closeModal(); } catch (err) { console.error("Error al actualizar la venta:", err); alert("Error al actualizar la venta.") } });
                selectors.addExpenseForm.addEventListener('submit', async (e) => { e.preventDefault(); const f = selectors.addExpenseForm; const description = f['expense-description'].value; const amount = parseFloat(f['expense-amount'].value); const date = f['expense-date'].value; if (!description || !date || isNaN(amount) || amount <= 0) return; try { await addDoc(collection(db, "expenses"), { description, amount, date }); f.reset(); f['expense-date'].value = dayjs().format('YYYY-MM-DD'); } catch (err) { console.error("Error al añadir egreso:", err); } });
                selectors.addMotherAccountForm.addEventListener('submit', async (e) => { e.preventDefault(); const f = selectors.addMotherAccountForm; const newAccount = { platform: f['mother-account-platform'].value, email: f['mother-account-email'].value, password: f['mother-account-password'].value, fecha_pago_propia: f['mother-account-payment-date'].value }; try { await addDoc(collection(db, "CuentasMadre"), newAccount); f.reset(); document.querySelectorAll('#mother-account-platform-buttons button').forEach(b => b.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600')); } catch (err) { console.error("Error al guardar cuenta madre:", err); } });

                selectors.searchInput.addEventListener('input', e => { currentSearchTerm = e.target.value; const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO'); applyFiltersAndRender(activeSales); });
                selectors.accountFilter.addEventListener('change', e => { activeAccountFilter = e.target.value; const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO'); applyFiltersAndRender(activeSales); });
                selectors.statusFilter.addEventListener('change', e => { activeStatusFilter = e.target.value; const activeSales = allSales.filter(sale => sale.estado !== 'ARCHIVADO'); applyFiltersAndRender(activeSales); });

                selectors.plataformaSelect.addEventListener('change', () => { handlePlatformChange(selectors.plataformaSelect, selectors.otroPlataformaContainer, selectors.otroPlataformaInput); populatePlatformAccountsDropdowns(selectors.plataformaSelect.value); });
                selectors.editPlataformaSelect.addEventListener('change', () => { handlePlatformChange(selectors.editPlataformaSelect, selectors.editOtroPlataformaContainer, selectors.editOtroPlataformaInput); });
                selectors.closeModalBtn.addEventListener('click', closeModal);
                selectors.cancelEditBtn.addEventListener('click', closeModal);
                document.getElementById('renewal-form').addEventListener('submit', (e) => { e.preventDefault(); const saleId = document.getElementById('renewal-sale-id').value; handleRenew(saleId); });
                document.getElementById('cancel-renewal-btn').addEventListener('click', closeRenewalModal);
                selectors.platformAccountSelect.addEventListener('change', () => handlePlatformAccountChange(selectors.platformAccountSelect, selectors.addSaleForm.correo, selectors.addSaleForm.contrasena, document.querySelectorAll('.manual-credentials')));
                selectors.editPlatformAccountSelect.addEventListener('change', () => handlePlatformAccountChange(selectors.editPlatformAccountSelect, selectors.editForm['edit-correo'], selectors.editForm['edit-contrasena'], document.querySelectorAll('.edit-manual-credentials')));

                const calculateEndDate = (startInput, daysInput, endInput) => { const days = parseInt(daysInput.value, 10); const startDate = startInput.value; if (!isNaN(days) && startDate) { endInput.value = dayjs(startDate).add(days, 'day').format('YYYY-MM-DD'); }};
                document.getElementById('diasPlan').addEventListener('input', () => calculateEndDate(document.getElementById('inicioPlan'), document.getElementById('diasPlan'), document.getElementById('finPlan')));
                document.getElementById('inicioPlan').addEventListener('change', () => calculateEndDate(document.getElementById('inicioPlan'), document.getElementById('diasPlan'), document.getElementById('finPlan')));

                document.getElementById('expense-date').value = dayjs().format('YYYY-MM-DD');

                document.getElementById('toggle-mother-accounts-section').addEventListener('click', (e) => {
                    const button = e.currentTarget;
                    const icon = button.querySelector('svg');
                    const content = document.getElementById('collapsible-mother-accounts-content');
                    const isHidden = content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180', !isHidden);
                });

                // EVENT LISTENERS DELEGATION
                selectors.motherAccountsList.addEventListener('click', async (e) => {
                    const header = e.target.closest('.mother-account-header');
                    const menuBtn = e.target.closest('.menu-btn');
                    const addProfileBtn = e.target.closest('.add-profile-btn');
                    const editProfileBtn = e.target.closest('.edit-profile-btn');
                    const deleteProfileBtn = e.target.closest('.delete-profile-btn');
                    const cancelFormBtn = e.target.closest('.cancel-profile-form-btn');
                    const addProfileMenuBtn = e.target.closest('.add-profile-menu-btn');
                    const editMotherAccountMenuBtn = e.target.closest('.edit-mother-account-menu-btn');
                    const deleteMotherAccountMenuBtn = e.target.closest('.delete-mother-account-menu-btn');

                    if (menuBtn) {
                        e.stopPropagation();
                        const dropdown = menuBtn.nextElementSibling;
                        document.querySelectorAll('.menu-dropdown').forEach(d => { if (d !== dropdown) d.classList.add('hidden'); });
                        dropdown.classList.toggle('hidden');
                        return;
                    }
                    if (header && !menuBtn) {
                        const container = header.parentElement.querySelector('.profiles-container');
                        const icon = header.querySelector('.accordion-icon');
                        if (container && icon) {
                            const isHidden = container.classList.toggle('hidden');
                            icon.classList.toggle('rotate-90', !isHidden);
                            if (!isHidden && container.dataset.loaded !== 'true') {
                                await loadProfilesForAccount(header.dataset.id);
                                container.dataset.loaded = 'true';
                            }
                        }
                    }
                     if (addProfileBtn || addProfileMenuBtn) {
                        const motherId = addProfileBtn?.dataset.motherId || e.target.closest('.relative').querySelector('.menu-btn').dataset.id;
                        const container = document.querySelector(`[data-account-id="${motherId}"]`);
                        const formContainer = container.querySelector('.profile-form-container');
                        formContainer.innerHTML = getProfileFormHTML(motherId);
                        formContainer.querySelector('form').addEventListener('submit', handleAddProfile);
                    }
                    if (editProfileBtn) {
                        const motherId = editProfileBtn.dataset.motherId;
                        const profileId = editProfileBtn.dataset.profileId;
                        const profilesRef = collection(db, "CuentasMadre", motherId, "Perfiles");
                        const profileDoc = await getDocs(profilesRef);
                        const profile = profileDoc.docs.find(d => d.id === profileId)?.data();
                         if (profile) {
                             profile.id = profileId;
                            const container = editProfileBtn.closest('.profiles-container');
                            const formContainer = container.querySelector('.profile-form-container');
                            formContainer.innerHTML = getProfileFormHTML(motherId, profile);
                            formContainer.querySelector('form').addEventListener('submit', handleUpdateProfile);
                         }
                    }
                    if (deleteProfileBtn) { handleDeleteProfile(deleteProfileBtn.dataset.motherId, deleteProfileBtn.dataset.profileId); }
                    if (cancelFormBtn) { cancelFormBtn.closest('form').parentElement.innerHTML = ''; }
                    if (deleteMotherAccountMenuBtn) { handleDeleteMotherAccount(e.target.closest('.relative').querySelector('.menu-btn').dataset.id); }
                    if (editMotherAccountMenuBtn) {
                        const motherId = e.target.closest('.relative').querySelector('.menu-btn').dataset.id;
                        openEditMotherAccountModal(motherId);
                    }
                });

                const openEditMotherAccountModal = (id) => {
                    const account = allMotherAccounts.find(acc => acc.id === id);
                    if (!account) return;
                    const modal = document.getElementById('edit-mother-account-modal');
                    const form = document.getElementById('edit-mother-account-form');
                    form['edit-mother-account-id'].value = id;
                    form['edit-mother-account-email'].value = account.email;
                    form['edit-mother-account-password'].value = account.password;
                    form['edit-mother-account-payment-date'].value = account.fecha_pago_propia;
                    modal.classList.remove('hidden', 'opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                };

                const closeEditMotherAccountModal = () => {
                    const modal = document.getElementById('edit-mother-account-modal');
                    modal.classList.add('opacity-0');
                    modal.querySelector('.modal-content').classList.add('scale-95');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                };

                document.getElementById('edit-mother-account-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form['edit-mother-account-id'].value;
                    const updatedData = {
                        email: form['edit-mother-account-email'].value,
                        password: form['edit-mother-account-password'].value,
                        fecha_pago_propia: form['edit-mother-account-payment-date'].value,
                    };
                    try {
                        await updateDoc(doc(db, "CuentasMadre", id), updatedData);
                        closeEditMotherAccountModal();
                    } catch (error) {
                        console.error("Error updating mother account:", error);
                    }
                });

                document.getElementById('close-edit-mother-account-modal-btn').addEventListener('click', closeEditMotherAccountModal);
                document.getElementById('cancel-edit-mother-account-btn').addEventListener('click', closeEditMotherAccountModal);

                document.addEventListener('click', (e) => { if (!e.target.closest('.menu-btn')) { document.querySelectorAll('.menu-dropdown').forEach(d => d.classList.add('hidden')); } });

                const navLinks = { 'nav-dashboard': 'Dashboard', 'nav-cuentas': 'Cuentas', 'nav-ventas': 'Ventas', 'nav-finanzas': 'Finanzas' };
                const views = document.querySelectorAll('.view');
                const mainHeader = document.getElementById('main-header');
                Object.keys(navLinks).forEach(navId => {
                    document.getElementById(navId)?.addEventListener('click', (e) => {
                        e.preventDefault();
                        const viewId = `${navLinks[navId].toLowerCase()}-view`;
                        views.forEach(view => { view.classList.toggle('hidden', view.id !== viewId); });
                        mainHeader.textContent = navLinks[navId];
                        document.querySelectorAll('nav a').forEach(link => link.classList.remove('bg-gray-700'));
                        e.currentTarget.classList.add('bg-gray-700');
                    });
                });
                document.getElementById('nav-dashboard').click();
                document.getElementById('quick-add-sale')?.addEventListener('click', () => document.getElementById('nav-ventas').click());
                document.getElementById('quick-add-expense')?.addEventListener('click', () => document.getElementById('nav-finanzas').click());

                const migrateData = async () => {
                    const migrateBtn = document.getElementById('migrate-data-btn');
                    migrateBtn.disabled = true; migrateBtn.textContent = 'Migrando...';
                    try {
                        const oldAccountsRef = collection(db, "platformAccounts");
                        const newAccountsRef = collection(db, "CuentasMadre");
                        const snapshot = await getDocs(oldAccountsRef);
                        if (snapshot.empty) { alert("No hay datos antiguos que migrar."); migrateBtn.textContent = 'Migración No Necesaria'; return; }
                        const promises = snapshot.docs.map(doc => addDoc(newAccountsRef, { ...doc.data(), fecha_pago_propia: "" }));
                        await Promise.all(promises);
                        alert(`¡Migración completada! Se migraron ${snapshot.size} cuentas.`);
                        migrateBtn.textContent = 'Migración Completada'; migrateBtn.classList.add('bg-gray-400');
                    } catch (error) { console.error("Error durante la migración:", error); alert("Ocurrió un error durante la migración."); migrateBtn.textContent = 'Error en Migración'; migrateBtn.disabled = false; }
                };
                document.getElementById('migrate-data-btn')?.addEventListener('click', migrateData);
                renderMotherAccountPlatformButtons();

            } else {
                window.location.href = 'login.html';
            }
        });

        // Toast notification logic
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('loggedin')) {
                const toast = document.createElement('div');
                toast.className = 'toast fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-x-full opacity-0';
                toast.textContent = 'Bienvenido a NineStreaming. Renzo y Charitsa';
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                    toast.classList.add('translate-x-0', 'opacity-100');
                }, 100);

                setTimeout(() => {
                    toast.classList.remove('translate-x-0', 'opacity-100');
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => {
                        toast.remove();
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 500);
                }, 5000);
            }
        });
    </script>
    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js');
    });
  }
</script>
</body>
</html>